<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Editor</title>
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f0f0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Menu Bar */
        .menu-bar {
            background-color: #2d2d2d;
            color: white;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 14px;
        }

        .menu-item {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .menu-item:hover {
            background-color: #404040;
        }

        /* Toolbar */
        .toolbar {
            background-color: #e0e0e0;
            border-bottom: 1px solid #ccc;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .toolbar-group {
            display: flex;
            gap: 4px;
            padding-right: 12px;
            border-right: 1px solid #ccc;
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-btn {
            background-color: #f8f8f8;
            border: 1px solid #ccc;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .toolbar-btn:hover {
            background-color: #e8e8e8;
            border-color: #999;
        }

        .toolbar-btn:active {
            background-color: #d0d0d0;
        }

        .toolbar-btn.active {
            background-color: #007acc;
            color: white;
            border-color: #005a9e;
        }

        /* Styles for Google Icons */
        .toolbar-btn .material-symbols-outlined {
            font-size: 18px; /* Consistent icon size */
        }
        
        .toolbar-btn.icon-only {
            padding: 6px;
            justify-content: center;
        }

        /* Font controls */
        .font-select, .font-size {
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 12px;
            background-color: white;
        }

        /* Hide the verbose version text in the update button; show only icon */
        #version-label {
            display: none;
        }

        /* Main container */
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Editor and preview panes */
        .editor-pane, .preview-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .pane-header {
            background-color: #f8f8f8;
            border-bottom: 1px solid #ddd;
            padding: 8px 16px;
            font-weight: bold;
            font-size: 12px;
            color: #666;
        }

        .editor-textarea {
            flex: 1;
            border: none;
            outline: none;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            background-color: white;
        }

        .preview-content {
            flex: 1;
            padding: 20px;
            background-color: white;
            overflow-y: auto;
            border-left: 1px solid #ddd;
        }

        /* Splitter */
        .splitter {
            width: 4px;
            background-color: #ddd;
            cursor: col-resize;
            position: relative;
        }

        .splitter:hover {
            background-color: #007acc;
        }

        /* Status bar */
        .status-bar {
            background-color: #007acc;
            color: white;
            padding: 4px 16px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Markdown preview styles */
        .preview-content h1, .preview-content h2, .preview-content h3,
        .preview-content h4, .preview-content h5, .preview-content h6 {
            margin-top: 20px;
            margin-bottom: 10px;
            line-height: 1.2;
        }

        .preview-content h1 { font-size: 2em; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .preview-content h2 { font-size: 1.5em; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .preview-content h3 { font-size: 1.3em; }
        .preview-content h4 { font-size: 1.1em; }
        .preview-content h5 { font-size: 1em; }
        .preview-content h6 { font-size: 0.9em; }

        .preview-content p {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .preview-content ul, .preview-content ol {
            margin-bottom: 15px;
            padding-left: 30px;
        }

        .preview-content li {
            margin-bottom: 5px;
        }

        .preview-content code {
            background-color: #f0f0f0;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .preview-content pre {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 15px;
            overflow-x: auto;
            margin-bottom: 15px;
        }

        .preview-content pre code {
            background-color: transparent;
            padding: 0;
        }

        .preview-content blockquote {
            border-left: 4px solid #ddd;
            padding-left: 20px;
            margin: 15px 0;
            color: #666;
            font-style: italic;
        }

        .preview-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 15px;
        }

        .preview-content th, .preview-content td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .preview-content th {
            background-color: #f0f0f0;
            font-weight: bold;
        }

        /* Hidden file input */
        .hidden-file-input {
            display: none;
        }

        /* View toggle */
        .view-toggle {
            display: flex;
            gap: 2px;
        }

        .view-toggle button {
            background-color: #f8f8f8;
            border: 1px solid #ccc;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
        }

        .view-toggle button.active {
            background-color: #007acc;
            color: white;
        }

        /* Single pane view */
        .single-pane .editor-pane,
        .single-pane .preview-pane {
            flex: 1;
        }

        .single-pane .splitter {
            display: none;
        }

        .editor-only .preview-pane,
        .preview-only .editor-pane {
            display: none;
        }
    </style>
</head>
<body>
    <div class="menu-bar">
        <div class="menu-item" onclick="showAbout()">File</div>
        <div class="menu-item" onclick="showEditMenu()">Edit</div>
        <div class="menu-item" onclick="showViewMenu()">View</div>
        <div class="menu-item" onclick="showHelp()">Help</div>
    </div>

    <div class="toolbar">
        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="newFile()" title="New File"><span class="material-symbols-outlined">note_add</span> New</button>
            <button class="toolbar-btn" onclick="openFile()" title="Open File"><span class="material-symbols-outlined">folder_open</span> Open</button>
            <button class="toolbar-btn" onclick="saveFile()" title="Save File"><span class="material-symbols-outlined">save</span> Save</button>
        </div>
        
        <div class="toolbar-group">
            <button class="toolbar-btn icon-only" onclick="undo()" title="Undo"><span class="material-symbols-outlined">undo</span></button>
            <button class="toolbar-btn icon-only" onclick="redo()" title="Redo"><span class="material-symbols-outlined">redo</span></button>
        </div>

        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="showFindReplace()" title="Find and Replace"><span class="material-symbols-outlined">find_replace</span> Find</button>
        </div>
        
        <div class="toolbar-group">
            <button class="toolbar-btn icon-only" onclick="insertMarkdown('**', '**')" title="Bold"><span class="material-symbols-outlined">format_bold</span></button>
            <button class="toolbar-btn icon-only" onclick="insertMarkdown('*', '*')" title="Italic"><span class="material-symbols-outlined">format_italic</span></button>
            <button class="toolbar-btn icon-only" onclick="insertMarkdown('~~', '~~')" title="Strikethrough"><span class="material-symbols-outlined">strikethrough_s</span></button>
            <button class="toolbar-btn icon-only" onclick="insertMarkdown('`', '`')" title="Code"><span class="material-symbols-outlined">code</span></button>
        </div>
        
        <div class="toolbar-group">
            <button class="toolbar-btn icon-only" onclick="insertHeading(1)" title="Heading 1"><span class="material-symbols-outlined">format_h1</span></button>
            <button class="toolbar-btn icon-only" onclick="insertHeading(2)" title="Heading 2"><span class="material-symbols-outlined">format_h2</span></button>
            <button class="toolbar-btn icon-only" onclick="insertHeading(3)" title="Heading 3"><span class="material-symbols-outlined">format_h3</span></button>
        </div>
        
        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="insertList('- ')" title="Bullet List"><span class="material-symbols-outlined">format_list_bulleted</span> List</button>
            <button class="toolbar-btn" onclick="insertList('1. ')" title="Numbered List"><span class="material-symbols-outlined">format_list_numbered</span> List</button>
            <button class="toolbar-btn" onclick="insertMarkdown('> ', '')" title="Quote"><span class="material-symbols-outlined">format_quote</span> Quote</button>
        </div>
        
        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="insertLink()" title="Insert Link"><span class="material-symbols-outlined">link</span> Link</button>
            <button class="toolbar-btn" onclick="insertImage()" title="Insert Image"><span class="material-symbols-outlined">image</span> Image</button>
            <button class="toolbar-btn" onclick="insertTable()" title="Insert Table"><span class="material-symbols-outlined">table_chart</span> Table</button>
        </div>
        
        <div class="toolbar-group">
            <div class="view-toggle">
                <button onclick="setViewMode('split')" class="active" id="split-btn">Split</button>
                <button onclick="setViewMode('editor')" id="editor-btn">Editor</button>
                <button onclick="setViewMode('preview')" id="preview-btn">Preview</button>
            </div>
        </div>
        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="toggleSecurity()" id="security-btn" title="Toggle XSS Protection">
                <span class="material-symbols-outlined">security</span>
                <span id="security-status">Security: On</span>
            </button>
        </div>
        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="checkForUpdates()" title="Check for Updates">
                <span class="material-symbols-outlined">system_update</span>
                <span id="version-label">v1.3.2</span>
            </button>
            <button class="toolbar-btn" onclick="runSmokeTests()" title="Run parser smoke tests">Tests</button>
        </div>
    </div>

    <div class="main-container" id="main-container">
        <div class="editor-pane" id="editor-pane">
            <div class="pane-header">Markdown Editor</div>
            <textarea class="editor-textarea" id="editor" placeholder="Start typing your markdown here...

# Welcome to Markdown Editor

This is a **bold** text and this is *italic* text.

## Features
- Real-time preview
- Syntax highlighting
- WordPad-like interface
- File operations

### Code Example
```javascript
function hello() {
    console.log('Hello, World!');
}
This is a blockquote.

Happy writing!"></textarea>
</div>
    <div class="splitter" id="splitter"></div>

    <div class="preview-pane" id="preview-pane">
        <div class="pane-header">Preview</div>
        <div class="preview-content" id="preview"></div>
    </div>
</div>

<div class="status-bar">
    <div id="status-left">Ready</div>
    <div id="status-right">
        <span id="word-count">Words: 0</span>
        <span style="margin-left: 20px;" id="char-count">Characters: 0</span>
        <span style="margin-left: 20px;" id="line-count">Lines: 1</span>
    </div>
</div>

<input type="file" id="file-input" class="hidden-file-input" accept=".md,.txt" />

<!-- Load markdown-it and DOMPurify from CDN for robust parsing and sanitization -->
<!-- Try loading local vendor copies first (./vendor/*.js). If not present, fall back to CDN. -->
<script src="vendor/markdown-it.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
<script src="vendor/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>

<!-- Highlight.js for code fence syntax highlighting (local first, then CDN) -->
<link rel="stylesheet" href="vendor/highlight.default.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/default.min.css" />
<script src="vendor/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/lib/common.min.js"></script>
<script>
    // Global variables for state management
    let editor = document.getElementById('editor');
    let preview = document.getElementById('preview');
    let currentFile = null;
    let undoStack = [];
    let redoStack = [];
    let currentViewMode = 'split';
    let securityEnabled = true; // XSS protection state
    const CURRENT_VERSION = '1.3.2';
    const GITHUB_REPO = 'ObjectPresents/lancer-notes';

    // Initialize the editor
    function initEditor() {
        // Set up event listeners
        editor.addEventListener('input', function() {
            updatePreview();
            updateStatusBar();
            saveToUndoStack();
        });

        editor.addEventListener('keydown', function(e) {
            handleKeyboardShortcuts(e);
        });

        // Set up file input listener
        document.getElementById('file-input').addEventListener('change', handleFileSelect);

        // Set up splitter functionality
        setupSplitter();

        // Initial preview update
        updatePreview();
        updateStatusBar();
    }

    // Enhanced security module
    const Security = {
        // DOMPurify-inspired sanitizer
        sanitize: function(html) {
            if (!securityEnabled) return html;
            
            const div = document.createElement('div');
            div.textContent = html;
            return div.innerHTML;
        },

        // Allowed HTML tags when security is disabled
        allowedTags: new Set([
            'p', 'div', 'span', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
            'ul', 'ol', 'li', 'blockquote', 'pre', 'code', 'em',
            'strong', 'del', 'a', 'img', 'br', 'table', 'thead',
            'tbody', 'tr', 'th', 'td'
        ]),

        // Safe HTML parser when security is disabled
        parseSafeHtml: function(html) {
            if (securityEnabled) return this.sanitize(html);
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            const sanitizeNode = (node) => {
                if (node.nodeType === 3) return node; // Text node is safe
                if (node.nodeType !== 1) return null; // Remove non-element nodes
                
                if (!this.allowedTags.has(node.tagName.toLowerCase())) {
                    return document.createTextNode(node.textContent);
                }
                
                // Clean attributes
                Array.from(node.attributes).forEach(attr => {
                    if (!this.isValidAttribute(attr.name, attr.value)) {
                        node.removeAttribute(attr.name);
                    }
                });
                
                // Recursively clean children
                Array.from(node.childNodes)
                    .forEach(child => {
                        const cleanChild = sanitizeNode(child);
                        if (cleanChild && child !== cleanChild) {
                            node.replaceChild(cleanChild, child);
                        }
                    });
                
                return node;
            };
            
            const clean = sanitizeNode(doc.body);
            return clean.innerHTML;
        },

        isValidAttribute: function(name, value) {
            const safeAttrs = new Set(['href', 'src', 'alt', 'title']);
            if (!safeAttrs.has(name)) return false;
            
            if (name === 'href' || name === 'src') {
                return this.isValidUrl(value);
            }
            
            return true;
        },

        isValidUrl: function(url) {
            try {
                const urlObj = new URL(url);
                return ['http:', 'https:', 'mailto:'].includes(urlObj.protocol);
            } catch {
                return false;
            }
        }
    };

    function toggleSecurity() {
        if (securityEnabled) {
            const confirmed = confirm(
                '⚠️ WARNING: Disabling XSS protection may expose you to security risks.\n\n' +
                'Only disable this if you trust the markdown content and need to render specific HTML.\n\n' +
                'Do you want to continue?'
            );
            if (!confirmed) return;
        }
        
        securityEnabled = !securityEnabled;
        const btn = document.getElementById('security-btn');
        const status = document.getElementById('security-status');
        
        if (securityEnabled) {
            btn.style.backgroundColor = '';
            status.textContent = 'Security: On';
        } else {
            btn.style.backgroundColor = '#ff6b6b';
            status.textContent = 'Security: Off';
        }
        
        updatePreview(); // Refresh preview with new security settings
    }

    // Alias for backward compatibility
    function escapeHtml(text) {
        return Security.sanitize(text);
    }

    // Alias for backward compatibility
    function isValidUrl(url) {
        return Security.isValidUrl(url);
    }

    // markdown-it instance (if available) will be used for parsing
    let md = null;
    function initMarkdownIt() {
        try {
            md = window.markdownit({
                html: true,
                linkify: true,
                typographer: true,
                highlight: function (str, lang) {
                    // If highlight.js is available, use it; otherwise fall back to escaped code
                    try {
                        if (window.hljs) {
                            if (lang && hljs.getLanguage && hljs.getLanguage(lang)) {
                                return '<pre class="hljs"><code>' + hljs.highlight(str, { language: lang }).value + '</code></pre>';
                            }
                            return '<pre class="hljs"><code>' + hljs.highlightAuto(str).value + '</code></pre>';
                        }
                    } catch (e) {
                        // ignore and fallback
                    }
                    return '<pre><code>' + escapeHtml(str) + '</code></pre>';
                }
            });
        } catch (e) {
            md = null;
            console.warn('markdown-it not available, using fallback parser');
        }
    }

    // Markdown parsing function - converts markdown to HTML with XSS protection
    function parseMarkdown(markdown) {
        let html = markdown
            // Headers
            .replace(/^### (.*$)/gm, (match, content) => `<h3>${Security.sanitize(content)}</h3>`)
            .replace(/^## (.*$)/gm, (match, content) => `<h2>${Security.sanitize(content)}</h2>`)
            .replace(/^# (.*$)/gm, (match, content) => `<h1>${Security.sanitize(content)}</h1>`)
            
            // Bold and italic - escape content
            .replace(/\*\*(.*?)\*\*/g, (match, content) => `<strong>${escapeHtml(content)}</strong>`)
            .replace(/\*(.*?)\*/g, (match, content) => `<em>${escapeHtml(content)}</em>`)
            .replace(/~~(.*?)~~/g, (match, content) => `<del>${escapeHtml(content)}</del>`)
            
            // Code blocks - escape content
            .replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => `<pre><code>${escapeHtml(code)}</code></pre>`)
            .replace(/`([^`]+)`/g, (match, content) => `<code>${escapeHtml(content)}</code>`)
            
            // Links - validate URLs and escape content
            .replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
                if (isValidUrl(url)) {
                    return `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(text)}</a>`;
                }
                return escapeHtml(match); // Return escaped original if URL is invalid
            })
            
            // Images - validate URLs and escape alt text
            .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, alt, url) => {
                if (isValidUrl(url)) {
                    return `<img src="${escapeHtml(url)}" alt="${escapeHtml(alt)}" />`;
                }
                return escapeHtml(match); // Return escaped original if URL is invalid
            })
            
            // Lists - escape content
            .replace(/^\s*\* (.+)$/gm, (match, content) => `<li>${escapeHtml(content)}</li>`)
            .replace(/^\s*- (.+)$/gm, (match, content) => `<li>${escapeHtml(content)}</li>`)
            .replace(/^\s*\d+\. (.+)$/gm, (match, content) => `<li>${escapeHtml(content)}</li>`)
            
            // Blockquotes - escape content
            .replace(/^> (.+)$/gm, (match, content) => `<blockquote>${escapeHtml(content)}</blockquote>`)
            
            // Line breaks
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>');

        // Wrap in paragraphs and fix lists
        html = '<p>' + html + '</p>';
        html = html.replace(/<\/p><p>(<li>.*?<\/li>)<\/p><p>/g, '<ul>$1</ul>');
        html = html.replace(/<\/li><br><li>/g, '</li><li>');
        
        // Fix empty paragraphs
        html = html.replace(/<p><\/p>/g, '');
        html = html.replace(/<p><br><\/p>/g, '');

        return html;
        
    }

    // Enhanced markdown rendering using markdown-it + DOMPurify when available
    function parseMarkdownWithTables(markdown) {
        // If markdown-it is available, use it for robust CommonMark parsing
        if (md) {
            const rendered = md.render(markdown);
            if (securityEnabled) {
                if (window.DOMPurify && typeof DOMPurify.sanitize === 'function') {
                    return DOMPurify.sanitize(rendered);
                }
                return Security.sanitize(rendered);
            }
            return rendered; // security disabled -> return raw rendered HTML
        }

        // Fallback: use the original (smaller) parser with escape protection
        const escapeMap = [];
        const protect = (mdText) => mdText.replace(/\\([`*_{}\[\]()#+\-.!>\|~\\])/g, (m, ch) => {
            const token = '::ESC' + escapeMap.length + '::';
            escapeMap.push(ch);
            return token;
        });
        const restore = (html) => html.replace(/::ESC(\d+)::/g, (m, idx) => {
            const ch = escapeMap[Number(idx)];
            return ch === undefined ? m : ch;
        });

        let html = protect(markdown);
        html = parseMarkdown(html);
        html = restore(html);

        if (securityEnabled) return Security.sanitize(html);
        return html;
    }
    // Update the preview pane with parsed markdown
    function updatePreview() {
        const markdownText = editor.value;
        const htmlContent = parseMarkdownWithTables(markdownText);
        preview.innerHTML = htmlContent;
    }

    // Update the status bar with current document stats
    function updateStatusBar() {
        const text = editor.value;
        const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;
        const charCount = text.length;
        const lineCount = text.split('\n').length;

        document.getElementById('word-count').textContent = `Words: ${wordCount}`;
        document.getElementById('char-count').textContent = `Characters: ${charCount}`;
        document.getElementById('line-count').textContent = `Lines: ${lineCount}`;
    }

    // Handle keyboard shortcuts
    function handleKeyboardShortcuts(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'n':
                    e.preventDefault();
                    newFile();
                    break;
                case 'o':
                    e.preventDefault();
                    openFile();
                    break;
                case 's':
                    e.preventDefault();
                    saveFile();
                    break;
                case 'z':
                    e.preventDefault();
                    if (e.shiftKey) {
                        redo();
                    } else {
                        undo();
                    }
                    break;
                case 'b':
                    e.preventDefault();
                    insertMarkdown('**', '**');
                    break;
                case 'i':
                    e.preventDefault();
                    insertMarkdown('*', '*');
                    break;
            }
        }
    }

    // File operations
    function newFile() {
        if (editor.value.trim() && !confirm('Are you sure you want to create a new file? Unsaved changes will be lost.')) {
            return;
        }
        editor.value = '';
        currentFile = null;
        updatePreview();
        updateStatusBar();
        updateStatus('New file created');
    }

    function openFile() {
        document.getElementById('file-input').click();
    }

    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                editor.value = event.target.result;
                currentFile = file.name;
                updatePreview();
                updateStatusBar();
                updateStatus(`Opened: ${file.name}`);
            };
            reader.readAsText(file);
        }
    }

    function saveFile() {
        const content = editor.value;
        const filename = currentFile || 'document.md';
        
        const blob = new Blob([content], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        updateStatus(`Saved: ${filename}`);
    }

    // Undo/Redo functionality
    function saveToUndoStack() {
        undoStack.push(editor.value);
        if (undoStack.length > 50) {
            undoStack.shift();
        }
        redoStack = [];
    }

    function undo() {
        if (undoStack.length > 1) {
            redoStack.push(undoStack.pop());
            editor.value = undoStack[undoStack.length - 1] || '';
            updatePreview();
            updateStatusBar();
        }
    }

    function redo() {
        if (redoStack.length > 0) {
            const redoValue = redoStack.pop();
            undoStack.push(redoValue);
            editor.value = redoValue;
            updatePreview();
            updateStatusBar();
        }
    }

    // Markdown insertion helpers
    function insertMarkdown(before, after) {
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        const selectedText = editor.value.substring(start, end);
        
        const newText = before + selectedText + after;
        editor.value = editor.value.substring(0, start) + newText + editor.value.substring(end);
        
        // Position cursor appropriately
        if (selectedText) {
            editor.selectionStart = start;
            editor.selectionEnd = start + newText.length;
        } else {
            editor.selectionStart = editor.selectionEnd = start + before.length;
        }
        
        editor.focus();
        updatePreview();
        updateStatusBar();
    }

    function insertHeading(level) {
        const start = editor.selectionStart;
        const lineStart = editor.value.lastIndexOf('\n', start - 1) + 1;
        const hashes = '#'.repeat(level) + ' ';
        
        editor.value = editor.value.substring(0, lineStart) + hashes + editor.value.substring(lineStart);
        editor.selectionStart = editor.selectionEnd = lineStart + hashes.length;
        editor.focus();
        updatePreview();
        updateStatusBar();
    }

    function insertList(prefix) {
        const start = editor.selectionStart;
        const lineStart = editor.value.lastIndexOf('\n', start - 1) + 1;
        
        editor.value = editor.value.substring(0, lineStart) + prefix + editor.value.substring(lineStart);
        editor.selectionStart = editor.selectionEnd = lineStart + prefix.length;
        editor.focus();
        updatePreview();
        updateStatusBar();
    }

    function insertLink() {
        const url = prompt('Enter URL:');
        if (url && isValidUrl(url)) {
            const text = prompt('Enter link text:') || url;
            // Sanitize user input
            const sanitizedText = escapeHtml(text);
            const sanitizedUrl = escapeHtml(url);
            insertMarkdown(`[${sanitizedText}](${sanitizedUrl})`, '');
            editor.selectionStart = editor.selectionEnd = editor.selectionStart + `[${sanitizedText}](${sanitizedUrl})`.length;
        } else if (url) {
            alert('Invalid URL. Please enter a valid HTTP, HTTPS, or mailto URL.');
        }
    }

    function insertImage() {
        const url = prompt('Enter image URL:');
        if (url && isValidUrl(url)) {
            const alt = prompt('Enter alt text:') || 'Image';
            // Sanitize user input
            const sanitizedAlt = escapeHtml(alt);
            const sanitizedUrl = escapeHtml(url);
            insertMarkdown(`![${sanitizedAlt}](${sanitizedUrl})`, '');
            editor.selectionStart = editor.selectionEnd = editor.selectionStart + `![${sanitizedAlt}](${sanitizedUrl})`.length;
        } else if (url) {
            alert('Invalid URL. Please enter a valid HTTP or HTTPS URL.');
        }
    }

    function insertTable() {
        const table = `\n| Header 1 | Header 2 | Header 3 |\n|----------|----------|----------|\n| Cell 1   | Cell 2   | Cell 3   |\n| Cell 4   | Cell 5   | Cell 6   |\n`;
        const start = editor.selectionStart;
        editor.value = editor.value.substring(0, start) + table + editor.value.substring(start);
        editor.selectionStart = editor.selectionEnd = start + table.length;
        editor.focus();
        updatePreview();
        updateStatusBar();
    }

    // View mode management
    function setViewMode(mode) {
        currentViewMode = mode;
        const container = document.getElementById('main-container');
        
        // Remove all view classes
        container.classList.remove('editor-only', 'preview-only', 'single-pane');
        
        // Update button states
        document.querySelectorAll('.view-toggle button').forEach(btn => btn.classList.remove('active'));
        
        switch(mode) {
            case 'editor':
                container.classList.add('editor-only', 'single-pane');
                document.getElementById('editor-btn').classList.add('active');
                break;
            case 'preview':
                container.classList.add('preview-only', 'single-pane');
                document.getElementById('preview-btn').classList.add('active');
                break;
            default:
                document.getElementById('split-btn').classList.add('active');
                break;
        }
    }

    // Splitter functionality for resizing panes
    function setupSplitter() {
        const splitter = document.getElementById('splitter');
        let isResizing = false;
        
        splitter.addEventListener('mousedown', function(e) {
            isResizing = true;
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
            e.preventDefault();
        });
        
        function handleMouseMove(e) {
            if (!isResizing) return;
            
            const container = document.getElementById('main-container');
            const containerRect = container.getBoundingClientRect();
            const percentage = ((e.clientX - containerRect.left) / containerRect.width) * 100;
            
            if (percentage > 20 && percentage < 80) {
                document.getElementById('editor-pane').style.flex = `0 1 ${percentage}%`;
                document.getElementById('preview-pane').style.flex = `1 1 ${100 - percentage}%`;
            }
        }
        
        function handleMouseUp() {
            isResizing = false;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        }
    }

    // Utility functions
    function updateStatus(message) {
        document.getElementById('status-left').textContent = message;
        setTimeout(() => {
            document.getElementById('status-left').textContent = 'Ready';
        }, 3000);
    }

    // Menu functions (placeholder implementations)
    function showAbout() {
        alert('Markdown Editor v1.3.2\nA WordPad-like markdown editor with real-time preview.\n\n⚠️ IMPORTANT NOTICE:\nv1.x series will be reaching end of support soon. Please prepare to migrate to v2.x for continued updates and support.\n\nChangelogs:\nv1.3.2: Major improvements\n- Replaced parser with markdown-it for better CommonMark support\n- Added syntax highlighting for code blocks (highlight.js)\n- Added local vendoring support (vendor-libs.ps1)\n- Added support for escaped characters (\\*)\nv1.3.1: Security update - Fixed Cross-Site Scripting (XSS) vulnerabilities\nv1.3: Final maintenance release - Added Find and Replace functionality\nv1.2: Fix table format not working\nv1.1: Changed to new icons');
    }

    function showEditMenu() {
        alert('Edit menu - Use Ctrl+Z/Ctrl+Y for undo/redo, or the toolbar buttons.');
    }

    function showViewMenu() {
        alert('View menu - Use the view toggle buttons to switch between Editor, Preview, and Split view.');
    }

    function showHelp() {
        alert('Help:\n• Use ** for bold text\n• Use * for italic text\n• Use # for headers\n• Use - or * for lists\n• Use [text](url) for links\n• Use ![alt](url) for images');
    }

    // Find and Replace functionality
    function showFindReplace() {
        const findText = prompt('Enter text to find:');
        if (findText) {
            const replaceText = prompt('Enter text to replace with (Cancel for find-only):');
            const content = editor.value;
            
            if (replaceText === null) {
                // Find only
                const position = content.indexOf(findText, editor.selectionEnd);
                if (position !== -1) {
                    editor.setSelectionRange(position, position + findText.length);
                    editor.focus();
                    updateStatus('Text found');
                } else {
                    updateStatus('Text not found');
                }
            } else {
                // Find and replace
                const newContent = content.replaceAll(findText, replaceText);
                if (content !== newContent) {
                    editor.value = newContent;
                    updatePreview();
                    updateStatusBar();
                    updateStatus('Text replaced');
                } else {
                    updateStatus('Text not found');
                }
            }
        }
    }

    // Update checker
    async function checkForUpdates() {
        try {
            const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/releases/latest`);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error('Failed to fetch updates');
            }

            const latestVersion = data.tag_name.replace('v', '');
            const currentParts = CURRENT_VERSION.split('.').map(Number);
            const latestParts = latestVersion.split('.').map(Number);

            // Compare versions
            let hasUpdate = false;
            for (let i = 0; i < 3; i++) {
                if (latestParts[i] > currentParts[i]) {
                    hasUpdate = true;
                    break;
                } else if (latestParts[i] < currentParts[i]) {
                    break;
                }
            }

            if (hasUpdate) {
                const shouldUpdate = confirm(
                    `A new version (${latestVersion}) is available!\n\n` +
                    `Current version: ${CURRENT_VERSION}\n` +
                    `What's new:\n${data.body}\n\n` +
                    'Would you like to visit the download page?'
                );
                
                if (shouldUpdate) {
                    window.open(data.html_url, '_blank');
                }
            }
        } catch (error) {
            console.error('Error checking for updates:', error);
        }
    }

    // Initialize the editor, set version label (hidden) and update button tooltip, then check for updates when page loads
    // Run small smoke tests from the UI
    function runSmokeTests() {
        const cases = [
            { name: 'escaped asterisk', input: '\\*not bold\\*' },
            { name: 'inline escaped backtick', input: 'This is `code` and \\`not code\\`' },
            { name: 'mixed formatting', input: '**bold** and \\*not italic\\*' },
            { name: 'table with escaped char', input: '| Col1 | Col2 |\n|---|---|\n| A\\* | B |' }
        ];

        let outRendered = '';
        let outRaw = '';
        cases.forEach(c => {
            try {
                const html = parseMarkdownWithTables(c.input);
                outRendered += `<h3>${c.name}</h3>` + html + '<hr/>';
                outRaw += `--- ${c.name} ---\n` + html + '\n\n';
            } catch (e) {
                outRendered += `<h3>${c.name}</h3><pre>Error: ${escapeHtml(String(e))}</pre><hr/>`;
                outRaw += `--- ${c.name} ---\nError: ${String(e)}\n\n`;
            }
        });

        const w = window.open('', '_blank');
        if (!w) {
            alert('Popup blocked. Results printed to console.');
            console.log(outRaw);
            updateStatus('Smoke tests: see console');
            return;
        }
        w.document.title = 'Parser smoke tests';
        w.document.body.innerHTML = '<h1>Parser smoke tests (rendered)</h1>' + outRendered + '<h1>Raw HTML</h1><pre>' + Security.sanitize(outRaw) + '</pre>';
        updateStatus('Smoke tests completed');
    }

    window.addEventListener('load', () => {
        initMarkdownIt();
        initEditor();
        // Populate version label safely (fallback to CURRENT_VERSION)
        try {
            const versionLabel = document.getElementById('version-label');
            const updateBtn = document.querySelector('button[onclick="checkForUpdates()"]');
            if (versionLabel) versionLabel.textContent = 'v' + CURRENT_VERSION;
            // Update the button's title to include version so users can hover the icon to see it
            if (updateBtn) {
                updateBtn.title = `Check for Updates — v${CURRENT_VERSION}`;
                updateBtn.setAttribute('aria-label', `Check for Updates, current version ${CURRENT_VERSION}`);
            }
        } catch (e) {
            console.warn('Could not set version label', e);
        }
        checkForUpdates();
    });
</script>
</body>
</html>
