<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Editor</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
    <link rel="stylesheet" href="markdown_editor.css" />
    <style>
      body.dark-mode #find-replace-bar {
        background: #181a1b !important;
        border-color: #444 !important;
        color: #e0e0e0 !important;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3) !important;
      }
      body.dark-mode #find-replace-bar input {
        background: #101214 !important;
        color: #e0e0e0 !important;
        border: 1px solid #444 !important;
      }
      body.dark-mode #find-replace-bar button {
        background: #23272a !important;
        color: #e0e0e0 !important;
        border: 1px solid #444 !important;
      }
      body.dark-mode #find-replace-bar button:hover {
        background: #2d3136 !important;
        border-color: #666 !important;
      }
      body.dark-mode #link-image-dialog {
        background: #181a1b !important;
        border-color: #444 !important;
        color: #e0e0e0 !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
      }
      body.dark-mode #link-image-dialog input {
        background: #101214 !important;
        color: #e0e0e0 !important;
        border: 1px solid #444 !important;
      }
      body.dark-mode #link-image-dialog button {
        background: #23272a !important;
        color: #e0e0e0 !important;
        border: 1px solid #444 !important;
        transition: all 0.2s !important;
      }
      body.dark-mode #link-image-dialog button:hover {
        background: #2d3136 !important;
        border-color: #666 !important;
      }
      body.dark-mode #custom-alert {
        background: #181a1b !important;
        border-color: #444 !important;
        color: #e0e0e0 !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
      }
      body.dark-mode #custom-alert button {
        background: #23272a !important;
        color: #e0e0e0 !important;
        border: 1px solid #444 !important;
        transition: all 0.2s !important;
      }
      body.dark-mode #custom-alert button:hover {
        background: #2d3136 !important;
        border-color: #666 !important;
      }
      body.dark-mode #popup-overlay {
        background: rgba(0,0,0,0.5) !important;
      }
      /* Mode Selection Dialog Styles */
      .mode-option:hover {
        border-color: #0078d4 !important;
        box-shadow: 0 4px 12px rgba(0,120,212,0.15);
        transform: translateY(-2px);
      }
      .mode-option.selected {
        border-color: #0078d4 !important;
        background: rgba(0,120,212,0.05) !important;
        box-shadow: 0 0 0 3px rgba(0,120,212,0.1);
      }
      body.dark-mode #mode-selection-dialog {
        background: #181a1b !important;
        border-color: #444 !important;
        color: #e0e0e0 !important;
      }
      body.dark-mode .mode-option {
        background: #23272a !important;
        border-color: #444 !important;
        color: #e0e0e0 !important;
      }
      body.dark-mode .mode-option:hover {
        border-color: #0078d4 !important;
      }
      body.dark-mode #mode-skip {
        color: #aaa !important;
      }
      .md-img-info-wrap {
        position: relative;
        display: inline-block;
        vertical-align: middle;
        max-width: 100%;
      }
      .md-img-info-wrap img {
        display: block;
        max-width: 100%;
        height: auto;
      }
      .md-img-info-badge {
        position: absolute;
        bottom: 6px;
        right: 6px;
        background: #007acc;
        color: #fff;
        font-size: 13px;
        font-family: 'Segoe UI', Arial, sans-serif;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 6px rgba(0,0,0,0.18);
        cursor: pointer;
        z-index: 2;
        border: 2px solid #fff;
        transition: background 0.2s;
      }
      .md-img-info-badge:hover {
        background: #005a9e;
      }
      .dark-mode .md-img-info-badge {
        background: #23272a;
        color: #e0e0e0;
        border: 2px solid #181a1b;
      }
      .dark-mode .md-img-info-badge:hover {
        background: #005a9e;
        color: #fff;
      }
    </style>
</head>
<body>
    <div class="menu-bar">
    <div class="menu-item" id="menu-file">File</div>
    <div class="menu-item" id="menu-edit">Edit</div>
    <div class="menu-item" id="menu-view">View</div>
    <div class="menu-item" id="menu-developer" style="display:none;">Developer</div>
    <div class="menu-item" id="menu-help">Help</div>
    </div>

    <div class="toolbar">
        <div class="toolbar-group" data-category="file">
            <button class="toolbar-btn" id="btn-new" title="New File"><span class="material-symbols-outlined">note_add</span> New</button>
            <button class="toolbar-btn" id="btn-open" title="Open File"><span class="material-symbols-outlined">folder_open</span> Open</button>
            <button class="toolbar-btn" id="btn-save" title="Save File"><span class="material-symbols-outlined">save</span> Save</button>
            <button class="toolbar-btn" id="btn-save-as" title="Save As"><span class="material-symbols-outlined">save_as</span> Save As</button>
            <button class="toolbar-btn" id="btn-print" title="Print"><span class="material-symbols-outlined">print</span> Print</button>
        </div>
        
        <div class="toolbar-group" data-category="edit">
            <button class="toolbar-btn icon-only" id="btn-undo" title="Undo"><span class="material-symbols-outlined">undo</span></button>
            <button class="toolbar-btn icon-only" id="btn-redo" title="Redo"><span class="material-symbols-outlined">redo</span></button>
        </div>
        
        <div class="toolbar-group" data-category="edit">
            <button class="toolbar-btn icon-only" id="btn-bold" title="Bold"><span class="material-symbols-outlined">format_bold</span></button>
            <button class="toolbar-btn icon-only" id="btn-italic" title="Italic"><span class="material-symbols-outlined">format_italic</span></button>
            <button class="toolbar-btn icon-only" id="btn-strike" title="Strikethrough"><span class="material-symbols-outlined">strikethrough_s</span></button>
            <button class="toolbar-btn icon-only" id="btn-code" title="Code"><span class="material-symbols-outlined">code</span></button>
            <button class="toolbar-btn" id="btn-hr" title="Horizontal Rule"><span class="material-symbols-outlined">horizontal_rule</span> HR</button>
            <div class="dropdown">
                <button class="toolbar-btn" id="btn-datetime" title="Insert Date/Time"><span class="material-symbols-outlined">event</span> Date/Time <span class="dropdown-arrow">▼</span></button>
                <div class="dropdown-menu" id="datetime-dropdown" style="display:none;min-width:240px;">
                    <div class="dropdown-item" data-format="YYYY-MM-DD">
                        <div class="datetime-option">
                            <div class="datetime-option-title">ISO Date</div>
                            <div class="datetime-option-preview" data-preview="YYYY-MM-DD">2025-11-02</div>
                        </div>
                    </div>
                    <div class="dropdown-item" data-format="MM/DD/YYYY">
                        <div class="datetime-option">
                            <div class="datetime-option-title">US Date</div>
                            <div class="datetime-option-preview" data-preview="MM/DD/YYYY">11/02/2025</div>
                        </div>
                    </div>
                    <div class="dropdown-item" data-format="DD/MM/YYYY">
                        <div class="datetime-option">
                            <div class="datetime-option-title">European Date</div>
                            <div class="datetime-option-preview" data-preview="DD/MM/YYYY">02/11/2025</div>
                        </div>
                    </div>
                    <div class="dropdown-item" data-format="MMMM D, YYYY">
                        <div class="datetime-option">
                            <div class="datetime-option-title">Long Date</div>
                            <div class="datetime-option-preview" data-preview="MMMM D, YYYY">November 2, 2025</div>
                        </div>
                    </div>
                    <div class="dropdown-item" data-format="MMM D, YYYY">
                        <div class="datetime-option">
                            <div class="datetime-option-title">Medium Date</div>
                            <div class="datetime-option-preview" data-preview="MMM D, YYYY">Nov 2, 2025</div>
                        </div>
                    </div>
                    <div class="dropdown-item" data-format="YYYY-MM-DD HH:mm">
                        <div class="datetime-option">
                            <div class="datetime-option-title">ISO DateTime (24h)</div>
                            <div class="datetime-option-preview" data-preview="YYYY-MM-DD HH:mm">2025-11-02 15:43</div>
                        </div>
                    </div>
                    <div class="dropdown-item" data-format="YYYY-MM-DD hh:mm A">
                        <div class="datetime-option">
                            <div class="datetime-option-title">ISO DateTime (12h)</div>
                            <div class="datetime-option-preview" data-preview="YYYY-MM-DD hh:mm A">2025-11-02 03:43 PM</div>
                        </div>
                    </div>
                    <div class="dropdown-item" data-format="HH:mm:ss">
                        <div class="datetime-option">
                            <div class="datetime-option-title">Time (24h)</div>
                            <div class="datetime-option-preview" data-preview="HH:mm:ss">15:43:00</div>
                        </div>
                    </div>
                    <div class="dropdown-item" data-format="hh:mm A">
                        <div class="datetime-option">
                            <div class="datetime-option-title">Time (12h)</div>
                            <div class="datetime-option-preview" data-preview="hh:mm A">03:43 PM</div>
                        </div>
                    </div>
                    <div class="dropdown-item" data-format="UNIX">
                        <div class="datetime-option">
                            <div class="datetime-option-title">Unix Timestamp</div>
                            <div class="datetime-option-preview" data-preview="UNIX">1730534580</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="toolbar-group" data-category="edit">
            <div class="dropdown">
                <button class="toolbar-btn" id="btn-heading" title="Insert Heading"><span id="heading-current-text">Heading</span> <span class="dropdown-arrow">▼</span></button>
                <div class="dropdown-menu" id="heading-dropdown" style="display:none;">
                    <div class="dropdown-item" data-level="1">
                        <div class="heading-option">
                            <div class="heading-text">
                                <div style="margin:0; color: #0078d4; font-size: 1.5em;">Heading 1</div>
                                <div class="heading-desc">Main title</div>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown-item" data-level="2">
                        <div class="heading-option">
                            <div class="heading-text">
                                <div style="margin:0; color: #0078d4; font-size: 1.3em; ">Heading 2</div>
                                <div class="heading-desc">Section header</div>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown-item" data-level="3">
                        <div class="heading-option">
                            <div class="heading-text">
                                <div style="margin:0; color: #0078d4; font-size: 1.1em; ">Heading 3</div>
                                <div class="heading-desc">Subsection</div>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown-item" data-level="4">
                        <div class="heading-option">
                            <div class="heading-text">
                                <div style="margin:0; color: #0078d4; font-size: 1em;">Heading 4</div>
                                <div class="heading-desc">Minor section</div>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown-item" data-level="5">
                        <div class="heading-option">
                            <div class="heading-text">
                                <div style="margin:0; color: #0078d4; font-size: 0.9em;;">Heading 5</div>
                                <div class="heading-desc">Small section</div>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown-item" data-level="6">
                        <div class="heading-option">
                            <div class="heading-text">
                                <div style="margin:0; color: #0078d4; font-size: 0.8em;">Heading 6</div>
                                <div class="heading-desc">Tiny section</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="toolbar-group" data-category="edit">
            <button class="toolbar-btn icon-only" id="btn-subscript" title="Subscript"><span class="material-symbols-outlined">subscript</span></button>
            <button class="toolbar-btn icon-only" id="btn-superscript" title="Superscript"><span class="material-symbols-outlined">superscript</span></button>
            <button class="toolbar-btn" id="btn-footnote" title="Insert Footnote"><span class="material-symbols-outlined">format_quote</span> Footnote</button>
        </div>
        
        <div class="toolbar-group" data-category="edit">
            <button class="toolbar-btn" id="btn-bullet-list" title="Bullet List"><span class="material-symbols-outlined">format_list_bulleted</span> List</button>
            <button class="toolbar-btn" id="btn-number-list" title="Numbered List"><span class="material-symbols-outlined">format_list_numbered</span> List</button>
            <button class="toolbar-btn" id="btn-quote" title="Quote"><span class="material-symbols-outlined">format_quote</span> Quote</button>
            <button class="toolbar-btn" id="btn-task" title="Task Item"><span class="material-symbols-outlined">checklist</span> Task</button>
        </div>
        
        <div class="toolbar-group" data-category="edit">
            <button class="toolbar-btn" id="btn-link" title="Insert Link"><span class="material-symbols-outlined">link</span> Link</button>
            <button class="toolbar-btn" id="btn-image" title="Insert Image"><span class="material-symbols-outlined">image</span> Image</button>
            <div class="table-dropdown" style="position:relative;">
                <button class="toolbar-btn" id="btn-table" title="Table Options"><span class="material-symbols-outlined">table_chart</span> Table Options</button>
                <div id="table-menu" class="table-menu" role="menu" aria-hidden="true" style="display:none;position:absolute;top:100%;left:0;padding:8px;z-index:1000;min-width:200px;font-size:12px;">
                    <!-- Current Features -->
                    <div class="menu-section">
                        <div class="menu-section-title">Insert Table</div>
                        <button class="table-menu-option" data-action="insert-3x3"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">table_chart</span>3×3 Table</button>
                        <button class="table-menu-option" data-action="insert-4x4"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">table_chart</span>4×4 Table</button>
                        <button class="table-menu-option" data-action="insert-5x5"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">table_chart</span>5×5 Table</button>
                        <button class="table-menu-option" data-action="insert-custom"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">add_box</span>Custom Size...</button>
                    </div>
                    
                    <div class="menu-divider"></div>
                    
                    <div class="menu-section">
                        <div class="menu-section-title">Alignment</div>
                        <button class="table-menu-option" data-action="align-left"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">format_align_left</span>Left Align</button>
                        <button class="table-menu-option" data-action="align-center"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">format_align_center</span>Center Align</button>
                        <button class="table-menu-option" data-action="align-right"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">format_align_right</span>Right Align</button>
                    </div>
                    
                    <div class="menu-divider"></div>
                    
                    <div class="menu-section">
                        <div class="menu-section-title">Table Operations</div>
                        <button class="table-menu-option" data-action="add-row"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">add</span>Add Row</button>
                        <button class="table-menu-option" data-action="add-column"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">add</span>Add Column</button>
                        <button class="table-menu-option" data-action="delete-row"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">remove</span>Delete Row</button>
                        <button class="table-menu-option" data-action="delete-column"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">remove</span>Delete Column</button>
                    </div>
                    
                    <div class="menu-divider"></div>
                    
                    <div class="menu-section">
                        <div class="menu-section-title">Formatting</div>
                        <button class="table-menu-option" data-action="toggle-borders"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">border_all</span>Toggle Borders</button>
                        <button class="table-menu-option" data-action="header-style"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">format_bold</span>Header Style</button>
                        <button class="table-menu-option" data-action="striped-rows"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">view_list</span>Striped Rows</button>
                    </div>
                    
                    <div class="menu-divider"></div>
                    
                    <div class="menu-section">
                        <div class="menu-section-title">Future Features</div>
                        <button class="table-menu-option disabled" data-action="sort-table"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">sort</span>Sort Table <span class="coming-soon">(Soon)</span></button>
                        <button class="table-menu-option disabled" data-action="filter-table"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">filter_list</span>Filter Table <span class="coming-soon">(Soon)</span></button>
                        <button class="table-menu-option disabled" data-action="export-csv"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">download</span>Export CSV <span class="coming-soon">(Soon)</span></button>
                        <button class="table-menu-option disabled" data-action="table-templates"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">content_copy</span>Templates <span class="coming-soon">(Soon)</span></button>
                        <button class="table-menu-option disabled" data-action="merge-cells"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">merge</span>Merge Cells <span class="coming-soon">(Soon)</span></button>
                        <button class="table-menu-option disabled" data-action="table-calculations"><span class="material-symbols-outlined" style="font-size:16px;margin-right:8px;">calculate</span>Calculations <span class="coming-soon">(Soon)</span></button>
                    </div>
                </div>
            </div>
            <button class="toolbar-btn" id="btn-deflist" title="Definition List"><span class="material-symbols-outlined">menu_book</span> Def List</button>
        </div>
<!-- View Mode Toggle -->
        <div class="toolbar-group" data-category="view">
            <div class="view-mode-container">
                <label class="view-mode-label">View Mode:</label>
                <div class="view-toggle-modern">
                    <button class="view-mode-btn toolbar-btn active" id="split-btn" title="Split View - Editor and Preview side by side (Ctrl+1)">
                        <span class="material-symbols-outlined">vertical_split</span>
                        <span class="view-mode-text">Split</span>
                    </button>
                    <button class="view-mode-btn toolbar-btn" id="editor-btn" title="Editor Only - Focus on writing (Ctrl+2)">
                        <span class="material-symbols-outlined">edit_note</span>
                        <span class="view-mode-text">Editor</span>
                    </button>
                    <button class="view-mode-btn toolbar-btn" id="preview-btn" title="Preview Only - See the result (Ctrl+3)">
                        <span class="material-symbols-outlined">visibility</span>
                        <span class="view-mode-text">Preview</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="toolbar-group" data-category="edit">
            <button class="toolbar-btn" id="btn-find" title="Find/Replace"><span class="material-symbols-outlined">find_replace</span> Find</button>
        </div>
        <div class="toolbar-group" data-category="help">
            <button class="toolbar-btn" id="btn-help-docs" title="Help & Documentation"><span class="material-symbols-outlined">help</span> Help</button>
            <button class="toolbar-btn" id="btn-about" title="About / Changelogs"><span class="material-symbols-outlined">info</span> About</button>
            <button class="toolbar-btn" id="btn-extensions" title="Manage Extensions (beta)"><span class="material-symbols-outlined">extension</span> Extensions <span class="beta-badge">beta</span></button>
            <button class="toolbar-btn icon-only" id="btn-settings" title="Settings"><span class="material-symbols-outlined">settings</span></button>
        </div>
        <div class="toolbar-group" data-category="view">
            <button class="toolbar-btn" id="btn-image-cap" title="Set image auto-resize max width"><span class="material-symbols-outlined">photo_size_select_large</span> Image Cap</button>
        </div>
        <div class="toolbar-group" data-category="view">
            <button class="toolbar-btn" id="btn-wordwrap" title="Toggle word wrap"><span class="material-symbols-outlined">wrap_text</span> Word Wrap</button>
        </div>
        <div class="toolbar-group" data-category="view">
            <button class="toolbar-btn" id="btn-theme" title="Theme Options"><span class="material-symbols-outlined">palette</span> Theme</button>
        </div>
        <div class="toolbar-group" data-category="view">
            <button class="toolbar-btn icon-only" id="btn-zoom-out" title="Zoom Out (Ctrl+-)"><span class="material-symbols-outlined">zoom_out</span></button>
            <button class="toolbar-btn icon-only" id="btn-zoom-in" title="Zoom In (Ctrl+=)"><span class="material-symbols-outlined">zoom_in</span></button>
            <button class="toolbar-btn icon-only" id="btn-zoom-reset" title="Reset Zoom (Ctrl+0)"><span class="material-symbols-outlined">fullscreen_exit</span></button>
        </div>
        <div class="toolbar-group" data-category="developer">
            <button class="toolbar-btn" id="dev-test-btn" title="Developer: Test Save/Open"><span class="material-symbols-outlined">bug_report</span> Dev Test</button>
            <button class="toolbar-btn" id="dev-parser-test-btn" title="Developer: Parser Test"><span class="material-symbols-outlined">code</span> Parser Test</button>
        </div>
    </div>

    <div class="main-container" id="main-container">
        <div class="editor-pane" id="editor-pane">
            <div class="pane-header">Markdown Editor</div>
            <textarea class="editor-textarea" id="editor" placeholder="Start typing your markdown here...

# Welcome to Markdown Editor

This is a **bold** text and this is *italic* text.

## Features
- Real-time preview
- Syntax highlighting
- WordPad-like interface
- File operations

### Code Example
```javascript
function hello() {
    console.log('Hello, World!');
}
This is a blockquote.

Happy writing!"></textarea>
</div>
    <div class="splitter" id="splitter"></div>

    <div class="preview-pane" id="preview-pane">
        <div class="pane-header">Preview (Editable)</div>
        <div class="preview-content" id="preview" contenteditable="true"></div>
    </div>
</div>

<div class="status-bar">
    <div id="status-left">
        <span id="status-message">Ready</span>
        <span id="cursor-position">Ln 1, Col 1</span>
        <span id="selection-info">No selection</span>
    </div>
    <div id="status-right">
        <span id="tabs-toggle" title="Toggle between tabs and spaces" style="cursor: pointer;">Tabs</span>
        <span style="position: relative;" id="formatting-selector" title="Select formatting options">
            <span id="formatting-display">Markdown</span>
            <span class="dropdown-arrow">▼</span>
            <div class="formatting-menu" id="formatting-menu" style="display:none;position:absolute;bottom:100%;right:0;margin-bottom:4px;">
                <div class="formatting-option" data-format="markdown">Markdown</div>
                <div class="formatting-option" data-format="html">HTML</div>
                <div class="formatting-option" data-format="plain">Plain Text</div>
                <div class="formatting-option" data-format="rich">Rich Text</div>
            </div>
        </span>
        <span style="margin-left: 20px;" id="word-count">Words: 0</span>
        <span style="margin-left: 20px;" id="char-count">Characters: 0</span>
        <span style="margin-left: 20px;" id="line-count">Lines: 1</span>
    </div>
</div>

<!-- Find/Replace Bar -->
<div id="find-replace-bar" class="draggable-dialog" style="display:none;position:fixed;top:10%;left:50%;transform:translateX(-50%);background:#fff;border:1px solid #ccc;z-index:130000;width:650px;box-shadow:0 4px 12px rgba(0,0,0,0.15);border-radius:8px;overflow:visible;">
    <div id="find-replace-header" class="dialog-header" style="background:rgba(0,120,212,0.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;cursor:move;border-radius:8px 8px 0 0;box-shadow:0 1px 0 rgba(255,255,255,0.2) inset;">
        <span style="font-weight:bold;">Find and Replace</span>
        <button id="find-close" title="Close" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;">&times;</button>
    </div>
    <div style="padding:16px;">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;">
        <input id="find-input" placeholder="Find" style="flex:1;padding:8px;font-size:13px;" />
        <input id="replace-input" placeholder="Replace" style="flex:1;padding:8px;font-size:13px;" />
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:12px;">
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                <label style="font-size:12px;"><input type="checkbox" id="case-sensitive" /> Case sensitive</label>
                <label style="font-size:12px;"><input type="checkbox" id="use-regex" /> Regex</label>
                <label style="font-size:12px;"><input type="checkbox" id="wrap-around" checked /> Wrap around</label>
                <div style="display:flex;align-items:center;gap:8px;">
                    <span style="font-size:12px;color:#666;">Flags:</span>
                <div class="flags-dropdown" style="position:relative;z-index:1001;">
                    <button id="flags-toggle" class="flags-toggle" aria-haspopup="true" aria-expanded="false" title="Toggle regex flags" style="padding:6px 12px;font-size:12px;border:1px solid #ccc;border-radius:4px;background:#fff;display:flex;align-items:center;gap:4px;min-width:80px;justify-content:center;cursor:pointer;">
                        <span class="material-symbols-outlined" style="font-size:14px;">settings</span>
                        <span>Flags</span>
                        <span class="material-symbols-outlined" style="font-size:14px;">expand_more</span>
                    </button>
                    <div id="flags-menu" class="flags-menu" role="menu" aria-hidden="true" style="display:none;position:absolute;right:0;top:40px;background:#fff;border:1px solid #ccc;padding:8px;border-radius:4px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:3000;min-width:180px;">
                        <div style="padding:4px 0;">
                            <label class="flag-option" style="display:flex;align-items:center;padding:8px 12px;border-radius:4px;cursor:pointer;transition:all 0.2s;">
                                <input type="checkbox" id="flag-m" data-flag="m" class="flag-checkbox" style="margin-right:8px;" />
                                <div>
                                    <div style="font-weight:500;font-size:12px;">m (multiline)</div>
                                    <div style="font-size:10px;color:#666;">Match across lines</div>
                                </div>
                            </label>
                            <label class="flag-option" style="display:flex;align-items:center;padding:8px 12px;border-radius:4px;cursor:pointer;transition:all 0.2s;">
                                <input type="checkbox" id="flag-s" data-flag="s" class="flag-checkbox" style="margin-right:8px;" />
                                <div>
                                    <div style="font-weight:500;font-size:12px;">s (dotAll)</div>
                                    <div style="font-size:10px;color:#666;">Dot matches newlines</div>
                                </div>
                            </label>
                            <label class="flag-option" style="display:flex;align-items:center;padding:8px 12px;border-radius:4px;cursor:pointer;transition:all 0.2s;">
                                <input type="checkbox" id="flag-u" data-flag="u" class="flag-checkbox" style="margin-right:8px;" />
                                <div>
                                    <div style="font-weight:500;font-size:12px;">u (unicode)</div>
                                    <div style="font-size:10px;color:#666;">Enable full Unicode support</div>
                                </div>
                            </label>
                            <label class="flag-option" style="display:flex;align-items:center;padding:8px 12px;border-radius:4px;cursor:pointer;transition:all 0.2s;">
                                <input type="checkbox" id="flag-y" data-flag="y" class="flag-checkbox" style="margin-right:8px;" />
                                <div>
                                    <div style="font-weight:500;font-size:12px;">y (sticky)</div>
                                    <div style="font-size:10px;color:#666;">Match from current position</div>
                                </div>
                            </label>
                            <label class="flag-option" style="display:flex;align-items:center;padding:8px 12px;border-radius:4px;cursor:pointer;transition:all 0.2s;">
                                <input type="checkbox" id="flag-d" data-flag="d" class="flag-checkbox" style="margin-right:8px;" />
                                <div>
                                    <div style="font-weight:500;font-size:12px;">d (indices)</div>
                                    <div style="font-size:10px;color:#666;">Capture match indices</div>
                                </div>
                            </label>
                        </div>
                    </div>

                        <!-- Predefined Patterns Dropdown -->
                        <div class="patterns-dropdown" style="position:relative;z-index:1001;">
                            <button id="patterns-toggle" class="flags-toggle" aria-haspopup="true" aria-expanded="false" title="Insert predefined regex pattern" style="padding:6px 12px;font-size:12px;border:1px solid #ccc;border-radius:4px;background:#fff;display:flex;align-items:center;gap:4px;min-width:110px;justify-content:center;cursor:pointer;">
                                <span class="material-symbols-outlined" style="font-size:14px;">auto_awesome</span>
                                <span>Patterns</span>
                                <span class="material-symbols-outlined" style="font-size:14px;">expand_more</span>
                            </button>
                            <div id="patterns-menu" class="flags-menu" role="menu" aria-hidden="true" style="display:none;position:absolute;right:0;top:40px;background:#fff;border:1px solid #ccc;padding:8px;border-radius:4px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:3000;min-width:220px;">
                                <div style="padding:4px 0;display:flex;flex-direction:column;gap:4px;">
                                    <button type="button" class="pattern-option" data-pattern="\d+" style="text-align:left;padding:8px 12px;font-size:12px;border:none;background:none;border-radius:4px;cursor:pointer;transition:background 0.2s;">Digits <span style="color:#666;">(\d+)</span></button>
                                    <button type="button" class="pattern-option" data-pattern="\w+" style="text-align:left;padding:8px 12px;font-size:12px;border:none;background:none;border-radius:4px;cursor:pointer;transition:background 0.2s;">Word characters <span style="color:#666;">(\w+)</span></button>
                                    <button type="button" class="pattern-option" data-pattern="\s+" style="text-align:left;padding:8px 12px;font-size:12px;border:none;background:none;border-radius:4px;cursor:pointer;transition:background 0.2s;">Whitespace <span style="color:#666;">(\s+)</span></button>
                                    <button type="button" class="pattern-option" data-pattern="\bhttps?:\/\/[^\s]+" style="text-align:left;padding:8px 12px;font-size:12px;border:none;background:none;border-radius:4px;cursor:pointer;transition:background 0.2s;">URL <span style="color:#666;">(http/https)</span></button>
                                    <button type="button" class="pattern-option" data-pattern="[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}" data-flags="i" style="text-align:left;padding:8px 12px;font-size:12px;border:none;background:none;border-radius:4px;cursor:pointer;transition:background 0.2s;">Email <span style="color:#666;">(case-insensitive)</span></button>
                                    <button type="button" class="pattern-option" data-pattern="^#{1,6}\s.+$" data-flags="m" style="text-align:left;padding:8px 12px;font-size:12px;border:none;background:none;border-radius:4px;cursor:pointer;transition:background 0.2s;">Markdown heading</button>
                                    <button type="button" class="pattern-option" data-pattern="<[^>]+>" style="text-align:left;padding:8px 12px;font-size:12px;border:none;background:none;border-radius:4px;cursor:pointer;transition:background 0.2s;">HTML tag</button>
                                </div>
                                <div style="border-top:1px solid #eee;margin-top:6px;padding-top:6px;">
                                    <button type="button" id="pattern-insert-clipboard" style="width:100%;padding:8px 12px;font-size:12px;border:none;background:#f5f5f5;border-radius:4px;cursor:pointer;">Paste from clipboard</button>
                                </div>
                            </div>
                        </div>

                        <!-- Dev/Test Modal for File System Access testing -->
                        <div id="dev-test-modal" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:420px;background:#fff;border:1px solid #ccc;z-index:140000;padding:16px;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,0.2);">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                <strong>Dev Save/Open Test</strong>
                                <button id="dev-test-close" style="background:none;border:none;font-size:18px;cursor:pointer;">&times;</button>
                            </div>
                            <div style="margin-bottom:10px;font-size:13px;color:#444;">File System Access API: <span id="fs-available">?</span></div>
                            <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px;">
                                <button id="dev-open-fs" style="padding:8px;border-radius:6px;cursor:pointer;">Open (FS Picker)</button>
                                <button id="dev-save-fs" style="padding:8px;border-radius:6px;cursor:pointer;">Save (to current handle)</button>
                                <button id="dev-save-fallback" style="padding:8px;border-radius:6px;cursor:pointer;">Save (fallback download)</button>
                            </div>
                            <div style="font-size:12px;color:#666;">Status: <span id="dev-test-status">Ready</span></div>
                        </div>
                </div>
            </div>
        </div>
        <div id="match-count" style="font-size:12px;font-weight:600;">0 / 0</div>
    </div>
    <div style="display:flex;gap:6px;justify-content:flex-end;margin-bottom:12px;">
        <button id="btn-find-prev" class="find-action-btn" title="Previous"><span class="material-symbols-outlined">keyboard_arrow_up</span></button>
        <button id="btn-find-next" class="find-action-btn" title="Next"><span class="material-symbols-outlined">keyboard_arrow_down</span></button>
        <button id="btn-replace" class="find-action-btn">Replace</button>
        <button id="btn-replace-all" class="find-action-btn">Replace All</button>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;">
        <div class="search-history-dropdown" style="position:relative;">
            <button id="search-history-toggle" class="search-history-toggle" type="button" aria-haspopup="true" aria-expanded="false">
                <span class="material-symbols-outlined search-history-icon">history</span>
                <span id="search-history-text">Recent searches</span>
                <span class="material-symbols-outlined search-history-arrow">expand_more</span>
            </button>
            <div id="search-history-menu" class="search-history-menu" style="display:none;">
                <div class="search-history-header">
                    <span class="search-history-title">Recent searches</span>
                </div>
                <div id="search-history-list" class="search-history-list">
                    <!-- History items will be inserted here -->
                </div>
            </div>
        </div>
        <div class="search-hints" style="font-size:11px;color:#888;">Hints: Use Regex for patterns</div>
    </div>
    </div>
</div>

<!-- Overlay for popups -->
<div id="print-dialog" class="print-dialog-shell" style="display:none;">
    <div class="print-dialog-header popup-header">
        <div class="print-dialog-title">Print Document</div>
        <button id="print-dialog-close" class="print-dialog-close close-btn" title="Close">&times;</button>
    </div>
    <div class="print-dialog-body">
        <div class="print-dialog-column print-dialog-settings">
            <div class="print-dialog-card">
                <div class="print-card-header">
                    <span class="print-card-title">Printer preference</span>
                    <button id="print-manage-printers-toggle" type="button" class="print-card-link">Manage printers</button>
                </div>
                <div class="print-card-content">
                    <select id="print-printer-select" class="print-select">
                        <option value="browser-default" selected>Use browser's printer dialog</option>
                    </select>
                    <p class="print-card-helper">Browsers can't list your printers automatically. Import names so we can remind you which one to pick.</p>
                    <div id="print-manage-printers-panel" class="print-manage-printers-panel" style="display:none;">
                        <div class="print-manage-description">Paste printer names (one per line). We'll store them locally so you can pick quickly.</div>
                        <textarea id="print-manage-printers-input" rows="4"></textarea>
                        <div class="print-manage-actions">
                            <button id="print-manage-printers-cancel" type="button" class="print-secondary-btn">Close</button>
                            <button id="print-manage-printers-save" type="button" class="print-primary-btn">Save list</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="print-dialog-card">
                <div class="print-card-header">
                    <span class="print-card-title">Content to print</span>
                </div>
                <div class="print-card-content print-card-radio-group">
                    <label>
                        <input type="radio" name="print-target" value="auto" checked>
                        <div>
                            <div class="radio-label">Smart selection</div>
                            <div class="radio-description">Uses your current layout to decide what to print.</div>
                        </div>
                    </label>
                    <label>
                        <input type="radio" name="print-target" value="editor">
                        <div>
                            <div class="radio-label">Markdown source</div>
                            <div class="radio-description">Prints exactly what appears in the editor.</div>
                        </div>
                    </label>
                    <label>
                        <input type="radio" name="print-target" value="preview">
                        <div>
                            <div class="radio-label">Rendered preview</div>
                            <div class="radio-description">Ideal for polished, share-ready documents.</div>
                        </div>
                    </label>
                </div>
            </div>

            <div class="print-dialog-card">
                <div class="print-card-header">
                    <span class="print-card-title">Orientation</span>
                </div>
                <div class="print-card-content print-card-orientation">
                    <button class="print-orientation-btn" data-orientation="portrait">
                        <span class="material-symbols-outlined">view_agenda</span>
                        Portrait
                    </button>
                    <button class="print-orientation-btn" data-orientation="landscape">
                        <span class="material-symbols-outlined">view_week</span>
                        Landscape
                    </button>
                </div>
            </div>

            <div class="print-dialog-card">
                <div class="print-card-header">
                    <span class="print-card-title">Options</span>
                </div>
                <div class="print-card-content print-card-options">
                    <label>
                        <input type="checkbox" id="print-include-metadata">
                        <span>Include title &amp; timestamps header</span>
                    </label>
                    <label>
                        <input type="checkbox" id="print-include-page-numbers" checked>
                        <span>Show page numbers</span>
                    </label>
                    <label>
                        <input type="checkbox" id="print-include-background">
                        <span>Allow background colors &amp; images</span>
                    </label>
                </div>
            </div>

            <div class="print-dialog-card">
                <div class="print-card-header">
                    <span class="print-card-title">Margins</span>
                </div>
                <div class="print-card-content">
                    <select id="print-margin" class="print-select">
                        <option value="default" selected>Standard (Browser default)</option>
                        <option value="narrow">Narrow (0.5")</option>
                        <option value="moderate">Moderate (0.75")</option>
                        <option value="wide">Wide (1")</option>
                        <option value="none">No margins</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="print-dialog-column print-dialog-preview-column">
            <div class="print-preview-card">
                <div class="print-preview-header">
                    <div class="print-preview-title">
                        <span class="material-symbols-outlined">print</span>
                        Preview
                    </div>
                    <div class="print-preview-actions">
                        <button type="button" class="print-preview-action" title="Previous page">
                            <span class="material-symbols-outlined">chevron_left</span>
                        </button>
                        <button type="button" class="print-preview-action" title="Next page">
                            <span class="material-symbols-outlined">chevron_right</span>
                        </button>
                        <button type="button" class="print-preview-action" title="Fit to width">
                            <span class="material-symbols-outlined">fit_screen</span>
                        </button>
                    </div>
                </div>
                <div id="print-preview-info" class="print-preview-meta">Live preview based on your selections</div>
                <div class="print-dialog-preview-pane" id="print-preview-pane">
                    <div id="print-preview-content" class="print-dialog-preview-content">
                        Select a target to see a preview.
                    </div>
                </div>
            </div>
            <div id="print-preview-warning" class="print-preview-warning" style="display:none;">
                <strong>Heads up:</strong> We'll open a preview window to print the rendered content.
            </div>
        </div>
    </div>
    <div class="print-dialog-footer">
        <label class="print-footer-toggle">
            <input type="checkbox" id="print-remember-printers" checked>
            <span>Remember my printer names on this device</span>
        </label>
        <div class="print-footer-actions">
            <button id="print-dialog-cancel" class="print-secondary-btn">Cancel</button>
            <button id="print-dialog-confirm" class="print-primary-btn">Print</button>
        </div>
    </div>
</div>

<div id="popup-overlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:120000;"></div>

<!-- Link/Image Dialog -->
<div id="link-image-dialog" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.9);backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px);border:1px solid rgba(0,0,0,0.06);z-index:130000;width:400px;box-shadow:0 8px 24px rgba(0,0,0,0.12), 0 0 0 1px rgba(255,255,255,0.5) inset;border-radius:8px;overflow:hidden;">
    <div style="background:rgba(0,120,212,0.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-radius:8px 8px 0 0;box-shadow:0 1px 0 rgba(255,255,255,0.2) inset;">
        <span id="dialog-title" style="font-weight:bold;">Insert Link</span>
        <button id="dialog-title-close" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;">&times;</button>
    </div>
    <div style="padding:16px;">
    <div style="margin-bottom:10px;">
        <label for="dialog-url" style="display:block;margin-bottom:5px;font-size:13px;">URL</label>
        <input id="dialog-url" type="text" style="width:100%;padding:8px;font-size:14px;" />
    </div>
    <div style="margin-bottom:15px;">
        <label for="dialog-text" id="dialog-text-label" style="display:block;margin-bottom:5px;font-size:13px;">Text</label>
        <input id="dialog-text" type="text" style="width:100%;padding:8px;font-size:14px;" />
    </div>
    <div id="dialog-auto-resize-container" style="margin-bottom:10px;">
        <label class="dialog-checkbox"><input id="dialog-auto-resize" type="checkbox"> Auto-resize this image</label>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;">
        <button id="dialog-cancel">Cancel</button>
        <button id="dialog-ok">OK</button>
    </div>
    </div>
</div>

<!-- Custom Alert Dialog -->
<div id="custom-alert" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.9);backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px);border:1px solid rgba(0,0,0,0.06);z-index:130000;width:450px;box-shadow:0 8px 24px rgba(0,0,0,0.12), 0 0 0 1px rgba(255,255,255,0.5) inset;border-radius:8px;overflow:hidden;">
    <div style="background:rgba(0,120,212,0.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-radius:8px 8px 0 0;box-shadow:0 1px 0 rgba(255,255,255,0.2) inset;">
        <span style="font-weight:bold;">Alert</span>
    </div>
    <div style="padding:20px;text-align:center;">
        <div id="custom-alert-message" style="margin-bottom:20px;font-size:14px;line-height:1.6;white-space:pre-wrap;"></div>
        <button id="custom-alert-ok" style="padding:8px 20px;">OK</button>
    </div>
</div>

<!-- Premium Upsell Dialog -->
<div id="premium-upsell" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);width:640px;max-width:calc(100% - 32px);background:rgba(255,255,255,0.97);backdrop-filter:blur(45px);-webkit-backdrop-filter:blur(45px);border:1px solid rgba(255,255,255,0.7);border-radius:16px;box-shadow:0 24px 80px rgba(10,14,35,0.25), 0 0 0 1px rgba(255,255,255,0.4) inset;z-index:150000;overflow:hidden;font-family:'Segoe UI',sans-serif;color:#1f1f1f;">
    <div style="background:linear-gradient(135deg, rgba(255,77,141,0.95) 0%, rgba(122,95,255,0.95) 100%);padding:20px 24px;color:#fff;display:flex;align-items:center;justify-content:space-between;">
        <div>
            <div style="display:flex;align-items:center;gap:12px;font-size:16px;font-weight:600;">
                <span class="material-symbols-outlined" style="font-size:28px;">stars</span>
                Lancer Notes Premium
            </div>
            <p style="margin:6px 0 0 0;font-size:13px;opacity:0.9;">Craft limitless custom themes, cinematic backgrounds, and more.</p>
        </div>
        <button class="premium-upsell-close" style="background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.35);color:#fff;font-size:20px;width:36px;height:36px;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;">
            &times;
        </button>
    </div>
    <div style="padding:24px;">
        <div style="display:grid;grid-template-columns:1fr 220px;gap:24px;align-items:flex-start;">
            <div>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:18px;">
                    <div style="background:rgba(122,95,255,0.08);border:1px solid rgba(122,95,255,0.2);border-radius:12px;padding:12px;box-shadow:0 8px 18px rgba(122,95,255,0.12);">
                        <div style="display:flex;align-items:center;gap:8px;font-weight:600;font-size:13px;margin-bottom:6px;">
                            <span class="material-symbols-outlined" style="font-size:20px;color:#7a5fff;">palette</span>
                            Infinite Palettes
                        </div>
                        <p style="margin:0;font-size:12px;color:#5b5f6d;line-height:1.5;">Generate dazzling gradients and save personal color stories.</p>
                    </div>
                    <div style="background:rgba(255,159,67,0.08);border:1px solid rgba(255,159,67,0.25);border-radius:12px;padding:12px;box-shadow:0 8px 18px rgba(255,159,67,0.12);">
                        <div style="display:flex;align-items:center;gap:8px;font-weight:600;font-size:13px;margin-bottom:6px;">
                            <span class="material-symbols-outlined" style="font-size:20px;color:#ff9f43;">live_tv</span>
                            Live Previews
                        </div>
                        <p style="margin:0;font-size:12px;color:#5b5f6d;line-height:1.5;">Audition your theme on editor, notebook, and presentation layouts instantly.</p>
                    </div>
                    <div style="background:rgba(76,217,172,0.08);border:1px solid rgba(76,217,172,0.2);border-radius:12px;padding:12px;box-shadow:0 8px 18px rgba(76,217,172,0.12);">
                        <div style="display:flex;align-items:center;gap:8px;font-weight:600;font-size:13px;margin-bottom:6px;">
                            <span class="material-symbols-outlined" style="font-size:20px;color:#2ecc9a;">auto_awesome</span>
                            AI Stylist
                        </div>
                        <p style="margin:0;font-size:12px;color:#5b5f6d;line-height:1.5;">Let Lancer AI remix your markdown to match your mood instantly.</p>
                    </div>
                    <div style="background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:12px;padding:12px;box-shadow:0 8px 18px rgba(59,130,246,0.12);">
                        <div style="display:flex;align-items:center;gap:8px;font-weight:600;font-size:13px;margin-bottom:6px;">
                            <span class="material-symbols-outlined" style="font-size:20px;color:#3b82f6;">workspace_premium</span>
                            Premium Library
                        </div>
                        <p style="margin:0;font-size:12px;color:#5b5f6d;line-height:1.5;">Unlock curated theme drops every week from the Lancer studio.</p>
                    </div>
                </div>
            </div>
            <div style="background:linear-gradient(180deg, rgba(255,245,250,0.98) 0%, rgba(245,240,255,0.98) 100%);border:1px solid rgba(122,95,255,0.18);border-radius:14px;padding:18px;box-shadow:0 12px 32px rgba(122,95,255,0.18);">
                <div style="font-weight:700;font-size:14px;color:#7a5fff;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.8px;">Premium Plan</div>
                <div style="display:flex;align-items:flex-end;gap:6px;margin-bottom:12px;">
                    <span style="font-size:28px;font-weight:700;color:#1f1f1f;">$9.99</span>
                    <span style="font-size:12px;color:#6b6f7b;margin-bottom:4px;">/month</span>
                </div>
                <ul style="padding-left:18px;margin:0 0 16px 0;font-size:12px;color:#505463;line-height:1.7;">
                    <li>Priority creator concierge</li>
                    <li>Unlimited device sync</li>
                    <li>Early access feature drops</li>
                </ul>
                <div style="font-size:12px;color:#6b6f7b;display:flex;align-items:center;gap:6px;">
                    <span class="material-symbols-outlined" style="font-size:18px;color:#43d17a;">verified_user</span>
                    Cancel anytime during trial.
                </div>
            </div>
        </div>

        <div style="margin-top:24px;background:rgba(255,255,255,0.92);border:1px solid rgba(15,23,42,0.08);border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(15,23,42,0.08);">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
                <div style="width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#7a5fff,#ff4d8d);display:flex;align-items:center;justify-content:center;color:#fff;">
                    <span class="material-symbols-outlined" style="font-size:22px;">credit_card</span>
                </div>
                <div>
                    <div style="font-weight:600;font-size:14px;color:#1f1f1f;">Secure your 30-day free trial</div>
                    <div style="font-size:12px;color:#5b5f6d;">Add a card to activate styling superpowers.</div>
                </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:12px;">
                <label style="font-size:12px;color:#4b4f5d;font-weight:600;display:flex;flex-direction:column;gap:6px;">
                    Card number
                    <input id="premium-card-number" type="text" inputmode="numeric" autocomplete="off" placeholder="4242 4242 4242 4242" style="padding:12px 14px;border:1px solid rgba(15,23,42,0.12);border-radius:10px;font-size:14px;color:#1f1f1f;box-shadow:0 4px 12px rgba(15,23,42,0.05);outline:none;">
                </label>
                <div style="display:flex;gap:12px;flex-wrap:wrap;">
                    <label style="flex:1 1 140px;font-size:12px;color:#4b4f5d;font-weight:600;display:flex;flex-direction:column;gap:6px;">
                        Expiry
                        <input id="premium-card-expiry" type="text" inputmode="numeric" autocomplete="off" placeholder="MM / YY" style="padding:12px 14px;border:1px solid rgba(15,23,42,0.12);border-radius:10px;font-size:14px;color:#1f1f1f;box-shadow:0 4px 12px rgba(15,23,42,0.05);outline:none;">
                    </label>
                    <label style="flex:1 1 120px;font-size:12px;color:#4b4f5d;font-weight:600;display:flex;flex-direction:column;gap:6px;">
                        CVC
                        <input id="premium-card-cvc" type="text" inputmode="numeric" autocomplete="off" placeholder="123" style="padding:12px 14px;border:1px solid rgba(15,23,42,0.12);border-radius:10px;font-size:14px;color:#1f1f1f;box-shadow:0 4px 12px rgba(15,23,42,0.05);outline:none;">
                    </label>
                </div>
            </div>
            <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:20px;">
                <button id="premium-upsell-start" style="flex:1 1 220px;background:linear-gradient(135deg,#7a5fff,#ff4d8d);color:#fff;border:none;border-radius:12px;padding:12px 18px;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 12px 24px rgba(122,95,255,0.35);display:flex;align-items:center;justify-content:center;gap:8px;transition:transform 0.15s ease, box-shadow 0.15s ease;">
                    <span class="material-symbols-outlined" style="font-size:20px;">bolt</span>
                    Start 30-day free trial
                </button>
                <button type="button" class="premium-upsell-close" style="flex:0 0 auto;background:rgba(15,23,42,0.05);border:none;color:#4b4f5d;border-radius:12px;padding:12px 18px;font-size:13px;font-weight:600;cursor:pointer;">Maybe later</button>
            </div>
            <div style="margin-top:12px;font-size:11px;color:#7a7f8a;display:flex;align-items:center;gap:6px;">
                <span class="material-symbols-outlined" style="font-size:16px;color:#7a5fff;">lock</span>
                We run on Lancer SecurePay<sup style="font-size:8px;">TM</sup> — 256-bit smiles guaranteed.
            </div>
        </div>
        <p style="margin:14px 0 0 0;font-size:11px;color:#7a7f8a;text-align:center;">*Trial renews automatically unless cancelled. Service may include spontaneous sing-alongs.</p>
    </div>
</div>

<!-- Save error dialog (retry / save as / download) -->
<div id="save-error-dialog" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border:1px solid #ccc;z-index:140001;width:420px;box-shadow:0 8px 32px rgba(0,0,0,0.2);border-radius:8px;overflow:hidden;padding:16px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <strong>Save Error</strong>
        <button id="save-error-close" style="background:none;border:none;font-size:18px;cursor:pointer;">&times;</button>
    </div>
    <div style="margin-bottom:12px;color:#222;font-size:13px;" id="save-error-message">An error occurred while saving.</div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button id="save-error-retry" style="padding:8px 12px;border-radius:6px;cursor:pointer;">Retry</button>
        <button id="save-error-saveas" style="padding:8px 12px;border-radius:6px;cursor:pointer;">Save As...</button>
        <button id="save-error-download" style="padding:8px 12px;border-radius:6px;cursor:pointer;">Download</button>
    </div>
</div>

<!-- First Boot Mode Selection Dialog (Beta) -->
<div id="mode-selection-dialog" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.95);backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px);border:1px solid rgba(0,0,0,0.06);z-index:140000;width:600px;box-shadow:0 16px 48px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.5) inset;border-radius:12px;overflow:hidden;">
    <div style="background:linear-gradient(135deg, rgba(0,120,212,0.95) 0%, rgba(102,51,153,0.95) 100%);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);color:#fff;padding:20px 24px;border-radius:12px 12px 0 0;box-shadow:0 2px 0 rgba(255,255,255,0.2) inset;">
        <h2 style="margin:0 0 8px 0;font-size:24px;font-weight:600;">Welcome to Lancer Notes!</h2>
        <p style="margin:0;font-size:14px;opacity:0.9;">Choose your preferred mode to optimize your experience</p>
    </div>
    <div style="padding:32px 28px;">
        <div style="background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.3);border-radius:8px;padding:12px 16px;margin-bottom:24px;">
            <div style="display:flex;align-items:center;gap:10px;">
                <span class="material-symbols-outlined" style="color:#f57c00;font-size:24px;">science</span>
                <div>
                    <strong style="color:#f57c00;font-size:13px;">BETA FEATURE</strong>
                    <p style="margin:4px 0 0 0;font-size:12px;color:#666;line-height:1.4;">This mode selection is experimental and may disable extensions deemed unnecessary for your use case.</p>
                </div>
            </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
            <!-- Student Mode -->
            <div id="mode-student" class="mode-option" style="border:2px solid #e0e0e0;border-radius:10px;padding:20px;cursor:pointer;transition:all 0.3s;background:#fff;">
                <div style="text-align:center;margin-bottom:16px;">
                    <span class="material-symbols-outlined" style="font-size:48px;color:#4caf50;">school</span>
                </div>
                <h3 style="margin:0 0 8px 0;font-size:18px;font-weight:600;color:#202124;text-align:center;">Student</h3>
                <p style="margin:0 0 16px 0;font-size:13px;color:#5f6368;line-height:1.5;text-align:center;">Optimized for essays, notes, and assignments</p>
                <div style="background:#f8f9fa;border-radius:6px;padding:12px;font-size:12px;color:#666;">
                    <div style="margin-bottom:8px;font-weight:600;color:#202124;">Enabled:</div>
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
                        <span class="material-symbols-outlined" style="font-size:16px;color:#4caf50;">check_circle</span>
                        <span>Spell Checker</span>
                    </div>
                    <div style="margin-top:12px;margin-bottom:8px;font-weight:600;color:#202124;">Disabled:</div>
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
                        <span class="material-symbols-outlined" style="font-size:16px;color:#9e9e9e;">cancel</span>
                        <span>Syntax Highlighter</span>
                    </div>
                </div>
            </div>
            
            <!-- Programming Mode -->
            <div id="mode-programming" class="mode-option" style="border:2px solid #e0e0e0;border-radius:10px;padding:20px;cursor:pointer;transition:all 0.3s;background:#fff;">
                <div style="text-align:center;margin-bottom:16px;">
                    <span class="material-symbols-outlined" style="font-size:48px;color:#0078d4;">code</span>
                </div>
                <h3 style="margin:0 0 8px 0;font-size:18px;font-weight:600;color:#202124;text-align:center;">Programming</h3>
                <p style="margin:0 0 16px 0;font-size:13px;color:#5f6368;line-height:1.5;text-align:center;">Optimized for code documentation</p>
                <div style="background:#f8f9fa;border-radius:6px;padding:12px;font-size:12px;color:#666;">
                    <div style="margin-bottom:8px;font-weight:600;color:#202124;">Enabled:</div>
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
                        <span class="material-symbols-outlined" style="font-size:16px;color:#4caf50;">check_circle</span>
                        <span>GitHub Flavored Markdown</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
                        <span class="material-symbols-outlined" style="font-size:16px;color:#4caf50;">check_circle</span>
                        <span>Syntax Highlighting</span>
                    </div>
                    <div style="margin-top:12px;margin-bottom:8px;font-weight:600;color:#202124;">Disabled:</div>
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
                        <span class="material-symbols-outlined" style="font-size:16px;color:#9e9e9e;">cancel</span>
                        <span>Extended Markdown</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="text-align:center;padding-top:12px;border-top:1px solid #e0e0e0;">
            <button id="mode-skip" style="background:transparent;color:#5f6368;border:none;padding:8px 16px;cursor:pointer;font-size:13px;text-decoration:underline;">Skip for now (use defaults)</button>
        </div>
    </div>
</div>

<!-- Help & Documentation Popup -->
<div id="help-popup" style="display:none;position:fixed;top:5vh;left:50%;transform:translateX(-50%);width:90vw;height:90vh;z-index:130000;background:rgba(255,255,255,0.95);backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px);border:1px solid rgba(0,0,0,0.06);box-shadow:0 16px 32px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.5) inset;border-radius:8px;overflow:hidden;">
      <div class="popup-header" style="background:rgba(0,120,212,0.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-radius:8px 8px 0 0;box-shadow:0 1px 0 rgba(255,255,255,0.2) inset;">
        <span style="font-weight:bold;">Help & Documentation</span>
        <button id="help-popup-close" class="close-btn" title="Close">×</button>
      </div>
      <iframe src="help.html" style="width:100%;height:calc(100% - 44px);border:none;background:#fff;"></iframe>
    </div>

<!-- Changelog Popup -->
<div id="changelog-popup" style="display:none;position:fixed;top:5vh;left:50%;transform:translateX(-50%);width:90vw;height:90vh;z-index:130000;background:rgba(255,255,255,0.95);backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px);border:1px solid rgba(0,0,0,0.06);box-shadow:0 16px 32px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.5) inset;border-radius:8px;overflow:hidden;">
      <div class="popup-header" style="background:rgba(0,120,212,0.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-radius:8px 8px 0 0;box-shadow:0 1px 0 rgba(255,255,255,0.2) inset;">
        <span style="font-weight:bold;">Changelogs</span>
        <button id="changelog-popup-close" class="close-btn" title="Close">×</button>
      </div>
            <div id="changelog-content" class="preview-content" style="width:100%;height:calc(100% - 44px);border:none;overflow:auto;padding:16px;">
                <!-- Local changelogs will be injected here via JS (parsed from markdown) -->
            </div>
    </div>

<!-- Image Cap Dialog -->
<div id="image-cap-dialog" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.9);backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px);border:1px solid rgba(0,0,0,0.06);z-index:130000;width:400px;box-shadow:0 8px 24px rgba(0,0,0,0.12), 0 0 0 1px rgba(255,255,255,0.5) inset;border-radius:8px;overflow:hidden;">
    <div style="background:rgba(0,120,212,0.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-radius:8px 8px 0 0;box-shadow:0 1px 0 rgba(255,255,255,0.2) inset;">
        <span style="font-weight:bold;">Set Image Maximum Width</span>
        <button id="image-cap-close" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;">&times;</button>
    </div>
    <div style="padding:16px;">
        <div style="margin-bottom:10px;">
            <label for="image-cap-input" style="display:block;margin-bottom:5px;font-size:13px;">Maximum width for auto-resized images (pixels):</label>
            <input id="image-cap-input" type="number" min="50" max="3000" step="50" style="width:100%;padding:8px;font-size:14px;" />
        </div>
        <div style="font-size:12px;color:#666;margin-bottom:15px;">Default: 800px. Range: 50-3000px.</div>
        <div style="display:flex;justify-content:flex-end;gap:8px;">
            <button id="image-cap-cancel" style="padding:6px 12px;">Cancel</button>
            <button id="image-cap-ok" style="padding:6px 12px;">OK</button>
        </div>
    </div>
</div>

<!-- Theme Dialog -->
<div id="theme-dialog" class="draggable-dialog" style="display:none;position:fixed;top:15%;left:50%;transform:translateX(-50%);width:680px;max-height:80vh;z-index:130000;background:rgba(255,255,255,0.9);backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px);border:1px solid rgba(0,0,0,0.06);box-shadow:0 8px 24px rgba(0,0,0,0.12), 0 0 0 1px rgba(255,255,255,0.5) inset;border-radius:8px;overflow:visible;">
    <div id="theme-dialog-header" class="dialog-header" style="background:rgba(0,120,212,0.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;cursor:move;border-radius:8px 8px 0 0;box-shadow:0 1px 0 rgba(255,255,255,0.2) inset;">
        <span style="font-weight:bold;">Theme Selector</span>
        <button id="theme-dialog-close" class="close-btn" title="Close" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;">&times;</button>
    </div>
    <div class="theme-dialog-content" style="max-height:calc(80vh - 50px);overflow-y:auto;overflow-x:hidden;">
    <div style="padding:24px;">
        <h3 style="margin-top:0;margin-bottom:20px;font-size:18px;color:#333;font-weight:600;">Choose your theme</h3>
        
        <!-- Theme Grid - Windows 11 Style -->
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:24px;">
            <!-- Auto Theme Card -->
            <label class="theme-preview-card" data-theme="auto" style="position:relative;cursor:pointer;border-radius:12px;overflow:hidden;border:2px solid #e0e0e0;transition:all 0.3s;">
                <input type="radio" name="theme" value="auto" style="display:none;">
                <div class="theme-preview" style="height:120px;background:linear-gradient(135deg, #f8f9fa 0%, #23272a 100%);position:relative;padding:12px;">
                    <div style="position:absolute;top:12px;right:12px;width:28px;height:28px;background:#007acc;border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s;" class="theme-check">
                        <span class="material-symbols-outlined" style="font-size:18px;color:#fff;">check</span>
                    </div>
                    <div style="position:absolute;top:12px;left:12px;background:rgba(255,255,255,0.9);padding:4px 8px;border-radius:12px;font-size:10px;font-weight:600;color:#007acc;">
                        <span class="material-symbols-outlined" style="font-size:14px;vertical-align:middle;">settings_suggest</span>
                    </div>
                    <div style="display:flex;gap:4px;margin-top:60px;">
                        <div style="width:40px;height:12px;background:#007acc;border-radius:2px;"></div>
                        <div style="width:60px;height:12px;background:#4fc3f7;border-radius:2px;"></div>
                        <div style="width:30px;height:12px;background:#e9ecef;border-radius:2px;"></div>
                    </div>
                </div>
                <div style="padding:12px;background:#fff;">
                    <div style="font-weight:600;font-size:14px;margin-bottom:4px;">Auto</div>
                    <div style="font-size:11px;color:#666;">Use system preference</div>
                </div>
            </label>
            
            <!-- Light Theme Card -->
            <label class="theme-preview-card" data-theme="light" style="position:relative;cursor:pointer;border-radius:12px;overflow:hidden;border:2px solid #e0e0e0;transition:all 0.3s;">
                <input type="radio" name="theme" value="light" style="display:none;">
                <div class="theme-preview" style="height:120px;background:linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);position:relative;padding:12px;">
                    <div style="position:absolute;top:12px;right:12px;width:28px;height:28px;background:#007acc;border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s;" class="theme-check">
                        <span class="material-symbols-outlined" style="font-size:18px;color:#fff;">check</span>
                    </div>
                    <div style="display:flex;gap:4px;margin-top:60px;">
                        <div style="width:40px;height:12px;background:#007acc;border-radius:2px;"></div>
                        <div style="width:60px;height:12px;background:#e9ecef;border-radius:2px;"></div>
                        <div style="width:30px;height:12px;background:#f0f0f0;border-radius:2px;"></div>
                    </div>
                </div>
                <div style="padding:12px;background:#fff;">
                    <div style="font-weight:600;font-size:14px;margin-bottom:4px;">Light</div>
                    <div style="font-size:11px;color:#666;">Default light appearance</div>
                </div>
            </label>
            
            <!-- Dark Theme Card -->
            <label class="theme-preview-card" data-theme="dark" style="position:relative;cursor:pointer;border-radius:12px;overflow:hidden;border:2px solid #e0e0e0;transition:all 0.3s;">
                <input type="radio" name="theme" value="dark" style="display:none;">
                <div class="theme-preview" style="height:120px;background:linear-gradient(135deg, #23272a 0%, #181a1b 100%);position:relative;padding:12px;">
                    <div style="position:absolute;top:12px;right:12px;width:28px;height:28px;background:#4fc3f7;border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s;" class="theme-check">
                        <span class="material-symbols-outlined" style="font-size:18px;color:#000;">check</span>
                    </div>
                    <div style="display:flex;gap:4px;margin-top:60px;">
                        <div style="width:40px;height:12px;background:#4fc3f7;border-radius:2px;"></div>
                        <div style="width:60px;height:12px;background:#2d3136;border-radius:2px;"></div>
                        <div style="width:30px;height:12px;background:#23272a;border-radius:2px;"></div>
                    </div>
                </div>
                <div style="padding:12px;background:#fff;">
                    <div style="font-weight:600;font-size:14px;margin-bottom:4px;">Dark</div>
                    <div style="font-size:11px;color:#666;">Easy on the eyes</div>
                </div>
            </label>
            
        </div>
        
        <!-- Compact Mode Option -->
        <div style="margin-top:16px;padding:16px;background:rgba(0,122,204,0.05);border-radius:8px;border:1px solid rgba(0,122,204,0.15);">
            <h4 style="font-size:14px;color:#666;margin:0 0 12px 0;text-transform:uppercase;font-weight:600;">Display Options</h4>
            <label class="compact-mode-label" style="display:flex;align-items:center;gap:12px;cursor:pointer;padding:8px;border-radius:6px;transition:background 0.2s;" onmouseover="this.style.background='rgba(0,122,204,0.08)'" onmouseout="this.style.background='transparent'">
                <input type="checkbox" id="compact-mode-toggle" style="width:20px;height:20px;cursor:pointer;accent-color:#007acc;">
                <div style="flex:1;">
                    <div style="font-weight:600;margin-bottom:2px;color:#333;">
                        <span class="material-symbols-outlined" style="font-size:18px;vertical-align:middle;margin-right:6px;color:#007acc;">compress</span>
                        Compact Mode
                    </div>
                    <div style="font-size:12px;color:#666;">Reduce size of all UI elements for more space</div>
                </div>
            </label>
        </div>
        
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:20px;padding-top:16px;border-top:1px solid #e0e0e0;">
            <button id="theme-dialog-cancel" style="padding:8px 16px;background:#f0f0f0;border:1px solid #ccc;border-radius:4px;cursor:pointer;">Cancel</button>
            <button id="theme-dialog-apply" style="padding:8px 16px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer;">Apply</button>
        </div>
    </div>
    </div>
</div>

<!-- Settings Dialog -->
<div id="settings-dialog" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:130000;overflow:hidden;">
    <!-- Settings Header -->
    <div style="background:#f8f9fa;border-bottom:1px solid #dee2e6;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;">
        <div style="display:flex;align-items:center;gap:16px;">
            <button id="settings-close" style="background:none;border:none;font-size:24px;color:#666;cursor:pointer;padding:4px;border-radius:4px;display:flex;align-items:center;justify-content:center;" title="Close">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <div>
                <h1 style="margin:0;font-size:20px;font-weight:500;color:#202124;">Settings</h1>
                <p style="margin:0;font-size:13px;color:#5f6368;">Configure your Lancer Notes experience</p>
            </div>
        </div>
        <div style="display:flex;gap:12px;">
            <button id="settings-cancel" style="padding:8px 16px;background:#fff;border:1px solid #dadce0;color:#3c4043;border-radius:4px;cursor:pointer;font-size:14px;font-weight:500;">Cancel</button>
            <button id="settings-save" style="padding:8px 16px;background:#1a73e8;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:14px;font-weight:500;">Save & Close</button>
        </div>
    </div>
    
    <div style="display:flex;height:calc(100% - 73px);">
        <!-- Left Sidebar Navigation -->
        <div style="width:256px;background:#f8f9fa;border-right:1px solid #dee2e6;overflow-y:auto;">
            <nav style="padding:8px 0;">
                <div class="settings-nav-item" data-section="general" style="display:flex;align-items:center;gap:12px;padding:12px 24px;cursor:pointer;color:#202124;font-size:14px;font-weight:500;background:#e8f0fe;color:#1967d2;border-left:3px solid #1967d2;">
                    <span class="material-symbols-outlined" style="font-size:20px;">settings</span>
                    <span>General</span>
                </div>
                <div class="settings-nav-item" data-section="editor" style="display:flex;align-items:center;gap:12px;padding:12px 24px;cursor:pointer;color:#5f6368;font-size:14px;">
                    <span class="material-symbols-outlined" style="font-size:20px;">edit_note</span>
                    <span>Editor</span>
                </div>
                <div class="settings-nav-item" data-section="preview" style="display:flex;align-items:center;gap:12px;padding:12px 24px;cursor:pointer;color:#5f6368;font-size:14px;">
                    <span class="material-symbols-outlined" style="font-size:20px;">visibility</span>
                    <span>Preview</span>
                </div>
                <div class="settings-nav-item" data-section="data" style="display:flex;align-items:center;gap:12px;padding:12px 24px;cursor:pointer;color:#5f6368;font-size:14px;">
                    <span class="material-symbols-outlined" style="font-size:20px;">storage</span>
                    <span>Data & Privacy</span>
                </div>
                <div class="settings-nav-item" data-section="extensions" style="display:flex;align-items:center;gap:12px;padding:12px 24px;cursor:pointer;color:#5f6368;font-size:14px;">
                    <span class="material-symbols-outlined" style="font-size:20px;">extension</span>
                    <span>Extensions</span>
                </div>
                <div class="settings-nav-item" data-section="about" style="display:flex;align-items:center;gap:12px;padding:12px 24px;cursor:pointer;color:#5f6368;font-size:14px;">
                    <span class="material-symbols-outlined" style="font-size:20px;">info</span>
                    <span>About</span>
                </div>
            </nav>
        </div>
        
        <!-- Main Content Area -->
        <div style="flex:1;overflow-y:auto;background:#fff;">
            <!-- General Settings -->
            <div class="settings-section" data-section="general" style="display:block;padding:32px 48px;">
                <h2 style="margin:0 0 8px 0;font-size:24px;font-weight:400;color:#202124;">General</h2>
                <p style="margin:0 0 32px 0;color:#5f6368;font-size:14px;">Basic application settings and preferences</p>
                
                <div style="margin-bottom:32px;">
                    <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:500;color:#202124;">Appearance</h3>
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;">
                            <div>
                                <div style="font-size:14px;font-weight:500;color:#202124;margin-bottom:4px;">Theme</div>
                                <div style="font-size:13px;color:#5f6368;">Open the theme picker to choose light, dark, or auto modes</div>
                            </div>
                            <button id="open-theme-settings" style="padding:8px 16px;background:#1a73e8;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;display:flex;align-items:center;gap:6px;">
                                <span class="material-symbols-outlined" style="font-size:18px;">palette</span>
                                Theme settings
                            </button>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom:32px;">/,
                    <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:500;color:#202124;">Language & Region</h3>
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;">
                        <div style="font-size:14px;color:#5f6368;">Language settings coming soon</div>
                    </div>
                </div>
                
                <div style="margin-bottom:32px;">
                    <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:500;color:#202124;">Advanced Options</h3>
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;">
                            <div>
                                <div style="font-size:14px;font-weight:500;color:#202124;margin-bottom:4px;">Developer Mode</div>
                                <div style="font-size:13px;color:#5f6368;">Show developer tools and testing features in the menu bar</div>
                            </div>
                            <label class="settings-toggle" style="position:relative;display:inline-block;width:44px;height:24px;">
                                <input type="checkbox" id="developer-mode" style="opacity:0;width:0;height:0;">
                                <span class="toggle-track" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:24px;"></span>
                                <span class="toggle-thumb" style="position:absolute;content:'';height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.4s;border-radius:50%;"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Editor Settings -->
            <div class="settings-section" data-section="editor" style="display:none;padding:32px 48px;">
                <h2 style="margin:0 0 8px 0;font-size:24px;font-weight:400;color:#202124;">Editor</h2>
                <p style="margin:0 0 32px 0;color:#5f6368;font-size:14px;">Configure editor behavior and display options</p>
                
                <div style="margin-bottom:32px;">
                    <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:500;color:#202124;">Editing</h3>
                    
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;margin-bottom:16px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;">
                            <div>
                                <div style="font-size:14px;font-weight:500;color:#202124;margin-bottom:4px;">Auto-save</div>
                                <div style="font-size:13px;color:#5f6368;">Automatically save changes every 30 seconds</div>
                            </div>
                            <label class="settings-toggle" style="position:relative;display:inline-block;width:44px;height:24px;">
                                <input type="checkbox" id="auto-save" style="opacity:0;width:0;height:0;">
                                <span class="toggle-track" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:24px;"></span>
                                <span class="toggle-thumb" style="position:absolute;content:'';height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.4s;border-radius:50%;"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;">
                            <div>
                                <div style="font-size:14px;font-weight:500;color:#202124;margin-bottom:4px;">Word wrap</div>
                                <div style="font-size:13px;color:#5f6368;">Wrap long lines for better readability</div>
                            </div>
                            <label class="settings-toggle" style="position:relative;display:inline-block;width:44px;height:24px;">
                                <input type="checkbox" id="word-wrap" style="opacity:0;width:0;height:0;">
                                <span class="toggle-track" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:24px;"></span>
                                <span class="toggle-thumb" style="position:absolute;content:'';height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.4s;border-radius:50%;"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom:32px;">
                    <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:500;color:#202124;">Font Size</h3>
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;">
                        <div style="display:flex;align-items:center;gap:16px;">
                            <button id="font-decrease" style="width:32px;height:32px;border:1px solid #dadce0;background:#fff;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;">
                                <span class="material-symbols-outlined" style="font-size:18px;">remove</span>
                            </button>
                            <div style="flex:1;text-align:center;">
                                <div id="font-size-display" style="font-size:16px;font-weight:500;color:#202124;">14px</div>
                                <div style="font-size:12px;color:#5f6368;">Text size</div>
                            </div>
                            <button id="font-increase" style="width:32px;height:32px;border:1px solid #dadce0;background:#fff;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;">
                                <span class="material-symbols-outlined" style="font-size:18px;">add</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;">
                        <div style="font-size:14px;font-weight:500;color:#202124;margin-bottom:12px;">Font Family</div>
                        <div style="margin-bottom:12px;">
                            <select id="font-family-select" style="width:100%;padding:8px;border:1px solid #dadce0;border-radius:4px;font-size:14px;background:#fff;">
                                <option value="system-ui">System UI</option>
                                <option value="Arial">Arial</option>
                                <option value="Helvetica">Helvetica</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Courier New">Courier New</option>
                                <option value="monospace">Monospace</option>
                                <option value="google-fonts" selected>Google Fonts...</option>
                            </select>
                        </div>
                        <div id="google-fonts-section" style="display:none;">
                            <div style="display:flex;gap:8px;margin-bottom:12px;">
                                <input type="text" id="google-font-search" placeholder="Search Google Fonts..." style="flex:1;padding:8px;border:1px solid #dadce0;border-radius:4px;font-size:14px;">
                                <button id="search-fonts-btn" style="padding:8px 16px;background:#1a73e8;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:13px;">Search</button>
                            </div>
                            <div id="font-search-results" style="max-height:200px;overflow-y:auto;border:1px solid #dadce0;border-radius:4px;background:#fff;display:none;">
                                <!-- Font results will be populated here -->
                            </div>
                            <div id="selected-font-display" style="margin-top:12px;padding:12px;background:#e8f0fe;border-radius:4px;display:none;">
                                <div style="font-size:13px;color:#5f6368;margin-bottom:4px;">Selected font:</div>
                                <div id="selected-font-name" style="font-size:16px;font-weight:500;color:#202124;"></div>
                            </div>
                        </div>
                        <div style="font-size:13px;color:#5f6368;">Choose your preferred font family</div>
                    </div>
                    
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;">
                        <div style="font-size:14px;font-weight:500;color:#202124;margin-bottom:12px;">Editor Font (Monospace)</div>
                        <div style="margin-bottom:12px;">
                            <select id="editor-font-select" style="width:100%;padding:8px;border:1px solid #dadce0;border-radius:4px;font-size:14px;background:#fff;">
                                <option value="monospace">System Default Monospace</option>
                                <option value="'Consolas', monospace">Consolas (Windows)</option>
                                <option value="'Lucida Console', monospace">Lucida Console (Windows)</option>
                                <option value="'Cascadia Code', monospace">Cascadia Code (Windows)</option>
                                <option value="'Cascadia Mono', monospace">Cascadia Mono (Windows)</option>
                                <option value="'Courier New', monospace">Courier New (Windows)</option>
                                <option value="'Courier', monospace">Courier</option>
                                <option value="'Monaco', monospace">Monaco (macOS)</option>
                                <option value="'Menlo', monospace">Menlo (macOS)</option>
                                <option value="'SF Mono', monospace">SF Mono (macOS)</option>
                                <option value="'JetBrains Mono', monospace">JetBrains Mono</option>
                                <option value="'Fira Code', monospace">Fira Code</option>
                                <option value="'Source Code Pro', monospace">Source Code Pro</option>
                                <option value="'IBM Plex Mono', monospace">IBM Plex Mono</option>
                                <option value="'Roboto Mono', monospace">Roboto Mono</option>
                                <option value="'DejaVu Sans Mono', monospace">DejaVu Sans Mono</option>
                                <option value="'Anonymous Pro', monospace">Anonymous Pro</option>
                                <option value="'Hack', monospace">Hack</option>
                            </select>
                        </div>
                        <div style="font-size:13px;color:#5f6368;margin-bottom:12px;">Choose your preferred monospace font for the editor</div>
                        <div style="font-size:14px;font-weight:500;color:#202124;margin-bottom:8px;">Editor Font Preview</div>
                        <div id="editor-font-preview" style="padding:16px;background:#fff;border:1px solid #dadce0;border-radius:4px;font-family:monospace;font-size:14px;line-height:1.6;white-space:pre;">// JavaScript function example
function fibonacci(n) {
    if (n <= 1) return n;
    return fibonacci(n - 1) + fibonacci(n - 2);
}

const numbers = [1, 2, 3, 4, 5];
const doubled = numbers.map(x => x * 2);
console.log(doubled); // [2, 4, 6, 8, 10]</div>
                    </div>
                    
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;">
                        <div style="font-size:14px;font-weight:500;color:#202124;margin-bottom:12px;">Font Style</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                            <div>
                                <label style="font-size:13px;color:#5f6368;margin-bottom:4px;display:block;">Font Weight</label>
                                <select id="font-weight-select" style="width:100%;padding:8px;border:1px solid #dadce0;border-radius:4px;font-size:14px;background:#fff;">
                                    <option value="100">Thin (100)</option>
                                    <option value="200">Extra Light (200)</option>
                                    <option value="300">Light (300)</option>
                                    <option value="400" selected>Regular (400)</option>
                                    <option value="500">Medium (500)</option>
                                    <option value="600">Semi Bold (600)</option>
                                    <option value="700">Bold (700)</option>
                                    <option value="800">Extra Bold (800)</option>
                                    <option value="900">Black (900)</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:13px;color:#5f6368;margin-bottom:4px;display:block;">Font Style</label>
                                <select id="font-style-select" style="width:100%;padding:8px;border:1px solid #dadce0;border-radius:4px;font-size:14px;background:#fff;">
                                    <option value="normal" selected>Normal</option>
                                    <option value="italic">Italic</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top:12px;">
                            <label style="font-size:13px;color:#5f6368;margin-bottom:4px;display:block;">Line Height</label>
                            <input type="range" id="line-height-slider" min="1" max="3" step="0.1" value="1.6" style="width:100%;">
                            <div style="display:flex;justify-content:space-between;font-size:12px;color:#5f6368;">
                                <span>1.0</span>
                                <span id="line-height-display">1.6</span>
                                <span>3.0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;">
                        <div style="font-size:14px;font-weight:500;color:#202124;margin-bottom:12px;">Font Preview</div>
                        <div id="font-preview" style="padding:16px;background:#fff;border:1px solid #dadce0;border-radius:4px;font-size:14px;line-height:1.6;">
                            The quick brown fox jumps over the lazy dog.<br>
                            1234567890 !@#$%^&*()<br>
                            <span style="font-size:12px;">Small text preview</span><br>
                            <span style="font-size:18px;">Large text preview</span><br>
                            <span style="font-weight:bold;">Bold text preview</span><br>
                            <span style="font-style:italic;">Italic text preview</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Preview Settings -->
            <div class="settings-section" data-section="preview" style="display:none;padding:32px 48px;">
                <h2 style="margin:0 0 8px 0;font-size:24px;font-weight:400;color:#202124;">Preview</h2>
                <p style="margin:0 0 32px 0;color:#5f6368;font-size:14px;">Configure preview pane behavior and editing options</p>
                
                <div style="margin-bottom:32px;">
                    <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:500;color:#202124;">Preview Updates</h3>
                    
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;margin-bottom:16px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;">
                            <div>
                                <div style="font-size:14px;font-weight:500;color:#202124;margin-bottom:4px;">Live preview</div>
                                <div style="font-size:13px;color:#5f6368;">Update preview as you type</div>
                            </div>
                            <label class="settings-toggle" style="position:relative;display:inline-block;width:44px;height:24px;">
                                <input type="checkbox" id="live-preview" style="opacity:0;width:0;height:0;">
                                <span class="toggle-track" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:24px;"></span>
                                <span class="toggle-thumb" style="position:absolute;content:'';height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.4s;border-radius:50%;"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;margin-bottom:16px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;">
                            <div>
                                <div style="font-size:14px;font-weight:500;color:#202124;margin-bottom:4px;">Preview editing</div>
                                <div style="font-size:13px;color:#5f6368;">Allow editing directly in preview pane</div>
                            </div>
                            <label class="settings-toggle" style="position:relative;display:inline-block;width:44px;height:24px;">
                                <input type="checkbox" id="preview-editing" style="opacity:0;width:0;height:0;">
                                <span class="toggle-track" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:24px;"></span>
                                <span class="toggle-thumb" style="position:absolute;content:'';height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.4s;border-radius:50%;"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;">
                            <div>
                                <div style="font-size:14px;font-weight:500;color:#202124;margin-bottom:4px;">Word wrap</div>
                                <div style="font-size:13px;color:#5f6368;">Wrap long lines in the preview pane</div>
                            </div>
                            <label class="settings-toggle" style="position:relative;display:inline-block;width:44px;height:24px;">
                                <input type="checkbox" id="preview-word-wrap" style="opacity:0;width:0;height:0;">
                                <span class="toggle-track" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:24px;"></span>
                                <span class="toggle-thumb" style="position:absolute;content:'';height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.4s;border-radius:50%;"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Data & Privacy Settings -->
            <div class="settings-section" data-section="data" style="display:none;padding:32px 48px;">
                <h2 style="margin:0 0 8px 0;font-size:24px;font-weight:400;color:#202124;">Data & Privacy</h2>
                <p style="margin:0 0 32px 0;color:#5f6368;font-size:14px;">Manage your data and privacy settings</p>
                
                <div style="margin-bottom:32px;">
                    <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:500;color:#202124;">Data Management</h3>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">
                        <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;">
                            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                                <span class="material-symbols-outlined" style="font-size:20px;color:#1a73e8;">download</span>
                                <div style="font-size:14px;font-weight:500;color:#202124;">Export Settings</div>
                            </div>
                            <div style="font-size:13px;color:#5f6368;margin-bottom:12px;">Download your settings as JSON file</div>
                            <button id="export-settings" style="padding:8px 16px;background:#1a73e8;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:13px;font-weight:500;">Export</button>
                        </div>
                        
                        <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;">
                            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                                <span class="material-symbols-outlined" style="font-size:20px;color:#34a853;">upload</span>
                                <div style="font-size:14px;font-weight:500;color:#202124;">Import Settings</div>
                            </div>
                            <div style="font-size:13px;color:#5f6368;margin-bottom:12px;">Load settings from JSON file</div>
                            <button id="import-settings" style="padding:8px 16px;background:#34a853;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:13px;font-weight:500;">Import</button>
                        </div>
                    </div>
                    
                                        
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;margin-bottom:16px;">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                            <span class="material-symbols-outlined" style="font-size:20px;color:#ea4335;">delete</span>
                            <div style="font-size:14px;font-weight:500;color:#202124;">Clear Search History</div>
                        </div>
                        <div style="font-size:13px;color:#5f6368;margin-bottom:12px;">Clear all recent search history from find/replace</div>
                        <button id="clear-search-history" style="padding:8px 16px;background:#ea4335;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:13px;font-weight:500;">Clear History</button>
                    </div>
                    
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                            <span class="material-symbols-outlined" style="font-size:20px;color:#ea4335;">refresh</span>
                            <div style="font-size:14px;font-weight:500;color:#202124;">Reset to Defaults</div>
                        </div>
                        <div style="font-size:13px;color:#5f6368;margin-bottom:12px;">Restore all settings to default values</div>
                        <button id="reset-settings" style="padding:8px 16px;background:#ea4335;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:13px;font-weight:500;">Reset</button>
                    </div>
                </div>
                
                <div style="margin-bottom:32px;">
                    <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:500;color:#202124;">Save Location</h3>
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;">
                        <div style="font-size:14px;font-weight:500;color:#202124;margin-bottom:8px;">Default save location</div>
                        <select id="save-location" style="width:100%;padding:8px;border:1px solid #dadce0;border-radius:4px;font-size:14px;background:#fff;">
                            <option value="default">Default (Downloads folder)</option>
                            <option value="custom">Custom (Choose location)</option>
                        </select>
                        <div style="font-size:13px;color:#5f6368;margin-top:8px;">Choose where files are saved when using Save As</div>
                    </div>
                </div>
            </div>
            
            <!-- Extensions Settings -->
            <div class="settings-section" data-section="extensions" style="display:none;padding:32px 48px;">
                <h2 style="margin:0 0 8px 0;font-size:24px;font-weight:400;color:#202124;">Extensions</h2>
                <p style="margin:0 0 32px 0;color:#5f6368;font-size:14px;">Manage extensions and their permissions</p>
                
                <!-- Current Mode Display (Beta) -->
                <div id="current-mode-display" style="background:linear-gradient(135deg, rgba(0,120,212,0.08) 0%, rgba(102,51,153,0.08) 100%);border:1px solid rgba(0,120,212,0.2);border-radius:8px;padding:20px;margin-bottom:32px;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <span class="material-symbols-outlined" id="mode-icon" style="font-size:32px;color:#0078d4;">settings</span>
                            <div>
                                <div style="font-size:14px;font-weight:600;color:#202124;margin-bottom:4px;">Current Mode: <span id="mode-name-display">Default</span></div>
                                <div style="font-size:12px;color:#5f6368;" id="mode-description-display">All extensions enabled</div>
                            </div>
                        </div>
                        <button id="reset-mode-btn" style="padding:8px 16px;background:#0078d4;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;transition:background 0.2s;" onmouseover="this.style.background='#005a9e'" onmouseout="this.style.background='#0078d4'">Change Mode</button>
                    </div>
                    <div style="font-size:11px;color:#f57c00;display:flex;align-items:center;gap:6px;">
                        <span class="material-symbols-outlined" style="font-size:16px;">science</span>
                        <span>BETA: Mode selection helps optimize extensions for your use case</span>
                    </div>
                </div>
                
                <div style="margin-bottom:32px;">
                    <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:500;color:#202124;">Extension Permissions</h3>
                    
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;margin-bottom:16px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;">
                            <div>
                                <div style="font-size:14px;font-weight:500;color:#202124;margin-bottom:4px;">Allow file system access</div>
                                <div style="font-size:13px;color:#5f6368;">Allow extensions to read and write files on your device</div>
                            </div>
                            <label class="settings-toggle" style="position:relative;display:inline-block;width:44px;height:24px;">
                                <input type="checkbox" id="ext-file-access" style="opacity:0;width:0;height:0;">
                                <span class="toggle-track" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:24px;"></span>
                                <span class="toggle-thumb" style="position:absolute;content:'';height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.4s;border-radius:50%;"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;margin-bottom:16px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;">
                            <div>
                                <div style="font-size:14px;font-weight:500;color:#202124;margin-bottom:4px;">Allow network access</div>
                                <div style="font-size:13px;color:#5f6368;">Allow extensions to make network requests and access external APIs</div>
                            </div>
                            <label class="settings-toggle" style="position:relative;display:inline-block;width:44px;height:24px;">
                                <input type="checkbox" id="ext-network-access" style="opacity:0;width:0;height:0;">
                                <span class="toggle-track" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:24px;"></span>
                                <span class="toggle-thumb" style="position:absolute;content:'';height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.4s;border-radius:50%;"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;margin-bottom:16px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;">
                            <div>
                                <div style="font-size:14px;font-weight:500;color:#202124;margin-bottom:4px;">Allow clipboard access</div>
                                <div style="font-size:13px;color:#5f6368;">Allow extensions to read and write to the clipboard</div>
                            </div>
                            <label class="settings-toggle" style="position:relative;display:inline-block;width:44px;height:24px;">
                                <input type="checkbox" id="ext-clipboard-access" style="opacity:0;width:0;height:0;">
                                <span class="toggle-track" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:24px;"></span>
                                <span class="toggle-thumb" style="position:absolute;content:'';height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.4s;border-radius:50%;"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;margin-bottom:16px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;">
                            <div>
                                <div style="font-size:14px;font-weight:500;color:#202124;margin-bottom:4px;">Allow theme modifications</div>
                                <div style="font-size:13px;color:#5f6368;">Allow extensions to modify the editor theme and appearance</div>
                            </div>
                            <label class="settings-toggle" style="position:relative;display:inline-block;width:44px;height:24px;">
                                <input type="checkbox" id="ext-theme-access" style="opacity:0;width:0;height:0;">
                                <span class="toggle-track" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:24px;"></span>
                                <span class="toggle-thumb" style="position:absolute;content:'';height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.4s;border-radius:50%;"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom:32px;">
                    <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:500;color:#202124;">Extension Management</h3>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">
                        <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;">
                            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                                <span class="material-symbols-outlined" style="font-size:20px;color:#1a73e8;">extension</span>
                                <div style="font-size:14px;font-weight:500;color:#202124;">Browse Extensions</div>
                            </div>
                            <div style="font-size:13px;color:#5f6368;margin-bottom:12px;">Open the extensions manager to browse and install extensions</div>
                            <button id="browse-extensions" style="padding:8px 16px;background:#1a73e8;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:13px;font-weight:500;">Browse</button>
                        </div>
                        
                        <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;">
                            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                                <span class="material-symbols-outlined" style="font-size:20px;color:#ea4335;">delete</span>
                                <div style="font-size:14px;font-weight:500;color:#202124;">Clear Extension Data</div>
                            </div>
                            <div style="font-size:13px;color:#5f6368;margin-bottom:12px;">Remove all extensions and their stored data</div>
                            <button id="clear-extensions" style="padding:8px 16px;background:#ea4335;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:13px;font-weight:500;">Clear All</button>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:500;color:#202124;">Security Settings</h3>
                    
                    <div style="background:#fff3e0;border:1px solid #ff9800;border-radius:8px;padding:16px;">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                            <span class="material-symbols-outlined" style="font-size:20px;color:#f57c00;">warning</span>
                            <div style="font-size:14px;font-weight:500;color:#202124;">Extension Security</div>
                        </div>
                        <div style="font-size:13px;color:#5f6368;line-height:1.5;">
                            Only install extensions from trusted sources. Extensions can access sensitive data and modify application behavior. Review permissions carefully before installing.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- About Section -->
            <div class="settings-section" data-section="about" style="display:none;padding:32px 48px;">
                <h2 style="margin:0 0 8px 0;font-size:24px;font-weight:400;color:#202124;">About Lancer Notes</h2>
                <p style="margin:0 0 32px 0;color:#5f6368;font-size:14px;">Version information and application details</p>
                
                <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:24px;text-align:center;">
                    <div style="font-size:48px;margin-bottom:16px;">📝</div>
                    <h3 style="margin:0 0 8px 0;font-size:20px;font-weight:500;color:#202124;">Lancer Notes</h3>
                    <div style="font-size:16px;color:#5f6368;margin-bottom:16px;">Version 2.2</div>
                    <div style="font-size:14px;color:#5f6368;line-height:1.5;">
                        A modern markdown editor designed for students and educational use.<br>
                        Built with HTML, CSS, and JavaScript.<br>
                        © 2024 Lancer Notes Project
                    </div>
                </div>
                
                <div style="background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;padding:16px;margin-top:24px;">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                        <span class="material-symbols-outlined" style="font-size:20px;color:#fbbc04;">system_update</span>
                        <div style="font-size:14px;font-weight:500;color:#202124;">Check for Updates</div>
                    </div>
                    <div style="font-size:13px;color:#5f6368;margin-bottom:12px;">Check for the latest version of Lancer Notes</div>
                    <button id="btn-update-check" style="padding:8px 16px;background:#fbbc04;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:13px;font-weight:500;">Check Updates</button>
                    <div id="update-status" style="margin-top:12px;padding:12px;border-radius:4px;font-size:13px;display:none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Extensions Dialog -->
<div id="extensions-dialog" style="display:none;position:fixed;top:5vh;left:50%;transform:translateX(-50%);width:80vw;max-width:900px;height:85vh;z-index:130000;background:rgba(255,255,255,0.95);backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px);border:1px solid rgba(0,0,0,0.06);box-shadow:0 16px 32px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.5) inset;border-radius:8px;overflow:hidden;">
    <div style="background:rgba(0,120,212,0.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-radius:8px 8px 0 0;box-shadow:0 1px 0 rgba(255,255,255,0.2) inset;">
        <span style="font-weight:bold;">Extensions Manager (Beta)</span>
        <button id="extensions-close" class="close-btn" title="Close" style="color:#fff;font-size:20px;">&times;</button>
    </div>
    <div style="display:flex;height:calc(100% - 44px);">
        <!-- Sidebar with extension categories -->
        <div style="width:200px;background:#f8f9fa;border-right:1px solid #e0e0e0;padding:16px;overflow-y:auto;">
            <h3 style="font-size:14px;font-weight:600;color:#007acc;margin-bottom:12px;text-transform:uppercase;">Categories</h3>
            <div class="extension-category" data-category="all" style="padding:8px 12px;margin-bottom:4px;cursor:pointer;border-radius:4px;background:#0078d4;color:#fff;font-size:13px;">All Extensions</div>
            <div class="extension-category" data-category="formatting" style="padding:8px 12px;margin-bottom:4px;cursor:pointer;border-radius:4px;font-size:13px;color:#333;">Formatting</div>
            <div class="extension-category" data-category="productivity" style="padding:8px 12px;margin-bottom:4px;cursor:pointer;border-radius:4px;font-size:13px;color:#333;">Productivity</div>
            <div class="extension-category" data-category="themes" style="padding:8px 12px;margin-bottom:4px;cursor:pointer;border-radius:4px;font-size:13px;color:#333;">Themes</div>
            <div class="extension-category" data-category="export" style="padding:8px 12px;margin-bottom:4px;cursor:pointer;border-radius:4px;font-size:13px;color:#333;">Export</div>
        </div>
        
        <!-- Main content area -->
        <div style="flex:1;padding:20px;overflow-y:auto;">
            <div style="margin-bottom:20px;">
                <h2 style="font-size:20px;margin-bottom:8px;color:#1a1a1a;">Available Extensions</h2>
                <p style="color:#666;font-size:14px;margin-bottom:16px;">Extend Lancer Notes with custom functionality. Extensions are currently in beta.</p>
            </div>
            
            <div id="extensions-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;">
                <!-- Extension cards will be dynamically inserted here -->
                <div class="extension-card" data-category="formatting">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <span class="material-symbols-outlined" style="font-size:32px;color:#0078d4;">palette</span>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">Syntax Highlighter <span id="ext-syntax-installed-badge" style="display:inline-block;font-size:10px;background:#4caf50;color:#fff;padding:2px 6px;border-radius:3px;font-weight:normal;margin-left:6px;">Installed</span></h4>
                            <span style="font-size:11px;background:#e3f2fd;color:#1565c0;padding:2px 6px;border-radius:3px;">Formatting</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">Advanced syntax highlighting for code blocks with multiple language support.</p>
                    <div style="display:flex;gap:8px;">
                        <button id="ext-syntax-uninstall-btn" class="extension-action-btn" data-extension="syntax-highlighter" style="flex:1;padding:6px 12px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Uninstall</button>
                        <button id="ext-syntax-install-btn" class="extension-action-btn" data-extension="syntax-highlighter" style="display:none;flex:1;padding:6px 12px;background:#28a745;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Install</button>
                    </div>
                </div>
                
                <div class="extension-card" data-category="export">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <i class="fa-solid fa-file-pdf" style="font-size:32px;color:#0078d4;"></i>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">PDF Exporter</h4>
                            <span style="font-size:11px;background:#fff3e0;color:#e65100;padding:2px 6px;border-radius:3px;">Export</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">Export your markdown documents to professionally formatted PDF files.</p>
                    <button class="extension-install-btn" data-extension="pdf-exporter" style="width:100%;padding:6px 12px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Coming Soon</button>
                </div>
                
                <div class="extension-card" data-category="productivity">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <i class="bi bi-stars" style="font-size:32px;color:#0078d4;"></i>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">AI Assistant</h4>
                            <span style="font-size:11px;background:#f3e5f5;color:#6a1b9a;padding:2px 6px;border-radius:3px;">Productivity</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">AI-powered writing assistance, grammar checking, and content suggestions.</p>
                    <button class="extension-install-btn" data-extension="ai-assistant" style="width:100%;padding:6px 12px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Coming Soon</button>
                </div>
                
                <div class="extension-card" data-category="themes">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <i class="fa-solid fa-palette" style="font-size:32px;color:#0078d4;"></i>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">Custom Themes</h4>
                            <span style="font-size:11px;background:#e8f5e9;color:#2e7d32;padding:2px 6px;border-radius:3px;">Themes</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">Customize the editor appearance with community-created theme packs.</p>
                    <button class="extension-install-btn" data-extension="custom-themes" style="width:100%;padding:6px 12px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Coming Soon</button>
                </div>
                
                <div class="extension-card" data-category="productivity">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <i class="bi bi-check2-circle" style="font-size:32px;color:#0078d4;"></i>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">Spell Checker <span id="ext-spell-installed-badge" style="display:inline-block;font-size:10px;background:#4caf50;color:#fff;padding:2px 6px;border-radius:3px;font-weight:normal;margin-left:6px;">Installed</span></h4>
                            <span style="font-size:11px;background:#f3e5f5;color:#6a1b9a;padding:2px 6px;border-radius:3px;">Productivity</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">Real-time spell checking with multiple language dictionaries.</p>
                    <div style="display:flex;gap:8px;">
                        <button id="ext-spell-uninstall-btn" class="extension-action-btn" data-extension="spell-checker" style="flex:1;padding:6px 12px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Uninstall</button>
                        <button id="ext-spell-install-btn" class="extension-action-btn" data-extension="spell-checker" style="display:none;flex:1;padding:6px 12px;background:#28a745;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Install</button>
                    </div>
                </div>
                
                <div class="extension-card" data-category="formatting">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <span class="material-symbols-outlined" style="font-size:32px;color:#0078d4;">data_object</span>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">Diagram Support</h4>
                            <span style="font-size:11px;background:#e3f2fd;color:#1565c0;padding:2px 6px;border-radius:3px;">Formatting</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">Create flowcharts, diagrams, and charts using Mermaid syntax.</p>
                    <button class="extension-install-btn" data-extension="diagram-support" style="width:100%;padding:6px 12px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Coming Soon</button>
                </div>
                
                <div class="extension-card" data-category="formatting" id="extended-markdown-card">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <span class="material-symbols-outlined" style="font-size:32px;color:#0078d4;">description</span>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">Extended Markdown</h4>
                            <span style="font-size:11px;background:#e3f2fd;color:#1565c0;padding:2px 6px;border-radius:3px;">Formatting</span>
                            <span id="ext-md-installed-badge" style="display:inline-block;font-size:11px;background:#4caf50;color:#fff;padding:2px 6px;border-radius:3px;margin-left:4px;">Installed</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">Enhanced markdown features including task lists, definition lists, footnotes, and more advanced syntax.</p>
                    <div style="display:flex;gap:8px;">
                        <button id="ext-md-uninstall-btn" class="extension-action-btn" data-extension="extended-markdown" style="flex:1;padding:6px 12px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Uninstall</button>
                        <button id="ext-md-install-btn" class="extension-action-btn" data-extension="extended-markdown" style="display:none;flex:1;padding:6px 12px;background:#28a745;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Install</button>
                    </div>
                </div>
                
                <div class="extension-card" data-category="productivity">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <i class="fa-solid fa-pen-fancy" style="font-size:32px;color:#0078d4;"></i>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">Ink</h4>
                            <span style="font-size:11px;background:#f3e5f5;color:#6a1b9a;padding:2px 6px;border-radius:3px;">Productivity</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">Digital ink support for handwriting and sketching directly in your documents with stylus or touch input.</p>
                    <button class="extension-install-btn" data-extension="ink" style="width:100%;padding:6px 12px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Coming Soon</button>
                </div>
                
                <div class="extension-card" data-category="formatting">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <i class="fa-brands fa-github" style="font-size:32px;color:#0078d4;"></i>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">GitHub Extended Markdown</h4>
                            <span style="font-size:11px;background:#e3f2fd;color:#1565c0;padding:2px 6px;border-radius:3px;">Formatting</span>
                            <span id="ext-gfm-installed-badge" style="display:inline-block;font-size:11px;background:#4caf50;color:#fff;padding:2px 6px;border-radius:3px;margin-left:4px;">Installed</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">GitHub Flavored Markdown with tables, strikethrough, task lists, and automatic URL linking. Perfect for README files and technical documentation.</p>
                    <div style="display:flex;gap:8px;">
                        <button id="ext-gfm-uninstall-btn" class="extension-action-btn" data-extension="gfm" style="flex:1;padding:6px 12px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Uninstall</button>
                        <button id="ext-gfm-install-btn" class="extension-action-btn" data-extension="gfm" style="display:none;flex:1;padding:6px 12px;background:#28a745;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Install</button>
                    </div>
                </div>
                
                <div class="extension-card" data-category="formatting">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <span class="material-symbols-outlined" style="font-size:32px;color:#0078d4;">table_chart</span>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">Table Formatter</h4>
                            <span style="font-size:11px;background:#e3f2fd;color:#1565c0;padding:2px 6px;border-radius:3px;">Formatting</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">Auto-format and beautify markdown tables with proper alignment and spacing.</p>
                    <button class="extension-install-btn" data-extension="table-formatter" style="width:100%;padding:6px 12px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Coming Soon</button>
                </div>
                
                <div class="extension-card" data-category="productivity">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <i class="fa-solid fa-bolt" style="font-size:32px;color:#0078d4;"></i>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">Emmet</h4>
                            <span style="font-size:11px;background:#f3e5f5;color:#6a1b9a;padding:2px 6px;border-radius:3px;">Productivity</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">Fast HTML/CSS abbreviation expansion. Write div.container>ul>li*3 and expand it instantly.</p>
                    <button class="extension-install-btn" data-extension="emmet" style="width:100%;padding:6px 12px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Coming Soon</button>
                </div>
                
                <div class="extension-card" data-category="formatting">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <i class="bi bi-brush" style="font-size:32px;color:#007acc;"></i>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">Prettier</h4>
                            <span style="font-size:11px;background:#e3f2fd;color:#1565c0;padding:2px 6px;border-radius:3px;">Formatting</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">Opinionated code formatter for JavaScript, HTML, CSS, and Markdown with consistent style.</p>
                    <button class="extension-install-btn" data-extension="prettier" style="width:100%;padding:6px 12px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Coming Soon</button>
                </div>
                
                <div class="extension-card" data-category="productivity">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <i class="fa-solid fa-bug" style="font-size:32px;color:#007acc;"></i>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">ESLint</h4>
                            <span style="font-size:11px;background:#f3e5f5;color:#6a1b9a;padding:2px 6px;border-radius:3px;">Productivity</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">JavaScript linter to identify and fix problems in your code. Enforce code quality and consistency.</p>
                    <button class="extension-install-btn" data-extension="eslint" style="width:100%;padding:6px 12px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Coming Soon</button>
                </div>
                
                <div class="extension-card" data-category="productivity">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <i class="bi bi-code-slash" style="font-size:32px;color:#007acc;"></i>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">Code Snippets</h4>
                            <span style="font-size:11px;background:#f3e5f5;color:#6a1b9a;padding:2px 6px;border-radius:3px;">Productivity</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">Quick access to common code snippets for JavaScript, HTML, CSS, and more. Boost productivity.</p>
                    <button class="extension-install-btn" data-extension="code-snippets" style="width:100%;padding:6px 12px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Coming Soon</button>
                </div>
                
                <div class="extension-card" data-category="formatting">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <i class="fa-solid fa-droplet" style="font-size:32px;color:#007acc;"></i>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">Color Picker</h4>
                            <span style="font-size:11px;background:#e3f2fd;color:#1565c0;padding:2px 6px;border-radius:3px;">Formatting</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">Visual color picker for CSS and HTML. Pick colors with a palette and get hex, RGB, or HSL values.</p>
                    <button class="extension-install-btn" data-extension="color-picker" style="width:100%;padding:6px 12px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Coming Soon</button>
                </div>
                
                <div class="extension-card" data-category="formatting">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <i class="bi bi-tags" style="font-size:32px;color:#007acc;"></i>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">Auto Close Tags</h4>
                            <span style="font-size:11px;background:#e3f2fd;color:#1565c0;padding:2px 6px;border-radius:3px;">Formatting</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">Automatically close HTML and XML tags when you type the closing bracket. Saves time and reduces errors.</p>
                    <button class="extension-install-btn" data-extension="auto-close-tags" style="width:100%;padding:6px 12px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Coming Soon</button>
                </div>
                
                <div class="extension-card" data-category="formatting">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <i class="fa-solid fa-brackets-curly" style="font-size:32px;color:#007acc;"></i>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">Bracket Colorizer</h4>
                            <span style="font-size:11px;background:#e3f2fd;color:#1565c0;padding:2px 6px;border-radius:3px;">Formatting</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">Color-code matching brackets to easily identify nested code blocks and improve readability.</p>
                    <button class="extension-install-btn" data-extension="bracket-colorizer" style="width:100%;padding:6px 12px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Coming Soon</button>
                </div>
                
                <div class="extension-card" data-category="export">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <i class="bi bi-file-code" style="font-size:32px;color:#007acc;"></i>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">HTML Exporter</h4>
                            <span style="font-size:11px;background:#fff3e0;color:#e65100;padding:2px 6px;border-radius:3px;">Export</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">Export markdown to standalone HTML files with embedded CSS for sharing and publishing.</p>
                    <button class="extension-install-btn" data-extension="html-exporter" style="width:100%;padding:6px 12px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Coming Soon</button>
                </div>
                
                <div class="extension-card" data-category="productivity">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <i class="fa-solid fa-list-ol" style="font-size:32px;color:#007acc;"></i>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">Markdown TOC</h4>
                            <span style="font-size:11px;background:#f3e5f5;color:#6a1b9a;padding:2px 6px;border-radius:3px;">Productivity</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">Generate table of contents from document headings. Keep it updated automatically as you edit.</p>
                    <button class="extension-install-btn" data-extension="markdown-toc" style="width:100%;padding:6px 12px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Coming Soon</button>
                </div>
                
                <div class="extension-card" data-category="productivity">
                    <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px;">
                        <i class="bi bi-link-45deg" style="font-size:32px;color:#007acc;"></i>
                        <div style="flex:1;">
                            <h4 style="margin:0 0 4px 0;font-size:15px;color:#1a1a1a;">Link Checker</h4>
                            <span style="font-size:11px;background:#f3e5f5;color:#6a1b9a;padding:2px 6px;border-radius:3px;">Productivity</span>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px;">Validate all links in your document and identify broken or unreachable URLs automatically.</p>
                    <button class="extension-install-btn" data-extension="link-checker" style="width:100%;padding:6px 12px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Coming Soon</button>
                </div>
            </div>
            
            <div style="margin-top:30px;padding:16px;background:#fff3cd;border:1px solid #ffc107;border-radius:6px;">
                <p style="font-size:13px;color:#856404;margin:0;"><strong>⚠️ Beta Notice:</strong> The extensions system is currently in development. Extension installation and management features will be available in future updates. Stay tuned for the Lancer25 event on 11.11.25!</p>
            </div>
        </div>
    </div>
</div>

<!-- Custom Context Menu -->
<style>
/* Context Menu Styles */
.context-menu-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    cursor: pointer;
    transition: background 0.2s;
    gap: 8px;
    font-size: 13px;
}

.context-menu-separator {
    height: 1px;
    background: #e0e0e0;
    margin: 4px 0;
}

.context-menu-item:hover {
    background: #f0f0f0;
    color: #333;
}

[data-theme="dark"] .context-menu-item:hover {
    background: #3a3a3a;
    color: #fff;
}

[data-theme="dark"] #context-menu,
[data-theme="dark"] #context-menu-extended {
    background: #252526;
    border-color: #454545;
    color: #fff;
}

[data-theme="dark"] .context-menu-separator {
    border-color: #454545;
}

.context-menu-item .context-menu-shortcut {
    color: #888;
    margin-left: auto;
    padding-left: 16px;
    font-size: 11px;
}
</style>

<div id="context-menu" style="display:none;position:fixed;z-index:10000;background:#fff;border:1px solid #ccc;border-radius:4px;box-shadow:0 2px 10px rgba(0,0,0,0.15);min-width:200px;padding:4px 0;font-size:13px;">
    <div class="context-menu-item" data-action="cut">
        <span class="material-symbols-outlined" style="font-size:16px;">content_cut</span>
        <span>Cut</span>
        <span class="context-menu-shortcut">Ctrl+X</span>
    </div>
    <div class="context-menu-item" data-action="copy">
        <span class="material-symbols-outlined" style="font-size:16px;">content_copy</span>
        <span>Copy</span>
        <span class="context-menu-shortcut">Ctrl+C</span>
    </div>
    <div class="context-menu-item" data-action="paste">
        <span class="material-symbols-outlined" style="font-size:16px;">content_paste</span>
        <span>Paste</span>
        <span class="context-menu-shortcut">Ctrl+V</span>
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" data-action="selectAll">
        <span class="material-symbols-outlined" style="font-size:16px;">select_all</span>
        <span>Select All</span>
        <span class="context-menu-shortcut">Ctrl+A</span>
    </div>
    <div class="context-menu-item" data-action="print">
        <span class="material-symbols-outlined" style="font-size:16px;">print</span>
        <span>Print…</span>
        <span class="context-menu-shortcut">Ctrl+P</span>
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" data-action="bold">
        <span class="material-symbols-outlined" style="font-size:16px;">format_bold</span>
        <span>Bold</span>
        <span class="context-menu-shortcut">Ctrl+B</span>
    </div>
    <div class="context-menu-item" data-action="italic">
        <span class="material-symbols-outlined" style="font-size:16px;">format_italic</span>
        <span>Italic</span>
        <span class="context-menu-shortcut">Ctrl+I</span>
    </div>
    <div class="context-menu-item" data-action="code">
        <span class="material-symbols-outlined" style="font-size:16px;">code</span>
        <span>Inline Code</span>
        <span class="context-menu-shortcut">Ctrl+`</span>
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" data-action="link">
        <span class="material-symbols-outlined" style="font-size:16px;">link</span>
        <span>Insert Link</span>
        <span class="context-menu-shortcut">Ctrl+K</span>
    </div>
    <div class="context-menu-item" data-action="image">
        <span class="material-symbols-outlined" style="font-size:16px;">image</span>
        <span>Insert Image</span>
        <span class="context-menu-shortcut">Ctrl+Shift+I</span>
    </div>
    <div class="context-menu-separator table-operations" style="display:none"></div>
    <div class="context-menu-item table-operations" data-action="addCell" style="display:none">
        <span class="material-symbols-outlined" style="font-size:16px;">add</span>
        <span>Add Cell</span>
        <span class="context-menu-shortcut">Ctrl+.</span>
    </div>
    <div class="context-menu-item table-operations" data-action="removeCell" style="display:none">
        <span class="material-symbols-outlined" style="font-size:16px;">remove</span>
        <span>Remove Cell</span>
        <span class="context-menu-shortcut">Ctrl+Del</span>
    </div>
    <!-- 'More Table Options' removed per user request -->
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" data-action="showMore">
        <span class="material-symbols-outlined" style="font-size:16px;">more_horiz</span>
        <span>Show more options</span>
        <span class="context-menu-shortcut">▶</span>
    </div>
</div>

<!-- Table options menu removed per user request -->

<!-- Extended Context Menu (Show More Options) - Browser-like options -->
<div id="context-menu-extended" style="display:none;position:fixed;z-index:10001;background:#fff;border:1px solid #ccc;border-radius:4px;box-shadow:0 2px 10px rgba(0,0,0,0.15);min-width:220px;padding:4px 0;font-size:13px;">
    <div class="context-menu-item" data-action="back">
        <span class="material-symbols-outlined" style="font-size:16px;">arrow_back</span>
        <span>Back</span>
        <span class="context-menu-shortcut">Alt+←</span>
    </div>
    <div class="context-menu-item" data-action="forward">
        <span class="material-symbols-outlined" style="font-size:16px;">arrow_forward</span>
        <span>Forward</span>
        <span class="context-menu-shortcut">Alt+→</span>
    </div>
    <div class="context-menu-item" data-action="reload">
        <span class="material-symbols-outlined" style="font-size:16px;">refresh</span>
        <span>Reload</span>
        <span class="context-menu-shortcut">Ctrl+R</span>
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" data-action="saveAs">
        <span class="material-symbols-outlined" style="font-size:16px;">save</span>
        <span>Save as...</span>
        <span class="context-menu-shortcut">Ctrl+S</span>
    </div>
    <!-- Print context menu item removed temporarily -->
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" data-action="find">
        <span class="material-symbols-outlined" style="font-size:16px;">search</span>
        <span>Find...</span>
        <span class="context-menu-shortcut">Ctrl+F</span>
    </div>
    <div class="context-menu-item" data-action="undo">
        <span class="material-symbols-outlined" style="font-size:16px;">undo</span>
        <span>Undo</span>
        <span class="context-menu-shortcut">Ctrl+Z</span>
    </div>
    <div class="context-menu-item" data-action="redo">
        <span class="material-symbols-outlined" style="font-size:16px;">redo</span>
        <span>Redo</span>
        <span class="context-menu-shortcut">Ctrl+Y</span>
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" data-action="viewSource">
        <span class="material-symbols-outlined" style="font-size:16px;">code</span>
        <span>View page source</span>
        <span class="context-menu-shortcut">Ctrl+U</span>
    </div>
    <div class="context-menu-item" data-action="inspect">
        <span class="material-symbols-outlined" style="font-size:16px;">bug_report</span>
        <span>Inspect</span>
        <span class="context-menu-shortcut">F12</span>
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" data-action="backToEditor" title="Back to editor">
        <span class="material-symbols-outlined" style="font-size:16px;">arrow_back</span>
        <span>Back to Editor</span>
        <span class="context-menu-shortcut">◀</span>
    </div>
</div>

<input type="file" id="file-input" class="hidden-file-input" accept=".md,.txt,.text" />

<script>
    // Minimal dark-mode styles for Find/Replace bar injected dynamically so layout isn't changed
    (function(){
        const css = `
        body.dark-mode #find-replace-bar { background: #181a1b !important; border-color: #444 !important; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4) !important; }
        body.dark-mode #find-replace-bar input { background: #101214 !important; color: #e0e0e0 !important; border: 1px solid #444 !important; }
        body.dark-mode #find-replace-bar select { background: #101214 !important; color: #e0e0e0 !important; border: 1px solid #444 !important; }
        body.dark-mode #find-replace-bar button#btn-find-prev,
        body.dark-mode #find-replace-bar button#btn-find-next,
        body.dark-mode #find-replace-bar button#btn-replace,
        body.dark-mode #find-replace-bar button#btn-replace-all { background:#23272a !important; color:#e0e0e0 !important; border:1px solid #444 !important; }
        body.dark-mode #find-replace-bar button#btn-find-prev:hover,
        body.dark-mode #find-replace-bar button#btn-find-next:hover,
        body.dark-mode #find-replace-bar button#btn-replace:hover,
        body.dark-mode #find-replace-bar button#btn-replace-all:hover { background:#2d3136 !important; border-color:#666 !important; }
        body.dark-mode #find-replace-bar label { color:#e0e0e0 !important; }
        body.dark-mode #find-replace-bar #match-count { color:#e0e0e0 !important; }
        body.dark-mode #image-cap-dialog { background: #181a1b; border-color: #444; }
        body.dark-mode #image-cap-dialog input { background: #101214; color:#e0e0e0; border:1px solid #444 }
        body.dark-mode #image-cap-dialog label { color:#e0e0e0; }
        body.dark-mode #image-cap-dialog button#image-cap-cancel,
        body.dark-mode #image-cap-dialog button#image-cap-ok { background:#23272a; color:#e0e0e0; border:1px solid #444 }
        body.dark-mode #image-cap-dialog button#image-cap-cancel:hover,
        body.dark-mode #image-cap-dialog button#image-cap-ok:hover { background:#2d3136; border-color:#666; }
        /* Highlight styles */
        .md-match { background: #fffb91; color: #111; padding:0 2px; border-radius:2px; }
        .md-match-current { background: #ffcf66; color:#111; padding:0 2px; border-radius:2px; }
        body.dark-mode .md-match { background:#3a3a2a; color:#fff }
        body.dark-mode .md-match-current { background:#5a4b1a; color:#fff }
        .find-transition { transition: background-color 180ms ease; }
    /* Flags dropdown styles */
    .flags-toggle { background:#eee;border:1px solid #ccc;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px }
    .flags-menu label { cursor:pointer }
    .patterns-dropdown .pattern-option { display:flex;justify-content:space-between;align-items:center;gap:12px; }
    .patterns-dropdown .pattern-option:hover { background:rgba(26,115,232,0.08); }
    .patterns-dropdown .pattern-option span { font-family:monospace; }
    body.dark-mode .flags-menu { background:#2b2b2b;border-color:#444;color:#ddd }
    body.dark-mode .flags-toggle { background:#2b2b2b;border-color:#444;color:#ddd }
    body.dark-mode .patterns-dropdown .pattern-option:hover { background:rgba(138,180,248,0.16); }
    body.dark-mode #link-image-dialog { background: #181a1b !important; border-color: #444 !important; box-shadow: 0 8px 32px rgba(0,0,0,0.4) !important; }
    body.dark-mode #link-image-dialog input { background: #101214 !important; color:#e0e0e0 !important; border:1px solid #444 !important }
    body.dark-mode #link-image-dialog label { color:#e0e0e0 !important; }
    body.dark-mode #link-image-dialog button#dialog-cancel,
    body.dark-mode #link-image-dialog button#dialog-ok { background:#23272a !important; color:#e0e0e0 !important; border:1px solid #444 !important; transition: all 0.2s !important; }
    body.dark-mode #link-image-dialog button#dialog-cancel:hover,
    body.dark-mode #link-image-dialog button#dialog-ok:hover { background:#2d3136 !important; border-color:#666 !important; }
    #popup-overlay { transition: background-color 0.3s; }
    body.dark-mode #popup-overlay { background: rgba(0, 0, 0, 0.5) !important; }
    body.dark-mode #custom-alert { background: #181a1b !important; border-color: #444 !important; box-shadow: 0 8px 32px rgba(0,0,0,0.4) !important; }
    body.dark-mode #custom-alert button#custom-alert-ok { background:#23272a !important; color:#e0e0e0 !important; border:1px solid #444 !important; transition: all 0.2s !important; }
    body.dark-mode #custom-alert button#custom-alert-ok:hover { background:#2d3136 !important; border-color:#666 !important; }
    body.dark-mode #help-popup, body.dark-mode #changelog-popup { background: #222; border-color: #444; }
    body.dark-mode #help-popup iframe, body.dark-mode #changelog-popup iframe { background: #222; color: #e0e0e0; }
    body.dark-mode #changelog-content { background: #101214 !important; color: #e0e0e0 !important; }
    /* Extensions dialog dark mode */
    body.dark-mode #extensions-dialog { background: #181a1b !important; border-color: #444 !important; }
    body.dark-mode #extensions-dialog > div > div:first-child { background: #181a1b !important; border-right-color: #444 !important; }
    body.dark-mode #extensions-dialog > div > div:last-child { background: #101214 !important; }
    body.dark-mode #extensions-dialog h2, body.dark-mode #extensions-dialog h3, body.dark-mode #extensions-dialog h4 { color: #e0e0e0 !important; }
    body.dark-mode #extensions-dialog p { color: #b0b0b0 !important; }
    body.dark-mode #extensions-dialog .extension-category { color: #e0e0e0 !important; background: #23272a !important; }
    body.dark-mode #extensions-dialog .extension-category[data-category="all"] { background: #005a9e !important; }
    body.dark-mode #extensions-dialog .extension-card { background: #23272a !important; border: 1px solid #444 !important; padding: 16px; border-radius: 8px; }
    body.dark-mode #extensions-dialog .extension-install-btn { background: #005a9e !important; color: #fff !important; }
    body.dark-mode #extensions-dialog .extension-install-btn:hover { background: #007acc !important; }
    body.dark-mode #extensions-dialog .extension-action-btn { opacity: 0.95; }
    body.dark-mode #extensions-dialog .extension-action-btn:hover { opacity: 1; }
    body.dark-mode #extensions-dialog #ext-md-installed-badge { background: #2e7d32 !important; }
    body.dark-mode #extensions-dialog #ext-syntax-installed-badge { background: #2e7d32 !important; }
    body.dark-mode #extensions-dialog #ext-spell-installed-badge { background: #2e7d32 !important; }
    body.dark-mode #extensions-dialog div[style*="background:#fff3cd"] { background: #2d2400 !important; border-color: #5a4a00 !important; }
    body.dark-mode #extensions-dialog div[style*="background:#fff3cd"] p { color: #ffc107 !important; }
    .extension-card { background: #f8f9fa; border: 1px solid #e0e0e0; padding: 16px; border-radius: 8px; transition: all 0.3s; }
    .extension-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
    .extension-category:hover { background: #e0e0e0 !important; }
    body.dark-mode .extension-category:hover { background: #2d3136 !important; }
    
    /* Syntax highlighting styles */
    pre[class*="language-"], code[class*="language-"] { 
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace; 
        font-size: 14px;
        line-height: 1.5;
        tab-size: 4;
    }
    pre[class*="language-"] { 
        padding: 1em; 
        margin: 0.5em 0; 
        overflow: auto;
        border-radius: 6px;
        background: #2d2d2d !important;
    }
    code[class*="language-"] {
        background: transparent;
    }
    /* Inline code styling */
    :not(pre) > code {
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.9em;
    }
    /* Dark mode adjustments for Prism */
    body.dark-mode pre[class*="language-"] {
        background: #1e1e1e !important;
        border: 1px solid #333;
    }
        `;
        const s = document.createElement('style');
        s.type = 'text/css';
        s.appendChild(document.createTextNode(css));
        document.head.appendChild(s);
    })();
    // Global variables for state management
    let editor = document.getElementById('editor');
    let preview = document.getElementById('preview');
    let currentFile = null;
    // When available, store the FileSystemFileHandle so we can overwrite the
    // original file on plain Save instead of forcing a download (modern browsers).
    let currentFileHandle = null;
    let undoStack = [];
    let redoStack = [];
    let undoTimer = null;
    const UNDO_STACK_LIMIT = 100;
    let lastUndoSaveTime = 0;
    let undoThrottleMs = 250; // Reduced throttle time for better responsiveness (v2.1.2)
    let lastUndoValue = '';
    let currentViewMode = 'split';
    const PRINT_SETTINGS_KEY = 'md-print-settings';
    const printState = {
        target: 'auto',
        orientation: 'portrait',
        includeMetadata: false,
        includePageNumbers: true,
        includeBackground: false,
        margin: 'default',
        selectedPrinter: 'browser-default',
        printers: []
    };
    let previewUpdateTimeout = null;
    let isUpdatingFromEditor = false;
    let isTogglingCheckbox = false;
    
    // Settings object from v2.2.2
    let settings = {
        autoSave: false,
        wordWrap: false,
        livePreview: true,
        previewEditing: true,
        defaultTheme: 'auto',
        fontSize: 14,
        compactMode: false,
        saveLocation: 'default',
        developerMode: false
    };
    
    // Version information
    const CURRENT_VERSION = '2.2.2';
    const GITHUB_RELEASES_API = 'https://api.github.com/repos/ObjectPresents/lancer-notes/releases/latest';
    
    // Local changelog HTML (structured with modern styling)
    const LOCAL_CHANGELOG_MD = `
<div class="tldr-card">
    <div class="tldr-title">TL;DR</div>
    <ul class="tldr-list">
        <li>Local, dark-mode-friendly changelog view with offline support</li>
        <li>Modern card layout with structured HTML (v2.1.2 → v2.1.4 styles)</li>
        <li>v2.2 scheduled for November 2025 • Lancer25 event on 11.11.25</li>
        <li>Undo/Redo history dropdown + 250ms throttle for smoother editing</li>
    </ul>
</div>
<div class="changelog-versions">
    <div class="version-item og-version">
        <div class="version-header">
            <span class="version-number">v2.2</span>
            <span class="version-date">November 2025 🚀</span>
        </div>
        <div class="version-content">
            <p><strong>Lancer25 Event Coming 11.11.25 - v2.2 Sneak Peak!</strong></p>
            <ul>
                <li>Added support for editing directly in preview pane</li>
                <li>Implemented real-time synchronization between editor and preview</li>
                <li>Enhanced markdown-to-HTML conversion for better editing experience</li>
                <li>Improved bidirectional editing capabilities</li>
                <li>Added basic table functionality</li>
                <li>Implemented automatic update checking system</li>
                <li>All features from v2.1.4, v2.1.3, v2.1.2 ported to v2.2:
                    <ul>
                        <li>Word wrap (beta) with toolbar button and keyboard shortcut</li>
                        <li>Image auto-resize feature with configurable maximum width</li>
                        <li>Heading rendering inside blockquotes</li>
                        <li>Unified popup styling with blue headers</li>
                        <li>Dark-mode scrollbars with color-scheme support</li>
                        <li>Centered Find/Replace dialog</li>
                        <li>Undo/Redo history dropdown on hover</li>
                        <li>Improved undo/redo system with 250ms throttle for reduced lag</li>
                        <li>Dark-mode styling for history dropdown</li>
                    </ul>
                </li>
            </ul>
            <p><strong>🎉 Lancer25 Event - 11.11.25</strong><br>Join us for the official Lancer25 event where v2.2 will be fully released with exclusive features and surprises!</p>
        </div>
    </div>
    
    <div class="version-item">
        <div class="version-header">
            <span class="version-number">v2.1.4</span>
            <span class="version-date">31.10.2025</span>
        </div>
        <div class="version-content">
            <p>UI consistency improvements across the app:</p>
            <ul>
                <li>Standardized toolbar buttons to a consistent icon + text pattern.</li>
                <li>Unified popup title bars with blue headers, close buttons, rounded corners, and consistent shadows.</li>
                <li>Redesigned Find/Replace as a centered dialog with header, improved spacing, and dark-mode support.</li>
                <li>Replaced image cap prompt with a proper Image Cap dialog (validation, persistence, Enter-to-confirm).</li>
                <li>Dark-mode scrollbars across browsers (added color-scheme hints and custom scrollbar styling).</li>
                <li>Bumped application version to v2.1.4.</li>
            </ul>
        </div>
    </div>
    
    <div class="version-item">
        <div class="version-header">
            <span class="version-number">v2.1.3</span>
            <span class="version-date">29.10.2025</span>
        </div>
        <div class="version-content">
            <p>Features and improvements in v2.1.3:</p>
            <ul>
                <li>Implemented heading rendering inside blockquotes so Markdown headings within ">" blocks render as proper HTML headings.</li>
                <li>Added "image from link" auto-resize option (dialog checkbox). When enabled, the editor measures the linked image client-side and inserts responsive &lt;img&gt; markup with a configurable maximum width (default: 800px). Runtime cap can be adjusted via the toolbar control; preferences are persisted to localStorage (keys: md-auto-resize-images, md-auto-resize-max). Toolbar control id: #btn-image-cap.</li>
                <li>Word wrap (beta) improvements and details:
                    <ul>
                        <li>Works in both the editor and the preview. Long words and URLs wrap at safe boundaries to avoid horizontal scrolling.</li>
                        <li>Code blocks use white-space: pre-wrap while preserving indentation; inline code wraps without breaking layout.</li>
                        <li>Blockquotes, lists, and table cells are hardened to wrap content cleanly without overflow.</li>
                        <li>Toggle via toolbar button (#btn-wordwrap) or keyboard shortcut (Ctrl+Alt+W / Ctrl+Shift+W).</li>
                        <li>Preference persists in localStorage under md-word-wrap.</li>
                        <li>Credits: feature made by LoserFan2020 with contributions from Phuc and Hung.</li>
                    </ul>
                </li>
                <li>Misc: reordered blockquote/header parsing so headings inside blockquotes render correctly, fixed related JavaScript and CSS syntax issues encountered during development, and applied small UX polish to dialogs and controls.</li>
            </ul>
        </div>
    </div>
    
    <div class="version-item">
        <div class="version-header">
            <span class="version-number">v2.1.2</span>
            <span class="version-date">26/10/2025</span>
        </div>
        <div class="version-content">
            <p>Small fixes and polish for v2.1.2:</p>
            <ul>
                <li>Fix dark-mode styling for the undo/redo history dropdown</li>
                <li>Keep history dropdown visible when hovering between the toolbar button and the menu</li>
                <li>Move changelogs to a local view and ensure the popup respects dark mode</li>
                <li>Improved undo/redo system with reduced lag (250ms throttle)</li>
                <li>Fixed changelog formatting and removed duplicate entries</li>
                <li>Renamed README.md to CHANGELOG.md for better organization</li>
                <li>Bumped application version to v2.1.2</li>
            </ul>
        </div>
    </div>
    
    <div class="version-item">
        <div class="version-header">
            <span class="version-number">v2.1.1</span>
            <span class="version-date">25/10/2025</span>
        </div>
        <div class="version-content">
            <p>No major features; maintenance and polish:</p>
            <ul>
                <li>Added "Check for Updates" feature</li>
            </ul>
        </div>
    </div>
    
    <div class="version-item">
        <div class="version-header">
            <span class="version-number">v2.1</span>
            <span class="version-date">23/10/2025</span>
        </div>
        <div class="version-content">
            <p>New editor features and quality-of-life improvements.</p>
            <ul>
                <li>HR, Task items, Table alignment, Subscript, Superscript, and more.</li>
            </ul>
        </div>
    </div>
    
    <div class="version-item">
        <div class="version-header">
            <span class="version-number">v2.0.5</span>
            <span class="version-date">01/10/2025</span>
        </div>
        <div class="version-content">
            <p>UI and layout updates; help/changelog layouts improved.</p>
            <ul>
                <li>Various dark-mode fixes.</li>
            </ul>
        </div>
    </div>
    
    <div class="version-item">
        <div class="version-header">
            <span class="version-number">v2.0.4</span>
            <span class="version-date">25/09/2025</span>
        </div>
        <div class="version-content">
            <ul>
                <li>Popup UI changed to be more modular and centered; escaping and list fixes.</li>
            </ul>
        </div>
    </div>
    
    <div class="version-item">
        <div class="version-header">
            <span class="version-number">v2.0.3</span>
            <span class="version-date">24/09/2025</span>
        </div>
        <div class="version-content">
            <ul>
                <li>Added regex search/replace with flags and preview highlighting.</li>
            </ul>
        </div>
    </div>
    
    <div class="version-item">
        <div class="version-header">
            <span class="version-number">v2.0.2</span>
            <span class="version-date">21/09/2025</span>
        </div>
        <div class="version-content">
            <ul>
                <li>Find and Replace support.</li>
            </ul>
        </div>
    </div>
    
    <div class="version-item">
        <div class="version-header">
            <span class="version-number">v2.0.1</span>
            <span class="version-date">19/09/2025</span>
        </div>
        <div class="version-content">
            <ul>
                <li>Added support for .txt files; fixed split-mode resize bug.</li>
            </ul>
        </div>
    </div>
    
    <div class="version-item">
        <div class="version-header">
            <span class="version-number">v2.0</span>
            <span class="version-date">18/09/2025</span>
        </div>
        <div class="version-content">
            <ul>
                <li>Major internal restructuring.</li>
            </ul>
        </div>
    </div>
    
    <div class="version-item">
        <div class="version-header">
            <span class="version-number">v1.2</span>
            <span class="version-date">17/09/2025</span>
        </div>
        <div class="version-content">
            <ul>
                <li>Fixed table formatting issues.</li>
            </ul>
        </div>
    </div>
    
    <div class="version-item">
        <div class="version-header">
            <span class="version-number">v1.1</span>
            <span class="version-date">16/09/2025</span>
        </div>
        <div class="version-content">
            <ul>
                <li>New icon design and minor bug fixes.</li>
            </ul>
        </div>
    </div>
    
    <div class="version-item">
        <div class="version-header">
            <span class="version-number">v1.0</span>
            <span class="version-date">14/01/2024</span>
        </div>
        <div class="version-content">
            <ul>
                <li>Original Markdown Editor (forked from Lancer Fan Club Forums).</li>
            </ul>
        </div>
    </div>
</div>`;

    // Check for updates function
    async function checkForUpdates() {
        const updateBtn = document.getElementById('btn-update-check');
        const statusDiv = document.getElementById('update-status');
        const originalText = updateBtn.innerHTML;
        
        // Show loading state
        updateBtn.innerHTML = '<span class="material-symbols-outlined">refresh</span> Checking...';
        updateBtn.disabled = true;
        
        // Show loading status
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#e3f2fd';
        statusDiv.style.border = '1px solid #2196f3';
        statusDiv.style.color = '#1976d2';
        statusDiv.innerHTML = '<div style="display:flex;align-items:center;gap:8px;"><span class="material-symbols-outlined">refresh</span> Checking for updates...</div>';
        
        try {
            const response = await fetch(GITHUB_RELEASES_API);
            if (!response.ok) {
                throw new Error('Failed to fetch release information');
            }
            
            const data = await response.json();
            const latestVersion = data.tag_name.replace('v', ''); // Remove 'v' prefix
            
            // Compare versions
            if (compareVersions(CURRENT_VERSION, latestVersion) < 0) {
                // Update available
                statusDiv.style.background = '#fff3e0';
                statusDiv.style.border = '1px solid #ff9800';
                statusDiv.style.color = '#f57c00';
                statusDiv.innerHTML = `
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                        <span class="material-symbols-outlined">system_update</span>
                        <strong>Update available!</strong>
                    </div>
                    <div style="margin-bottom:8px;">
                        Current version: v${CURRENT_VERSION}<br>
                        Latest version: v${latestVersion}
                    </div>
                    <button onclick="window.open('${data.html_url}', '_blank')" style="padding:6px 12px;background:#ff9800;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:500;">Download Update</button>
                `;
            } else {
                // No update available
                statusDiv.style.background = '#e8f5e8';
                statusDiv.style.border = '1px solid #4caf50';
                statusDiv.style.color = '#2e7d32';
                statusDiv.innerHTML = `
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span class="material-symbols-outlined">check_circle</span>
                        <div>
                            <strong>You're up to date!</strong><br>
                            Current version: v${CURRENT_VERSION}
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error checking for updates:', error);
            statusDiv.style.background = '#ffebee';
            statusDiv.style.border = '1px solid #f44336';
            statusDiv.style.color = '#c62828';
            statusDiv.innerHTML = `
                <div style="display:flex;align-items:center;gap:8px;">
                    <span class="material-symbols-outlined">error</span>
                    <div>
                        <strong>Failed to check for updates</strong><br>
                        Please check your internet connection and try again.
                    </div>
                </div>
            `;
        } finally {
            // Restore button state
            updateBtn.innerHTML = originalText;
            updateBtn.disabled = false;
        }
    }
    
    // Compare version strings (returns -1 if v1 < v2, 0 if equal, 1 if v1 > v2)
    function compareVersions(v1, v2) {
        const parts1 = v1.split('.').map(Number);
        const parts2 = v2.split('.').map(Number);
        
        const maxLength = Math.max(parts1.length, parts2.length);
        
        for (let i = 0; i < maxLength; i++) {
            const part1 = parts1[i] || 0;
            const part2 = parts2[i] || 0;
            
            if (part1 < part2) return -1;
            if (part1 > part2) return 1;
        }
        
        return 0;
    }

    // Toggle dark mode
    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        // Optionally persist mode
        if (document.body.classList.contains('dark-mode')) {
            localStorage.setItem('markdown-dark-mode', '1');
        } else {
            localStorage.removeItem('markdown-dark-mode');
        }
    }

    // First Boot Mode Selection (Beta Feature)
    function checkFirstBootMode() {
        try {
            // Check if user has already selected a mode or skipped
            const modeSelected = localStorage.getItem('lancer-mode-selected');
            
            if (!modeSelected) {
                // First boot - show mode selection dialog
                showModeSelectionDialog();
            }
        } catch (e) {
            console.warn('Could not check first boot mode:', e);
        }
    }

    function showModeSelectionDialog() {
        const dialog = document.getElementById('mode-selection-dialog');
        const overlay = document.getElementById('popup-overlay');
        const studentMode = document.getElementById('mode-student');
        const programmingMode = document.getElementById('mode-programming');
        const skipButton = document.getElementById('mode-skip');
        
        // Show dialog
        overlay.style.display = 'block';
        dialog.style.display = 'block';
        
        // Handle mode selection with visual feedback
        studentMode.addEventListener('click', function() {
            studentMode.classList.add('selected');
            programmingMode.classList.remove('selected');
            setTimeout(() => applyMode('student'), 200);
        });
        
        programmingMode.addEventListener('click', function() {
            programmingMode.classList.add('selected');
            studentMode.classList.remove('selected');
            setTimeout(() => applyMode('programming'), 200);
        });
        
        skipButton.addEventListener('click', function() {
            // Mark as skipped (use defaults - all extensions enabled)
            localStorage.setItem('lancer-mode-selected', 'skipped');
            hideDialog();
        });
        
        function hideDialog() {
            overlay.style.display = 'none';
            dialog.style.display = 'none';
        }
    }

    function applyMode(mode) {
        try {
            // Store the selected mode
            localStorage.setItem('lancer-mode-selected', mode);
            localStorage.setItem('lancer-mode', mode);
            
            if (mode === 'student') {
                // Student Mode Configuration (Beta)
                // Enable: Spell Checker, Extended Markdown (for basic markdown features)
                // Disable: Syntax Highlighter (not needed for essays/notes)
                localStorage.removeItem('ext-spell-checker'); // Enabled
                localStorage.removeItem('ext-extended-markdown'); // Enabled
                localStorage.setItem('ext-syntax-highlighter', 'disabled'); // Disabled
                
                // Hide dialog
                document.getElementById('popup-overlay').style.display = 'none';
                document.getElementById('mode-selection-dialog').style.display = 'none';
                
                // Update button visibility
                updateExtendedMarkdownButtons();
                
                // Show confirmation
                setTimeout(() => {
                    customAlert('Student mode activated! 📚\n\nOptimized for essays and notes:\n✓ Spell Checker enabled\n✓ Basic Markdown enabled\n✗ Syntax Highlighter disabled\n\nYou can always change extensions in Settings → Extensions.');
                }, 300);
                
            } else if (mode === 'programming') {
                // Programming Mode Configuration
                // Enable: Spell Checker, GitHub Flavored Markdown, Syntax Highlighter
                // Disable: Extended Markdown (use GFM instead)
                localStorage.removeItem('ext-spell-checker'); // Enabled
                localStorage.setItem('ext-extended-markdown', 'disabled'); // Disabled
                localStorage.removeItem('ext-gfm'); // Enable GitHub Flavored Markdown
                localStorage.removeItem('ext-syntax-highlighter'); // Enabled
                
                // Hide dialog
                document.getElementById('popup-overlay').style.display = 'none';
                document.getElementById('mode-selection-dialog').style.display = 'none';
                
                // Update button visibility
                updateExtendedMarkdownButtons();
                
                // Show confirmation
                setTimeout(() => {
                    customAlert('Programming mode activated! 💻\n\nOptimized for technical documentation:\n✓ Spell Checker enabled\n✓ GitHub Flavored Markdown enabled\n✓ Syntax highlighting enabled\n✗ Extended Markdown disabled\n\nPerfect for code documentation and technical writing!');
                }, 300);
            }
        } catch (e) {
            console.warn('Could not apply mode:', e);
            // Hide dialog anyway
            document.getElementById('popup-overlay').style.display = 'none';
            document.getElementById('mode-selection-dialog').style.display = 'none';
        }
    }

    // Update current mode display in settings
    function updateCurrentModeDisplay() {
        try {
            const currentMode = localStorage.getItem('lancer-mode') || 'default';
            const modeNameEl = document.getElementById('mode-name-display');
            const modeDescEl = document.getElementById('mode-description-display');
            const modeIconEl = document.getElementById('mode-icon');
            
            if (currentMode === 'student') {
                modeNameEl.textContent = 'Student 📚';
                modeDescEl.textContent = 'Optimized for essays and notes';
                modeIconEl.textContent = 'school';
                modeIconEl.style.color = '#4caf50';
            } else if (currentMode === 'programming') {
                modeNameEl.textContent = 'Programming 💻';
                modeDescEl.textContent = 'GitHub Flavored Markdown + Syntax Highlighting';
                modeIconEl.textContent = 'code';
                modeIconEl.style.color = '#0078d4';
            } else {
                modeNameEl.textContent = 'Default';
                modeDescEl.textContent = 'All extensions enabled';
                modeIconEl.textContent = 'settings';
                modeIconEl.style.color = '#0078d4';
            }
        } catch (e) {
            console.warn('Could not update mode display:', e);
        }
    }

    // Hide/show Extended Markdown buttons based on extension status
    function updateExtendedMarkdownButtons() {
        try {
            const isExtendedMarkdownEnabled = localStorage.getItem('ext-extended-markdown') !== 'disabled';
            const extendedButtons = [
                'btn-subscript',
                'btn-superscript', 
                'btn-footnote',
                'btn-deflist'
            ];
            
            extendedButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    if (isExtendedMarkdownEnabled) {
                        button.style.display = '';
                        button.disabled = false;
                    } else {
                        button.style.display = 'none';
                        button.disabled = true;
                    }
                }
            });
        } catch (e) {
            console.warn('Could not update Extended Markdown buttons:', e);
        }
    }

    // Reset mode selection (show mode dialog again)
    function resetModeSelection() {
        // Clear the mode selection flag
        localStorage.removeItem('lancer-mode-selected');
        
        // Close settings dialog
        closeSettings();
        
        // Show mode selection dialog
        setTimeout(() => {
            showModeSelectionDialog();
        }, 300);
    }

    // Initialize the editor
    function initEditor() {
        // Load settings from v2.2.2
        loadSettings();
        
        // Check and show mode selection dialog on first boot (Beta Feature)
        checkFirstBootMode();
        
        // Update Extended Markdown button visibility based on extension status
        updateExtendedMarkdownButtons();
        
        // Menu bar filtering for toolbar
        let currentMenuCategory = 'edit'; // Default: show edit toolbar groups
        
        function filterToolbar(category) {
            const toolbarGroups = document.querySelectorAll('.toolbar-group');
            
            if (category === 'all') {
                // Show all toolbar groups
                toolbarGroups.forEach(group => {
                    group.style.display = '';
                });
            } else {
                // Show only groups matching the category
                toolbarGroups.forEach(group => {
                    const groupCategory = group.getAttribute('data-category');
                    if (groupCategory === category) {
                        group.style.display = '';
                    } else {
                        group.style.display = 'none';
                    }
                });
            }
            
            currentMenuCategory = category;
        }
        
        // Menu item click handlers
        document.getElementById('menu-file').addEventListener('click', function() {
            filterToolbar('file');
            updateActiveMenu(this);
        });
        
        document.getElementById('menu-edit').addEventListener('click', function() {
            filterToolbar('edit');
            updateActiveMenu(this);
        });
        
        document.getElementById('menu-view').addEventListener('click', function() {
            filterToolbar('view');
            updateActiveMenu(this);
        });
        
        document.getElementById('menu-developer').addEventListener('click', function() {
            filterToolbar('developer');
            updateActiveMenu(this);
        });
        
        document.getElementById('menu-help').addEventListener('click', function() {
            filterToolbar('help');
            updateActiveMenu(this);
        });
        
        // Update active menu styling
        function updateActiveMenu(activeMenuItem) {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            activeMenuItem.classList.add('active');
        }
        
        // Set Edit as default active menu on load
        filterToolbar('edit');
        updateActiveMenu(document.getElementById('menu-edit'));
        
        // Restore saved view mode preference
        try {
            const savedViewMode = localStorage.getItem('md-view-mode');
            if (savedViewMode && (savedViewMode === 'split' || savedViewMode === 'editor' || savedViewMode === 'preview')) {
                setViewMode(savedViewMode);
            }
        } catch (e) {}
        
        // Keyboard shortcuts for view mode switching
        document.addEventListener('keydown', function(e) {
            // Ctrl+1 = Split View
            if (e.ctrlKey && e.key === '1') {
                e.preventDefault();
                setViewMode('split');
            }
            // Ctrl+2 = Editor Only
            if (e.ctrlKey && e.key === '2') {
                e.preventDefault();
                setViewMode('editor');
            }
            // Ctrl+3 = Preview Only
            if (e.ctrlKey && e.key === '3') {
                e.preventDefault();
                setViewMode('preview');
            }
        });

        document.addEventListener('keydown', handleKeyboardShortcuts);
        
        // Ensure auto-resize preference key exists (default ON) and restore cap
        try {
            if (localStorage.getItem('md-auto-resize-images') === null) {
                localStorage.setItem('md-auto-resize-images', '1');
            }
            const cap = localStorage.getItem('md-auto-resize-max') || '800';
            const capInt = parseInt(cap, 10) || 800;
            document.documentElement.style.setProperty('--md-auto-resize-max', capInt + 'px');
        } catch (e) {
            // localStorage may be unavailable in some restricted contexts — ignore
        }
        
        // Restore word-wrap preference (default OFF). Feature is experimental (beta).
        try {
            let wrapPref = null;
            try { wrapPref = localStorage.getItem('md-word-wrap'); } catch (e) { wrapPref = null; }
            if (wrapPref === null) {
                wrapPref = '0';
                try { localStorage.setItem('md-word-wrap', wrapPref); } catch (e) {}
            }
            const wrapEnabled = wrapPref === '1';
            // Apply to editor now
            setWordWrap(wrapEnabled);
            const wrapBtnEl = document.getElementById('btn-wordwrap');
            if (wrapBtnEl) {
                if (wrapEnabled) wrapBtnEl.classList.add('active'); else wrapBtnEl.classList.remove('active');
            }
        } catch (e) { }
        
        // Set up event listeners
        editor.addEventListener('input', function() {
            updatePreview();
            updateStatusBar();
            saveToUndoStack();
        });

        editor.addEventListener('keydown', function(e) {
            handleKeyboardShortcuts(e);
        });

        // Set up preview editing listeners
        preview.addEventListener('input', function() {
            if (!isUpdatingFromEditor && !isTogglingCheckbox) {
                clearTimeout(previewUpdateTimeout);
                previewUpdateTimeout = setTimeout(() => {
                    syncPreviewToEditor();
                    updateStatusBar();
                    saveToUndoStack();
                }, 300); // Debounce for 300ms
            }
        });

        preview.addEventListener('keydown', function(e) {
            handlePreviewKeyboardShortcuts(e);
        });

        preview.addEventListener('blur', function() {
            if (!isUpdatingFromEditor && !isTogglingCheckbox) {
                syncPreviewToEditor();
            }
        });

        // Update toolbar buttons when text is selected in preview
        preview.addEventListener('mouseup', updateToolbarFromPreviewSelection);
        preview.addEventListener('keyup', updateToolbarFromPreviewSelection);
        document.addEventListener('selectionchange', updateToolbarFromPreviewSelection);

        // Global keyboard shortcut for toggling word-wrap:
        // Ctrl+Alt+W or Ctrl+Shift+W (works on Windows). Prevent default to avoid window shortcuts.
        document.addEventListener('keydown', function(e) {
            try {
                const key = (e.key || '').toLowerCase();
                if ((e.ctrlKey || e.metaKey) && (e.altKey || e.shiftKey) && key === 'w') {
                    e.preventDefault();
                    toggleWordWrap();
                }
            } catch (err) { /* ignore */ }
        });

        // Set up file input listener
        document.getElementById('file-input').addEventListener('change', handleFileSelect);

        // Toolbar and menu event listeners
        document.getElementById('btn-new').addEventListener('click', newFile);
        document.getElementById('btn-open').addEventListener('click', openFile);
        document.getElementById('btn-save').addEventListener('click', saveFile);
        document.getElementById('btn-save-as').addEventListener('click', saveAsFile);
        document.getElementById('btn-print').addEventListener('click', openPrintDialog);
        setupPrintDialog();

        // Dev/Test modal wiring
        const devBtn = document.getElementById('dev-test-btn');
        const devModal = document.getElementById('dev-test-modal');
        const devClose = document.getElementById('dev-test-close');
        const fsAvailableEl = document.getElementById('fs-available');
        const devStatus = document.getElementById('dev-test-status');
        devBtn && devBtn.addEventListener('click', () => {
            devModal.style.display = 'block';
            fsAvailableEl.textContent = window.showOpenFilePicker ? 'Yes' : 'No (fallback only)';
        });
        devClose && devClose.addEventListener('click', () => devModal.style.display = 'none');
        document.getElementById('dev-open-fs').addEventListener('click', async () => {
            devStatus.textContent = 'Opening...';
            try {
                await openFile();
                devStatus.textContent = `Opened: ${currentFile || 'n/a'}`;
            } catch (e) {
                devStatus.textContent = 'Open cancelled or failed';
                console.warn(e);
            }
        });
        document.getElementById('dev-save-fs').addEventListener('click', async () => {
            devStatus.textContent = 'Saving...';
            try {
                await saveFile();
                devStatus.textContent = `Saved: ${currentFile || 'downloaded'}`;
            } catch (e) {
                devStatus.textContent = 'Save failed';
                console.warn(e);
            }
        });
        document.getElementById('dev-save-fallback').addEventListener('click', async () => {
            devStatus.textContent = 'Saving fallback...';
            try {
                // Temporarily clear handle to force fallback
                const prev = currentFileHandle;
                currentFileHandle = null;
                await saveFile();
                currentFileHandle = prev;
                devStatus.textContent = 'Fallback download triggered';
            } catch (e) {
                devStatus.textContent = 'Fallback save failed';
                console.warn(e);
            }
        });

        // Save error dialog wiring
        const saveErrorDialog = document.getElementById('save-error-dialog');
        const saveErrorMessage = document.getElementById('save-error-message');
        const saveErrorClose = document.getElementById('save-error-close');
        const saveErrorRetry = document.getElementById('save-error-retry');
        const saveErrorSaveAs = document.getElementById('save-error-saveas');
        const saveErrorDownload = document.getElementById('save-error-download');

        function showSaveError(err, context) {
            try {
                saveErrorMessage.textContent = (err && err.message) ? err.message : String(err || 'Unknown error');
            } catch (e) {
                saveErrorMessage.textContent = 'Unknown error while saving.';
            }
            saveErrorDialog.style.display = 'block';
            document.getElementById('popup-overlay').style.display = 'block';
            // Track context for retry
            saveErrorDialog.dataset.context = context || '';
        }

        function hideSaveError() {
            saveErrorDialog.style.display = 'none';
            document.getElementById('popup-overlay').style.display = 'none';
            saveErrorDialog.dataset.context = '';
        }

        saveErrorClose && saveErrorClose.addEventListener('click', hideSaveError);
        saveErrorRetry && saveErrorRetry.addEventListener('click', async () => {
            hideSaveError();
            try {
                await saveFile();
            } catch (e) {
                showSaveError(e, 'retry');
            }
        });
        saveErrorSaveAs && saveErrorSaveAs.addEventListener('click', async () => {
            hideSaveError();
            try {
                await saveAsFile();
            } catch (e) {
                showSaveError(e, 'saveas');
            }
        });
        saveErrorDownload && saveErrorDownload.addEventListener('click', async () => {
            hideSaveError();
            try {
                const prev = currentFileHandle;
                currentFileHandle = null;
                await saveFile();
                currentFileHandle = prev;
            } catch (e) {
                showSaveError(e, 'download');
            }
        });
    // Print feature temporarily disabled — event listener removed
        document.getElementById('btn-undo').addEventListener('click', function(e) {
            e.preventDefault();
            undo();
        });
        document.getElementById('btn-redo').addEventListener('click', function(e) {
            e.preventDefault();
            redo();
        });
        
        // Undo/Redo history dropdown on hover (v2.1.2 feature)
        const undoBtn = document.getElementById('btn-undo');
        const redoBtn = document.getElementById('btn-redo');
        undoBtn.addEventListener('mouseenter', function() { showHistoryDropdown('undo', undoBtn); });
        redoBtn.addEventListener('mouseenter', function() { showHistoryDropdown('redo', redoBtn); });
        
        document.getElementById('btn-bold').addEventListener('click', function() { toggleFormattingButton('**', '**', 'strong'); });
        document.getElementById('btn-italic').addEventListener('click', function() { toggleFormattingButton('*', '*', 'em'); });
        document.getElementById('btn-strike').addEventListener('click', function() { toggleFormattingButton('~~', '~~', 'del'); });
        document.getElementById('btn-code').addEventListener('click', function() { toggleFormattingButton('`', '`', 'code'); });
        document.getElementById('btn-hr').addEventListener('click', insertHorizontalRule);
        document.getElementById('btn-subscript').addEventListener('click', function() { 
            if (localStorage.getItem('ext-extended-markdown') === 'disabled') {
                customAlert('Subscript requires the Extended Markdown extension. Please enable it in Extensions to use this feature.');
                return;
            }
            insertMarkdown('~', '~'); 
        });
        document.getElementById('btn-superscript').addEventListener('click', function() { 
            if (localStorage.getItem('ext-extended-markdown') === 'disabled') {
                customAlert('Superscript requires the Extended Markdown extension. Please enable it in Extensions to use this feature.');
                return;
            }
            insertMarkdown('^', '^'); 
        });
        document.getElementById('btn-footnote').addEventListener('click', insertFootnoteSnippet);
        
        // Link and Image buttons
        document.getElementById('btn-link').addEventListener('click', insertLink);
        document.getElementById('btn-image').addEventListener('click', insertImage);
        document.getElementById('btn-number-list').addEventListener('click', function() { insertList('1. '); });
        document.getElementById('btn-quote').addEventListener('click', function() { insertList('> '); });
        document.getElementById('btn-task').addEventListener('click', function() { insertList('- [ ] '); });
        document.getElementById('btn-deflist').addEventListener('click', function() { 
            if (localStorage.getItem('ext-extended-markdown') === 'disabled') {
                customAlert('Definition lists require the Extended Markdown extension. Please enable it in Extensions to use this feature.');
                return;
            }
            insertList(': '); 
        });
        
        // Apply theme to heading dropdown
        function applyThemeToHeadingDropdown() {
            const body = document.body;
            const isDarkMode = body.classList.contains('dark-mode');

            const themeColors = {
                background: isDarkMode ? '#23272a' : 'white',
                border: isDarkMode ? '1px solid #444' : '1px solid #ccc',
                boxShadow: isDarkMode ? '0 2px 8px rgba(0,0,0,0.4)' : '0 2px 8px rgba(0,0,0,0.15)',
                textColor: isDarkMode ? '#e0e0e0' : '#333',
                borderColor: isDarkMode ? '1px solid #444' : '1px solid #eee',
                headingColor: isDarkMode ? '#4fc3f7' : '#0078d4',
                descColor: isDarkMode ? '#aaa' : '#666',
                hoverBg: isDarkMode ? '#2d3136' : '#f0f0f0'
            };

            if (headingDropdown) {
                headingDropdown.style.background = themeColors.background;
                headingDropdown.style.border = themeColors.border;
                headingDropdown.style.boxShadow = themeColors.boxShadow;

                headingDropdown.querySelectorAll('.dropdown-item').forEach(item => {
                    item.style.color = themeColors.textColor;
                    item.style.borderBottom = themeColors.borderColor;

                    const heading = item.querySelector('.dropdown-item-title');
                    const description = item.querySelector('.dropdown-item-description');
                    if (heading) heading.style.color = themeColors.headingColor;
                    if (description) description.style.color = themeColors.descColor;

                    item.onmouseenter = () => {
                        item.style.background = themeColors.hoverBg;
                    };
                    item.onmouseleave = () => {
                        item.style.background = 'transparent';
                    };
                });
            }
        }
        
        // Heading dropdown functionality
        const headingBtn = document.getElementById('btn-heading');
        const headingDropdown = document.getElementById('heading-dropdown');
        const headingCurrentText = document.getElementById('heading-current-text');
        
        // Function to update heading button based on current line
        function updateHeadingButton() {
            const cursorPos = editor.selectionStart;
            const lineStart = editor.value.lastIndexOf('\n', cursorPos - 1) + 1;
            const lineEnd = editor.value.indexOf('\n', cursorPos);
            const currentLine = editor.value.substring(lineStart, lineEnd !== -1 ? lineEnd : editor.value.length);
            
            // Check if current line is a heading
            const headingMatch = currentLine.match(/^(#{1,6})\s/);
            if (headingMatch) {
                const level = headingMatch[1].length;
                headingCurrentText.textContent = `H${level}`;
            } else {
                headingCurrentText.textContent = 'Heading';
            }
        }
        
        // Update heading button when cursor moves
        editor.addEventListener('click', updateHeadingButton);
        editor.addEventListener('keyup', updateHeadingButton);
        editor.addEventListener('selectionchange', updateHeadingButton);
        
        headingBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            // Close other dropdowns
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                if (menu !== headingDropdown) menu.style.display = 'none';
            });
            
            if (headingDropdown.style.display === 'none') {
                // Apply theme styling to dropdown
                applyThemeToHeadingDropdown();
                
                // Calculate position for fixed dropdown
                const rect = headingBtn.getBoundingClientRect();
                const gap = document.body.classList.contains('compact-mode') ? 1 : 2;
                headingDropdown.style.top = (rect.bottom + gap) + 'px';
                headingDropdown.style.left = rect.left + 'px';
                headingDropdown.style.display = 'block';
            } else {
                headingDropdown.style.display = 'none';
            }
        });
        
        // Handle heading selection
        headingDropdown.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', function() {
                const level = parseInt(this.dataset.level);
                insertHeading(level);
                headingDropdown.style.display = 'none';
                // Update button after insertion
                setTimeout(updateHeadingButton, 10);
            });
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            headingDropdown.style.display = 'none';
            if (document.getElementById('datetime-dropdown')) {
                document.getElementById('datetime-dropdown').style.display = 'none';
            }
        });
        
        // Initial update
        updateHeadingButton();
        
        // Date/Time dropdown functionality
        const datetimeBtn = document.getElementById('btn-datetime');
        const datetimeDropdown = document.getElementById('datetime-dropdown');
        
        // Function to format date/time according to format string
        function formatDateTime(format) {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            const monthNamesShort = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            const pad = (num) => String(num).padStart(2, '0');
            
            switch(format) {
                case 'YYYY-MM-DD':
                    return `${year}-${pad(month)}-${pad(day)}`;
                case 'MM/DD/YYYY':
                    return `${pad(month)}/${pad(day)}/${year}`;
                case 'DD/MM/YYYY':
                    return `${pad(day)}/${pad(month)}/${year}`;
                case 'MMMM D, YYYY':
                    return `${monthNames[month - 1]} ${day}, ${year}`;
                case 'MMM D, YYYY':
                    return `${monthNamesShort[month - 1]} ${day}, ${year}`;
                case 'YYYY-MM-DD HH:mm':
                    return `${year}-${pad(month)}-${pad(day)} ${pad(hours)}:${pad(minutes)}`;
                case 'YYYY-MM-DD hh:mm A':
                    const hours12 = hours % 12 || 12;
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    return `${year}-${pad(month)}-${pad(day)} ${pad(hours12)}:${pad(minutes)} ${ampm}`;
                case 'HH:mm:ss':
                    return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
                case 'hh:mm A':
                    const h12 = hours % 12 || 12;
                    const ap = hours >= 12 ? 'PM' : 'AM';
                    return `${pad(h12)}:${pad(minutes)} ${ap}`;
                case 'UNIX':
                    return Math.floor(now.getTime() / 1000).toString();
                default:
                    return now.toISOString();
            }
        }
        
        // Update preview examples with current date/time
        function updateDateTimePreviews() {
            datetimeDropdown.querySelectorAll('[data-preview]').forEach(preview => {
                const format = preview.getAttribute('data-preview');
                preview.textContent = formatDateTime(format);
            });
        }
        
        datetimeBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            // Close other dropdowns
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                if (menu !== datetimeDropdown) menu.style.display = 'none';
            });
            
            if (datetimeDropdown.style.display === 'none') {
                // Update previews with current date/time
                updateDateTimePreviews();
                
                // Calculate position for dropdown
                const rect = datetimeBtn.getBoundingClientRect();
                const gap = document.body.classList.contains('compact-mode') ? 1 : 2;
                datetimeDropdown.style.top = (rect.bottom + gap) + 'px';
                datetimeDropdown.style.left = rect.left + 'px';
                datetimeDropdown.style.display = 'block';
            } else {
                datetimeDropdown.style.display = 'none';
            }
        });
        
        // Handle date/time format selection
        datetimeDropdown.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', function() {
                const format = this.dataset.format;
                const formattedDateTime = formatDateTime(format);
                
                // Insert the formatted date/time at cursor position
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                const text = editor.value;
                editor.value = text.substring(0, start) + formattedDateTime + text.substring(end);
                
                // Move cursor after inserted text
                const newCursorPos = start + formattedDateTime.length;
                editor.selectionStart = editor.selectionEnd = newCursorPos;
                
                // Update preview
                updatePreview();
                
                // Close dropdown
                datetimeDropdown.style.display = 'none';
                
                // Focus back on editor
                editor.focus();
            });
        });
        
        // Close dropdown when clicking outside (already handled by existing document click listener)
        
        document.getElementById('btn-bullet-list').addEventListener('click', function() { insertList('- '); });

    // Find/Replace button
        document.getElementById('btn-find').addEventListener('click', function() { toggleFindReplace(); });
        
        // Help menu toolbar buttons
        document.getElementById('btn-help-docs').addEventListener('click', showHelp);
        document.getElementById('btn-about').addEventListener('click', showAbout);
        document.getElementById('btn-update-check').addEventListener('click', checkForUpdates);
        document.getElementById('btn-settings').addEventListener('click', showSettings);
        
        // Word-wrap toggle button
        const wordwrapBtn = document.getElementById('btn-wordwrap');
        if (wordwrapBtn) { wordwrapBtn.addEventListener('click', function() { toggleWordWrap(); }); }
        
        // Zoom controls
        let currentZoom = 100; // Default zoom level
        
        function applyZoom(zoomLevel) {
            currentZoom = Math.max(50, Math.min(200, zoomLevel)); // Clamp between 50% and 200%
            const zoomFactor = currentZoom / 100;
            
            // Apply zoom to editor and preview
            editor.style.fontSize = (14 * zoomFactor) + 'px';
            document.getElementById('preview').style.fontSize = (16 * zoomFactor) + 'px';
            
            // Update status
            updateStatus(`Zoom: ${currentZoom}%`);
            
            // Save zoom preference
            try {
                localStorage.setItem('md-zoom-level', currentZoom.toString());
            } catch (e) {}
        }
        
        function zoomIn() {
            applyZoom(currentZoom + 10);
        }
        
        function zoomOut() {
            applyZoom(currentZoom - 10);
        }
        
        function resetZoom() {
            applyZoom(100);
        }
        
        // Load saved zoom level
        try {
            const savedZoom = localStorage.getItem('md-zoom-level');
            if (savedZoom) {
                currentZoom = parseInt(savedZoom, 10);
                applyZoom(currentZoom);
            }
        } catch (e) {}
        
        // Zoom button event listeners
        const zoomInBtn = document.getElementById('btn-zoom-in');
        const zoomOutBtn = document.getElementById('btn-zoom-out');
        const zoomResetBtn = document.getElementById('btn-zoom-reset');
        
        if (zoomInBtn) zoomInBtn.addEventListener('click', zoomIn);
        if (zoomOutBtn) zoomOutBtn.addEventListener('click', zoomOut);
        if (zoomResetBtn) zoomResetBtn.addEventListener('click', resetZoom);
        
        // Keyboard shortcuts for zoom
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case '=':
                    case '+':
                        e.preventDefault();
                        zoomIn();
                        break;
                    case '-':
                    case '_':
                        e.preventDefault();
                        zoomOut();
                        break;
                    case '0':
                        e.preventDefault();
                        resetZoom();
                        break;
                }
            }
        });
        
        // Image cap button: allow user to set max auto-resize width at runtime
        const imgCapBtn = document.getElementById('btn-image-cap');
        if (imgCapBtn) {
            imgCapBtn.addEventListener('click', showImageCapDialog);
        }
        
        // Extensions button
        const extensionsBtn = document.getElementById('btn-extensions');
        if (extensionsBtn) {
            extensionsBtn.addEventListener('click', showExtensionsDialog);
        }

        // Table dropdown functionality
        document.getElementById('btn-table').addEventListener('click', function(e) {
            e.stopPropagation();
            const menu = document.getElementById('table-menu');
            const isVisible = menu.style.display === 'block';
            menu.style.display = isVisible ? 'none' : 'block';
            this.setAttribute('aria-expanded', (!isVisible).toString());
        });
        
        // Table menu options
        document.querySelectorAll('.table-menu-option').forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                if (this.classList.contains('disabled')) {
                    return; // Don't handle disabled options
                }
                
                const action = this.getAttribute('data-action');
                handleTableAction(action);
                document.getElementById('table-menu').style.display = 'none';
                document.getElementById('btn-table').setAttribute('aria-expanded', 'false');
            });
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.table-dropdown')) {
                document.getElementById('table-menu').style.display = 'none';
                document.getElementById('btn-table').setAttribute('aria-expanded', 'false');
            }
            if (!e.target.closest('#formatting-selector')) {
                document.getElementById('formatting-menu').style.display = 'none';
            }
        });
        
        // Status bar event listeners
        const tabsToggle = document.getElementById('tabs-toggle');
        if (tabsToggle) {
            tabsToggle.addEventListener('click', toggleTabs);
        }
        
        // Formatting selector
        const formattingSelector = document.getElementById('formatting-selector');
        const formattingMenu = document.getElementById('formatting-menu');
        
        if (formattingSelector) {
            formattingSelector.addEventListener('click', function(e) {
                e.stopPropagation();
                const isVisible = formattingMenu.style.display === 'block';
                formattingMenu.style.display = isVisible ? 'none' : 'block';
            });
        }
        
        // Formatting options
        document.querySelectorAll('.formatting-option').forEach(option => {
            option.addEventListener('click', function(e) {
                e.stopPropagation();
                const format = this.getAttribute('data-format');
                setFormatting(format);
            });
        });
        
        // Add cursor and selection tracking
        editor.addEventListener('click', updateStatusBar);
        editor.addEventListener('keyup', updateStatusBar);
        editor.addEventListener('selectionchange', updateStatusBar);
        
        // Load saved preferences
        try {
            const savedUseTabs = localStorage.getItem('md-use-tabs');
            const savedTabSize = localStorage.getItem('md-tab-size');
            const savedFormat = localStorage.getItem('md-formatting');
            
            if (savedUseTabs !== null) {
                useTabs = savedUseTabs === 'true';
            }
            if (savedTabSize !== null) {
                tabSize = parseInt(savedTabSize);
            }
            if (savedFormat !== null) {
                currentFormat = savedFormat;
                setFormatting(savedFormat);
            }
            
            // Apply tabs preference
            if (useTabs) {
                tabsToggle.textContent = 'Tabs';
            } else {
                tabsToggle.textContent = 'Spaces';
            }
            editor.style.tabSize = tabSize;
        } catch (e) { /* ignore */ }

        // Theme dialog functionality
        const themeBtn = document.getElementById('btn-theme');
        const openThemeSettingsBtn = document.getElementById('open-theme-settings');
        const themeDialog = document.getElementById('theme-dialog');
        const themeDialogClose = document.getElementById('theme-dialog-close');
        const themeDialogCancel = document.getElementById('theme-dialog-cancel');
        const themeDialogApply = document.getElementById('theme-dialog-apply');
        const popupOverlay = document.getElementById('popup-overlay');
        const premiumUpsellDialog = document.getElementById('premium-upsell');
        const premiumStartButton = document.getElementById('premium-upsell-start');
        const premiumCloseButtons = document.querySelectorAll('.premium-upsell-close');
        const premiumCardInputs = [
            document.getElementById('premium-card-number'),
            document.getElementById('premium-card-expiry'),
            document.getElementById('premium-card-cvc')
        ].filter(Boolean);
        let premiumUpsellConfirmHandler = null;
        let premiumUpsellDismissHandler = null;
        let premiumUpsellTriggered = false;

        function openPremiumUpsell(onConfirm, onDismiss) {
            premiumUpsellConfirmHandler = typeof onConfirm === 'function' ? onConfirm : null;
            premiumUpsellDismissHandler = typeof onDismiss === 'function' ? onDismiss : null;
            premiumUpsellTriggered = false;

            premiumCardInputs.forEach(input => {
                input.value = '';
            });

            if (premiumUpsellDialog) {
                premiumUpsellDialog.style.display = 'block';
            }
            if (popupOverlay) {
                popupOverlay.style.display = 'block';
            }

            if (premiumCardInputs.length) {
                setTimeout(() => premiumCardInputs[0].focus(), 80);
            }
        }

        function executePremiumUpsellConfirm() {
            if (premiumUpsellTriggered) {
                return;
            }
            premiumUpsellTriggered = true;
            if (premiumUpsellConfirmHandler) {
                premiumUpsellConfirmHandler();
            }
        }

        function closePremiumUpsell(triggerDismiss = true) {
            if (premiumUpsellDialog) {
                premiumUpsellDialog.style.display = 'none';
            }
            if (popupOverlay) {
                popupOverlay.style.display = 'none';
            }

            if (triggerDismiss && !premiumUpsellTriggered && premiumUpsellDismissHandler) {
                premiumUpsellDismissHandler();
            }

            premiumUpsellConfirmHandler = null;
            premiumUpsellDismissHandler = null;
            premiumUpsellTriggered = false;
        }

        if (premiumStartButton) {
            premiumStartButton.addEventListener('click', function() {
                executePremiumUpsellConfirm();
                closePremiumUpsell(false);
            });
        }

        premiumCloseButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                closePremiumUpsell(true);
            });
        });

        premiumCardInputs.forEach(input => {
            input.addEventListener('input', function() {
                if (!premiumUpsellTriggered && this.value.trim().length > 0) {
                    executePremiumUpsellConfirm();
                    closePremiumUpsell(false);
                }
            });
        });
        
        function openThemeDialogFromSettings() {
            themeDialog.style.display = 'block';
            popupOverlay.style.display = 'block';

            // Load current theme
            const currentTheme = getCurrentTheme();
            const themeRadio = document.querySelector(`input[name="theme"][value="${currentTheme}"]`);
            if (themeRadio) {
                themeRadio.checked = true;
                const themeCard = themeRadio.closest('.theme-preview-card');
                if (themeCard) {
                    const checkmark = themeCard.querySelector('.theme-check');
                    if (checkmark) {
                        checkmark.style.opacity = '1';
                    }
                }
            }

            // Load compact mode state
            const compactToggle = document.getElementById('compact-mode-toggle');
            if (compactToggle) {
                try {
                    const isCompact = localStorage.getItem('md-compact-mode') === '1';
                    compactToggle.checked = isCompact;
                } catch (e) {}
            }
        }

        // Open theme dialog
        if (themeBtn) {
            themeBtn.addEventListener('click', openThemeDialogFromSettings);
        }
        if (openThemeSettingsBtn) {
            openThemeSettingsBtn.addEventListener('click', openThemeDialogFromSettings);
        }
        
        // Close theme dialog
        function closeThemeDialog() {
            themeDialog.style.display = 'none';
            popupOverlay.style.display = 'none';
            // Reset all checkmarks
            document.querySelectorAll('.theme-check').forEach(check => {
                check.style.opacity = '0';
            });
            // Reset dialog position for next time
            resetDialogPosition(themeDialog);
        }
        
        if (themeDialogClose) {
            themeDialogClose.addEventListener('click', closeThemeDialog);
        }
        
        if (themeDialogCancel) {
            themeDialogCancel.addEventListener('click', closeThemeDialog);
        }
        
        // Apply theme
        if (themeDialogApply) {
            themeDialogApply.addEventListener('click', function() {
                const selectedTheme = document.querySelector('input[name="theme"]:checked');
                if (selectedTheme) {
                    const themeValue = normalizeTheme(selectedTheme.value);
                    applyTheme(themeValue);
                    
                    // Show appropriate status message
                    if (themeValue === 'auto') {
                        const systemPref = getSystemThemePreference();
                        updateStatus(`Auto theme enabled (using ${systemPref} mode)`);
                    } else {
                        updateStatus(`Theme changed to ${themeValue}`);
                    }
                }
                
                // Apply compact mode
                const compactToggle = document.getElementById('compact-mode-toggle');
                if (compactToggle) {
                    toggleCompactMode(compactToggle.checked);
                }
                
                closeThemeDialog();
            });
        }
        
        function normalizeTheme(theme) {
            if (theme === 'dark') return 'dark';
            if (theme === 'auto') return 'auto';
            return 'light';
        }
        
        // Get current theme
        function getCurrentTheme() {
            try {
                const savedTheme = localStorage.getItem('markdown-theme');
                if (savedTheme) {
                    return normalizeTheme(savedTheme);
                }
            } catch (e) {}
            
            const body = document.body;
            return body.classList.contains('dark-mode') ? 'dark' : 'light';
        }
        
        // Get system preference for dark mode
        function getSystemThemePreference() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                return 'dark';
            }
            return 'light';
        }
        
        // Apply theme based on system preference (for auto mode)
        function applyAutoTheme() {
            const systemPref = getSystemThemePreference();
            applyThemeVisual(systemPref);
        }
        
        // Apply visual theme without saving to localStorage
        function applyThemeVisual(theme) {
            const normalizedTheme = normalizeTheme(theme);
            const body = document.body;
            body.classList.remove('dark-mode');

            if (normalizedTheme === 'dark') {
                body.classList.add('dark-mode');
            }
            
            // Update heading dropdown theme if it exists
            if (typeof applyThemeToHeadingDropdown === 'function') {
                applyThemeToHeadingDropdown();
            }
        }
        
        // Apply theme (saves to localStorage)
        function applyTheme(theme) {
            const normalizedTheme = normalizeTheme(theme);
            
            try {
                localStorage.setItem('markdown-theme', normalizedTheme);
            } catch (e) {
                console.warn('Could not save theme to localStorage:', e);
            }
            
            if (normalizedTheme === 'auto') {
                applyAutoTheme();
                return;
            }
            
            applyThemeVisual(normalizedTheme);
        }
        
        // Listen for system theme changes when in auto mode
        if (window.matchMedia) {
            const darkModeQuery = window.matchMedia('(prefers-color-scheme: dark)');
            darkModeQuery.addEventListener('change', function(e) {
                try {
                    const savedTheme = localStorage.getItem('markdown-theme');
                    if (savedTheme === 'auto') {
                        applyAutoTheme();
                        updateStatus(`Theme auto-switched to ${e.matches ? 'dark' : 'light'} mode`);
                    }
                } catch (err) {}
            });
        }
        
        // Restore saved theme on load
        try {
            const savedTheme = localStorage.getItem('markdown-theme');
            if (savedTheme) {
                const normalizedTheme = normalizeTheme(savedTheme);
                if (normalizedTheme !== savedTheme) {
                    try {
                        localStorage.setItem('markdown-theme', normalizedTheme);
                    } catch (err) {}
                }
                
                if (normalizedTheme === 'auto') {
                    applyAutoTheme();
                } else {
                    applyThemeVisual(normalizedTheme);
                }
            } else {
                applyThemeVisual('light');
            }
        } catch (e) {
            applyThemeVisual('light');
        }
        
        // Toggle compact mode
        function toggleCompactMode(enabled) {
            const body = document.body;
            if (enabled) {
                body.classList.add('compact-mode');
                try {
                    localStorage.setItem('md-compact-mode', '1');
                } catch (e) {}
                updateStatus('Compact mode enabled');
            } else {
                body.classList.remove('compact-mode');
                try {
                    localStorage.setItem('md-compact-mode', '0');
                } catch (e) {}
                updateStatus('Compact mode disabled');
            }
            
            // Reset dialog positions when toggling compact mode
            if (window.resetDialogPosition) {
                const themeDialog = document.getElementById('theme-dialog');
                const findReplaceBar = document.getElementById('find-replace-bar');
                if (themeDialog) window.resetDialogPosition(themeDialog);
                if (findReplaceBar) window.resetDialogPosition(findReplaceBar);
            }
        }
        
        // Restore compact mode on load
        try {
            const savedCompact = localStorage.getItem('md-compact-mode') === '1';
            if (savedCompact) {
                document.body.classList.add('compact-mode');
            }
        } catch (e) {}
        
        // Make theme dialog draggable
        makeDraggable(document.getElementById('theme-dialog'), document.getElementById('theme-dialog-header'));
        
        // Make find-replace dialog draggable
        makeDraggable(document.getElementById('find-replace-bar'), document.getElementById('find-replace-header'));
        
        // Theme card selection handlers
        document.querySelectorAll('.theme-preview-card').forEach(card => {
            card.addEventListener('click', function() {
                const radio = this.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                    // Remove all checkmarks
                    document.querySelectorAll('.theme-check').forEach(check => {
                        check.style.opacity = '0';
                    });
                    // Show checkmark for selected theme
                    const checkmark = this.querySelector('.theme-check');
                    if (checkmark) {
                        checkmark.style.opacity = '1';
                    }
                }
            });
        });
        
        // Reset dialog to center position
        function resetDialogPosition(dialog) {
            if (!dialog) return;
            
            // Check if dialog has original centering transform
            const hasTransform = dialog.style.transform && dialog.style.transform.includes('translate');
            
            if (!hasTransform) {
                // Restore original centering transform
                const computedStyle = window.getComputedStyle(dialog);
                if (computedStyle.left === '50%' || dialog.getAttribute('data-centered') === 'true') {
                    dialog.style.transform = 'translateX(-50%)';
                }
            }
        }
        
        // Expose to window for cross-function access
        window.resetDialogPosition = resetDialogPosition;
        
        function makeDraggable(dialog, header) {
            if (!dialog || !header) return;
            
            // Mark as centered dialog for position reset
            dialog.setAttribute('data-centered', 'true');
            
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            let hasRemovedTransform = false;
            
            header.onmousedown = dragMouseDown;
            
            function dragMouseDown(e) {
                // Don't drag if clicking on buttons or inputs
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') {
                    return;
                }
                
                e.preventDefault();
                
                // On first drag, remove transform and set absolute position
                if (!hasRemovedTransform) {
                    const transform = window.getComputedStyle(dialog).transform;
                    if (transform && transform !== 'none') {
                        const rect = dialog.getBoundingClientRect();
                        dialog.style.transform = 'none';
                        dialog.style.left = rect.left + 'px';
                        dialog.style.top = rect.top + 'px';
                    }
                    hasRemovedTransform = true;
                }
                
                // Store initial positions
                pos3 = e.clientX;
                pos4 = e.clientY;
                pos1 = dialog.offsetLeft;
                pos2 = dialog.offsetTop;
                
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }
            
            function elementDrag(e) {
                e.preventDefault();
                
                // Calculate new position based on mouse movement from initial click
                const deltaX = e.clientX - pos3;
                const deltaY = e.clientY - pos4;
                
                dialog.style.top = (pos2 + deltaY) + "px";
                dialog.style.left = (pos1 + deltaX) + "px";
            }
            
            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }


        // Set up splitter functionality
        setupSplitter();
        wirePaneActivation();

        // Initial preview update
        updatePreview();
        updateStatusBar();
        
        // Initialize undo/redo stacks with the starting content
        undoStack = [editor.value];
        redoStack = [];
        lastUndoValue = editor.value;
    }

    function setMica(enabled) {
        const body = document.body;
        if (!body) return;
        if (enabled) {
            body.classList.add('mica-enabled');
        } else {
            body.classList.remove('mica-enabled');
        }
        try { localStorage.setItem('md-mica', enabled ? '1' : '0'); } catch (e) {}
        const btn = document.getElementById('btn-mica');
        if (btn) {
            if (enabled) btn.classList.add('active'); else btn.classList.remove('active');
        }
        updateStatus('Mica ' + (enabled ? 'enabled' : 'disabled'));
    }

    function toggleMica() {
        const on = document.body && document.body.classList.contains('mica-enabled');
        setMica(!on);
    }

    function setBackgroundImage(dataUrl) {
        if (!dataUrl) {
            // Clear background
            document.body.classList.remove('has-bg-image');
            document.body.style.removeProperty('--bg-image');
            try { localStorage.removeItem('md-bg-image'); } catch (e) {}
            updateStatus('Background image removed');
            const btn = document.getElementById('btn-bg-image');
            if (btn) btn.classList.remove('active');
            return;
        }
        
        applyBackgroundImage(dataUrl);
        
        // Persist to localStorage
        try {
            localStorage.setItem('md-bg-image', dataUrl);
            updateStatus('Background image set (enable Mica for best effect)');
        } catch (e) {
            // Data URL might be too large for localStorage
            updateStatus('Background image set (not saved - too large)');
        }
    }

    function applyBackgroundImage(dataUrl) {
        document.body.classList.add('has-bg-image');
        document.body.style.setProperty('--bg-image', `url(${dataUrl})`);
        const btn = document.getElementById('btn-bg-image');
        if (btn) btn.classList.add('active');
    }

    function clearBackgroundImage() {
        setBackgroundImage(null);
    }

    // Find & Replace functionality
    let findState = {
        lastQuery: '',
        matches: [],
        currentIndex: -1
    };
    let searchHistory = [];

    function toggleFindReplace(openReplace) {
        const bar = document.getElementById('find-replace-bar');
        if (bar.style.display === 'none' || bar.style.display === '') {
            bar.style.display = 'block';
            document.getElementById('find-input').focus();
        } else {
            bar.style.display = 'none';
            editor.focus();
            // Reset dialog position for next time
            if (window.resetDialogPosition) {
                window.resetDialogPosition(bar);
            }
        }
    }

    function updateMatches(query) {
        findState.matches = [];
        findState.currentIndex = -1;
        const cs = document.getElementById('case-sensitive') && document.getElementById('case-sensitive').checked;
        const useRegex = document.getElementById('use-regex') && document.getElementById('use-regex').checked;
        if (!query) { updateMatchCount(); return; }
        const text = editor.value;
        if (useRegex) {
                // build flags string from flag checkboxes
                let flags = 'g';
                if (!cs) flags += 'i';
                document.querySelectorAll('.flag-checkbox:checked').forEach(b => { const f = b.getAttribute('data-flag'); if (f && !flags.includes(f)) flags += f; });
            let re;
            try {
                re = new RegExp(query, flags);
            } catch (err) {
                const el = document.getElementById('match-count'); if (el) el.textContent = 'Invalid regex';
                return;
            }
            let m;
            while ((m = re.exec(text)) !== null) {
                findState.matches.push({start: m.index, end: m.index + m[0].length});
                if (m.index === re.lastIndex) re.lastIndex++; // avoid infinite loop on zero-length matches
            }
            updateMatchCount();
            highlightMatches();
            return;
        }
        // plain substring search
        let hay = text;
        let needle = query;
        if (!cs) { hay = text.toLowerCase(); needle = query.toLowerCase(); }
        let startIndex = 0;
        while (true) {
            const idx = hay.indexOf(needle, startIndex);
            if (idx === -1) break;
            findState.matches.push({start: idx, end: idx + query.length});
            startIndex = idx + query.length;
        }
        updateMatchCount();
        highlightMatches();
    }

    function escapeHtml(str) {
        if (str == null) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // Highlight matches - keep preview as normal markdown rendering
    function highlightMatches() {
        // Don't break the preview - just keep it as rendered markdown
        // The editor selection will show the current match
        updatePreview();
    }

    function highlightMatch(index) {
        if (index < 0 || index >= findState.matches.length) return;
        const m = findState.matches[index];
        editor.selectionStart = m.start;
        editor.selectionEnd = m.end;
        editor.focus();
        updateMatchCount();
    }

    function updateMatchCount() {
        const el = document.getElementById('match-count');
        const total = findState.matches.length;
        const current = (findState.currentIndex >= 0 && total > 0) ? (findState.currentIndex + 1) : 0;
        if (el) el.textContent = `${current} / ${total}`;
    }

    function findNext() {
        const q = document.getElementById('find-input').value;
        if (q !== findState.lastQuery) {
            findState.lastQuery = q;
            updateMatches(q);
        }
        if (findState.matches.length === 0) return;
        
        const wrapAround = document.getElementById('wrap-around') && document.getElementById('wrap-around').checked;
        
        // Start from first match if no current selection
        if (findState.currentIndex === -1) {
            findState.currentIndex = 0;
        } else {
            const nextIndex = findState.currentIndex + 1;
            
            if (wrapAround) {
                // Wrap around to beginning if at end
                findState.currentIndex = nextIndex % findState.matches.length;
            } else {
                // Stop at end without wrapping
                if (nextIndex >= findState.matches.length) {
                    updateStatus('Reached end of document');
                    return;
                }
                findState.currentIndex = nextIndex;
            }
        }
        
        highlightMatch(findState.currentIndex);
        highlightMatches();
    }

    function findPrev() {
        const q = document.getElementById('find-input').value;
        if (q !== findState.lastQuery) {
            findState.lastQuery = q;
            updateMatches(q);
        }
        if (findState.matches.length === 0) return;
        
        const wrapAround = document.getElementById('wrap-around') && document.getElementById('wrap-around').checked;
        
        // Start from last match if no current selection
        if (findState.currentIndex === -1) {
            findState.currentIndex = findState.matches.length - 1;
        } else {
            const prevIndex = findState.currentIndex - 1;
            
            if (wrapAround) {
                // Wrap around to end if at beginning
                findState.currentIndex = (prevIndex + findState.matches.length) % findState.matches.length;
            } else {
                // Stop at beginning without wrapping
                if (prevIndex < 0) {
                    updateStatus('Reached beginning of document');
                    return;
                }
                findState.currentIndex = prevIndex;
            }
        }
        
        highlightMatch(findState.currentIndex);
        highlightMatches();
    }

    function replaceOne() {
        const q = document.getElementById('find-input').value;
        const r = document.getElementById('replace-input').value;
        if (!q) return;
        
        // If no matches, do nothing
        if (findState.matches.length === 0) return;
        
        // If regex mode, use regex replace semantics
        const cs = document.getElementById('case-sensitive') && document.getElementById('case-sensitive').checked;
        const useRegex = document.getElementById('use-regex') && document.getElementById('use-regex').checked;
        
        if (useRegex) {
            try {
                const flags = cs ? '' : 'i';
                const re = new RegExp(q, flags);
                const selected = editor.value.substring(editor.selectionStart, editor.selectionEnd);
                if (selected && re.test(selected)) {
                    saveToUndoStack();
                    const replaced = selected.replace(re, r);
                    editor.setRangeText(replaced, editor.selectionStart, editor.selectionEnd, 'end');
                    updatePreview(); 
                    updateStatusBar(); 
                    updateMatches(q);
                    return;
                }
                // Move to next match
                findNext();
                const sel = editor.value.substring(editor.selectionStart, editor.selectionEnd);
                if (sel && re.test(sel)) {
                    saveToUndoStack();
                    const replaced2 = sel.replace(re, r);
                    editor.setRangeText(replaced2, editor.selectionStart, editor.selectionEnd, 'end');
                    updatePreview(); 
                    updateStatusBar(); 
                    updateMatches(q);
                }
            } catch (err) {
                const el = document.getElementById('match-count'); if (el) el.textContent = 'Invalid regex';
            }
            return;
        }
        
        // plain substring replace
        const selected = editor.value.substring(editor.selectionStart, editor.selectionEnd);
        const matchesSelected = selected && ((cs && selected === q) || (!cs && selected.toLowerCase() === q.toLowerCase()));
        
        if (matchesSelected) {
            saveToUndoStack();
            editor.setRangeText(r, editor.selectionStart, editor.selectionEnd, 'end');
            updatePreview();
            updateStatusBar();
            // Update matches after replacement
            updateMatches(q);
        } else {
            // Move to next match and try to replace
            findNext();
            const sel = editor.value.substring(editor.selectionStart, editor.selectionEnd);
            const selMatches = sel && ((cs && sel === q) || (!cs && sel.toLowerCase() === q.toLowerCase()));
            if (selMatches) {
                saveToUndoStack();
                editor.setRangeText(r, editor.selectionStart, editor.selectionEnd, 'end');
                updatePreview();
                updateStatusBar();
                updateMatches(q);
            }
        }
    }

    function replaceAll() {
        const q = document.getElementById('find-input').value;
        const r = document.getElementById('replace-input').value;
        if (!q) return;
        
        const cs = document.getElementById('case-sensitive') && document.getElementById('case-sensitive').checked;
        const useRegex = document.getElementById('use-regex') && document.getElementById('use-regex').checked;
        const text = editor.value;
        
        if (useRegex) {
            let flags = 'g'; if (!cs) flags += 'i';
            // include any checked flag checkboxes
            document.querySelectorAll('.flag-checkbox:checked').forEach(b => { const f = b.getAttribute('data-flag'); if (f && !flags.includes(f)) flags += f; });
            try {
                const re = new RegExp(q, flags);
                if (!re.test(text)) {
                    updateStatus('No matches found');
                    return;
                }
                const matches = text.match(re);
                if (!matches || matches.length === 0) {
                    updateStatus('No matches found');
                    return;
                }
                editor.value = text.replace(re, r);
                updatePreview(); 
                updateStatusBar(); 
                pushImmediateUndoSnapshot();
                updateMatches(q);
                updateStatus(`Replaced ${matches.length} occurrences`);
            } catch (err) {
                const el = document.getElementById('match-count'); if (el) el.textContent = 'Invalid regex';
            }
            return;
        }
        
        // Plain text replace
        const hay = cs ? text : text.toLowerCase();
        const needle = cs ? q : q.toLowerCase();
        if (hay.indexOf(needle) === -1) {
            updateStatus('No matches found');
            return;
        }
        
        let replaceCount = 0;
        
        if (cs) {
            // Case-sensitive replace
            const matches = text.split(q);
            replaceCount = matches.length - 1;
            editor.value = text.split(q).join(r);
        } else {
            // Case-insensitive replace: do a simple global replace
            let result = '';
            let idx = 0;
            while (idx < text.length) {
                const segment = text.substring(idx);
                const pos = segment.toLowerCase().indexOf(needle);
                if (pos === -1) { result += segment; break; }
                result += segment.substring(0, pos) + r;
                idx += pos + q.length;
                replaceCount++;
            }
            editor.value = result;
        }
        
        updatePreview(); 
        updateStatusBar(); 
        pushImmediateUndoSnapshot();
        updateMatches(q);
        updateStatus(`Replaced ${replaceCount} occurrences`);
    }

    // Global settings functions
    let settingsNavItems;
    let settingsSections;
    
    function switchSettingsSection(sectionName) {
        // Update sidebar active state
        settingsNavItems.forEach(item => {
            if (item.dataset.section === sectionName) {
                item.style.background = '#e8f0fe';
                item.style.color = '#1967d2';
                item.style.borderLeft = '3px solid #1967d2';
            } else {
                item.style.background = 'transparent';
                item.style.color = '#5f6368';
                item.style.borderLeft = 'none';
            }
        });
        
        // Show corresponding section
        settingsSections.forEach(section => {
            if (section.dataset.section === sectionName) {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        });
    }
    
    function updateFontSizeDisplay() {
        const fontSizeDisplay = document.getElementById('font-size-display');
        if (fontSizeDisplay) {
            fontSizeDisplay.textContent = settings.fontSize + 'px';
        }
    }
    
    function setupToggleSwitch(checkboxId) {
        const checkbox = document.getElementById(checkboxId);
        if (!checkbox) return;
        
        const toggle = checkbox.nextElementSibling;
        const thumb = toggle.nextElementSibling;
        
        function updateToggle() {
            if (checkbox.checked) {
                toggle.style.backgroundColor = '#1a73e8';
                thumb.style.transform = 'translateX(20px)';
            } else {
                toggle.style.backgroundColor = '#ccc';
                thumb.style.transform = 'translateX(0)';
            }
        }
        
        updateToggle();
        checkbox.addEventListener('change', updateToggle);
        
        // Add click handler to the toggle
        toggle.addEventListener('click', function() {
            checkbox.checked = !checkbox.checked;
            updateToggle();
            checkbox.dispatchEvent(new Event('change'));
        });
    }

    // Wire up find/replace bar buttons
    document.addEventListener('DOMContentLoaded', function() {
        // Because our initEditor runs on window.load, also ensure these buttons exist by waiting DOMContentLoaded
        const findNextBtn = document.getElementById('btn-find-next');
        const findPrevBtn = document.getElementById('btn-find-prev');
        const replaceBtn = document.getElementById('btn-replace');
        const replaceAllBtn = document.getElementById('btn-replace-all');
        const closeBtn = document.getElementById('find-close');

        if (findNextBtn) findNextBtn.addEventListener('click', findNext);
        if (findPrevBtn) findPrevBtn.addEventListener('click', findPrev);
        if (replaceBtn) replaceBtn.addEventListener('click', replaceOne);
        if (replaceAllBtn) replaceAllBtn.addEventListener('click', replaceAll);
        if (closeBtn) closeBtn.addEventListener('click', function() { 
            const bar = document.getElementById('find-replace-bar');
            bar.style.display = 'none'; 
            editor.focus(); 
            // Reset dialog position for next time
            if (window.resetDialogPosition) {
                window.resetDialogPosition(bar);
            }
        });

        // Update matches as user types
        const findInput = document.getElementById('find-input');
        if (findInput) {
            findInput.addEventListener('input', function() { updateMatches(findInput.value); });
            findInput.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); findNext(); } });
        }
        const replaceInputEl = document.getElementById('replace-input');
        if (replaceInputEl) {
            replaceInputEl.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); replaceOne(); } });
        }
        const caseCheckbox = document.getElementById('case-sensitive');
        if (caseCheckbox) caseCheckbox.addEventListener('change', function() { updateMatches(document.getElementById('find-input').value); });
        const regexCheckbox = document.getElementById('use-regex');
        if (regexCheckbox) regexCheckbox.addEventListener('change', function() { updateMatches(document.getElementById('find-input').value); });
        
        // Wrap around checkbox - save preference
        const wrapCheckbox = document.getElementById('wrap-around');
        if (wrapCheckbox) {
            // Restore saved preference
            try {
                const savedWrap = localStorage.getItem('find-wrap-around');
                if (savedWrap !== null) {
                    wrapCheckbox.checked = savedWrap === 'true';
                }
            } catch (e) {}
            
            // Save preference on change
            wrapCheckbox.addEventListener('change', function() {
                try {
                    localStorage.setItem('find-wrap-around', this.checked);
                } catch (e) {}
            });
        }
        // Flags dropdown toggle
        const flagsToggle = document.getElementById('flags-toggle');
        const flagsMenu = document.getElementById('flags-menu');
        if (flagsToggle && flagsMenu) {
            function closeFlagsMenu() {
                flagsMenu.style.display = 'none';
                flagsToggle.setAttribute('aria-expanded', 'false');
                flagsMenu.setAttribute('aria-hidden', 'true');
            }

            flagsToggle.addEventListener('click', function(e) {
                e.preventDefault();
                const expanded = flagsToggle.getAttribute('aria-expanded') === 'true';
                if (expanded) {
                    closeFlagsMenu();
                } else {
                    flagsMenu.style.display = 'block';
                    flagsToggle.setAttribute('aria-expanded', 'true');
                    flagsMenu.setAttribute('aria-hidden', 'false');
                }
            });
            // Close menu when clicking outside
            document.addEventListener('click', function(e) {
                if (!flagsMenu.contains(e.target) && !flagsToggle.contains(e.target)) {
                    closeFlagsMenu();
                }
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeFlagsMenu();
                }
            });
        }
        // Checkbox change listeners
        const flagCheckboxes = Array.from(document.querySelectorAll('.flag-checkbox'));
        flagCheckboxes.forEach(cb => {
            cb.addEventListener('change', function() { updateMatches(document.getElementById('find-input').value); });
        });

        // Patterns dropdown behavior
        const patternsToggle = document.getElementById('patterns-toggle');
        const patternsMenu = document.getElementById('patterns-menu');
        const patternButtons = Array.from(document.querySelectorAll('.pattern-option'));
        const patternClipboardBtn = document.getElementById('pattern-insert-clipboard');

        function closePatternsMenu() {
            if (!patternsMenu || !patternsToggle) return;
            patternsMenu.style.display = 'none';
            patternsToggle.setAttribute('aria-expanded', 'false');
            patternsMenu.setAttribute('aria-hidden', 'true');
        }

        function openPatternsMenu() {
            if (!patternsMenu || !patternsToggle) return;
            patternsMenu.style.display = 'block';
            patternsToggle.setAttribute('aria-expanded', 'true');
            patternsMenu.setAttribute('aria-hidden', 'false');
        }

        if (patternsToggle && patternsMenu) {
            patternsToggle.addEventListener('click', function(e) {
                e.preventDefault();
                const expanded = patternsToggle.getAttribute('aria-expanded') === 'true';
                if (expanded) {
                    closePatternsMenu();
                } else {
                    openPatternsMenu();
                }
            });

            document.addEventListener('click', function(e) {
                if (!patternsMenu.contains(e.target) && !patternsToggle.contains(e.target)) {
                    closePatternsMenu();
                }
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closePatternsMenu();
                }
            });
        }

        function applyPatternFlags(flagString) {
            if (!flagString) return;
            const caseCheckbox = document.getElementById('case-sensitive');
            if (caseCheckbox && flagString.includes('i')) {
                caseCheckbox.checked = false;
                caseCheckbox.dispatchEvent(new Event('change'));
            }
            flagCheckboxes.forEach(cb => {
                const flag = cb.getAttribute('data-flag');
                if (flag && flagString.includes(flag)) {
                    if (!cb.checked) {
                        cb.checked = true;
                        cb.dispatchEvent(new Event('change'));
                    }
                }
            });
        }

        function insertPattern(pattern, flagString, sourceLabel) {
            if (!pattern) return;
            const findInputEl = document.getElementById('find-input');
            if (!findInputEl) return;

            const useRegexCheckbox = document.getElementById('use-regex');
            if (useRegexCheckbox && !useRegexCheckbox.checked) {
                useRegexCheckbox.checked = true;
                useRegexCheckbox.dispatchEvent(new Event('change'));
            }

            const selectionStart = findInputEl.selectionStart != null ? findInputEl.selectionStart : findInputEl.value.length;
            const selectionEnd = findInputEl.selectionEnd != null ? findInputEl.selectionEnd : selectionStart;
            const before = findInputEl.value.substring(0, selectionStart);
            const after = findInputEl.value.substring(selectionEnd);
            findInputEl.value = before + pattern + after;
            const cursorPosition = before.length + pattern.length;
            findInputEl.focus();
            findInputEl.setSelectionRange(cursorPosition, cursorPosition);

            applyPatternFlags(flagString);
            updateMatches(findInputEl.value);
            updateStatus(`Inserted pattern${sourceLabel ? ': ' + sourceLabel : ''}`);
        }

        patternButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const pattern = this.dataset.pattern || '';
                const flags = this.dataset.flags || '';
                const label = this.textContent.trim();
                insertPattern(pattern, flags, label);
                closePatternsMenu();
            });
        });

        if (patternClipboardBtn) {
            patternClipboardBtn.addEventListener('click', async function() {
                if (!navigator.clipboard || !navigator.clipboard.readText) {
                    updateStatus('Clipboard API unavailable');
                    return;
                }
                try {
                    const clipboardText = await navigator.clipboard.readText();
                    if (!clipboardText) {
                        updateStatus('Clipboard was empty');
                        return;
                    }
                    insertPattern(clipboardText, '', 'Clipboard');
                    closePatternsMenu();
                } catch (err) {
                    console.warn('Clipboard read failed', err);
                    updateStatus('Clipboard access denied');
                }
            });
        }

        // Search history
        const historyToggle = document.getElementById('search-history-toggle');
        const historyMenu = document.getElementById('search-history-menu');
        const historyList = document.getElementById('search-history-list');
        const historyText = document.getElementById('search-history-text');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        
        try {
            const stored = localStorage.getItem('md-search-history');
            if (stored) searchHistory = JSON.parse(stored);
        } catch (e) { searchHistory = []; }
        
        function refreshHistory() {
            if (searchHistory.length === 0) {
                historyList.innerHTML = '<div class="search-history-empty">No recent searches</div>';
                historyText.textContent = 'Recent searches';
            } else {
                historyList.innerHTML = searchHistory.map((search, index) => `
                    <div class="search-history-item" data-search="${encodeURIComponent(search)}" data-index="${index}" tabindex="0">
                        <span class="material-symbols-outlined">search</span>
                        <span class="search-history-item-text">${search}</span>
                        <button class="search-history-item-remove" title="Remove search" tabindex="-1">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                `).join('');
                historyText.textContent = `${searchHistory.length} recent`;
            }
        }
        
        refreshHistory();
        
        // Toggle dropdown
        historyToggle.addEventListener('click', function(e) {
            e.preventDefault();
            const isExpanded = historyToggle.getAttribute('aria-expanded') === 'true';
            if (isExpanded) {
                closeHistoryDropdown();
            } else {
                openHistoryDropdown();
            }
        });
        
        function openHistoryDropdown() {
            historyToggle.setAttribute('aria-expanded', 'true');
            historyMenu.style.display = 'block';
            
            // Focus first item if exists
            const firstItem = historyList.querySelector('.search-history-item');
            if (firstItem) {
                firstItem.focus();
            }
        }
        
        function closeHistoryDropdown() {
            historyToggle.setAttribute('aria-expanded', 'false');
            historyMenu.style.display = 'none';
        }
        
        // Handle history item clicks
        historyList.addEventListener('click', function(e) {
            const item = e.target.closest('.search-history-item');
            const removeBtn = e.target.closest('.search-history-item-remove');
            
            if (removeBtn) {
                e.stopPropagation();
                const index = parseInt(removeBtn.closest('.search-history-item').dataset.index);
                removeFromHistory(index);
            } else if (item) {
                const search = decodeURIComponent(item.dataset.search);
                document.getElementById('find-input').value = search;
                updateMatches(search);
                closeHistoryDropdown();
            }
        });
        
        // Remove specific item from history
        function removeFromHistory(index) {
            searchHistory.splice(index, 1);
            try { localStorage.setItem('md-search-history', JSON.stringify(searchHistory)); } catch (e) {}
            refreshHistory();
        }
        
        // Keyboard navigation
        historyToggle.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                openHistoryDropdown();
            } else if (e.key === 'Escape') {
                closeHistoryDropdown();
            }
        });
        
        historyList.addEventListener('keydown', function(e) {
            const items = Array.from(historyList.querySelectorAll('.search-history-item'));
            const currentIndex = items.findIndex(item => item === document.activeElement);
            
            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    if (currentIndex < items.length - 1) {
                        items[currentIndex + 1].focus();
                    }
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    if (currentIndex > 0) {
                        items[currentIndex - 1].focus();
                    } else {
                        historyToggle.focus();
                    }
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (currentIndex >= 0) {
                        const search = decodeURIComponent(items[currentIndex].dataset.search);
                        document.getElementById('find-input').value = search;
                        updateMatches(search);
                        closeHistoryDropdown();
                    }
                    break;
                case 'Escape':
                    e.preventDefault();
                    closeHistoryDropdown();
                    historyToggle.focus();
                    break;
            }
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-history-dropdown')) {
                closeHistoryDropdown();
            }
        });

        function pushHistory(q) {
            if (!q) return;
            const idx = searchHistory.indexOf(q);
            if (idx !== -1) searchHistory.splice(idx, 1);
            searchHistory.unshift(q);
            if (searchHistory.length > 20) searchHistory.pop();
            try { localStorage.setItem('md-search-history', JSON.stringify(searchHistory)); } catch (e) {}
            refreshHistory();
        }

        // Push on find/replace actions
        if (findNextBtn) findNextBtn.addEventListener('click', function() { const q = document.getElementById('find-input').value; if (q) pushHistory(q); });
        if (replaceBtn) replaceBtn.addEventListener('click', function() { const q = document.getElementById('find-input').value; if (q) pushHistory(q); });
        if (replaceAllBtn) replaceAllBtn.addEventListener('click', function() { const q = document.getElementById('find-input').value; if (q) pushHistory(q); });

        // Settings dialog controls
        document.getElementById('settings-close').addEventListener('click', closeSettings);
        document.getElementById('settings-cancel').addEventListener('click', closeSettings);
        
        // Browser-like settings sidebar navigation
        settingsNavItems = document.querySelectorAll('.settings-nav-item');
        settingsSections = document.querySelectorAll('.settings-section');
        
        // Add click listeners to navigation items
        settingsNavItems.forEach(item => {
            item.addEventListener('click', function() {
                switchSettingsSection(this.dataset.section);
            });
        });
        
        // Add hover effects for navigation items
        settingsNavItems.forEach(item => {
            item.addEventListener('mouseenter', function() {
                if (this.style.color !== '#1967d2') {
                    this.style.background = '#f1f3f4';
                }
            });
            
            item.addEventListener('mouseleave', function() {
                if (this.style.color !== '#1967d2') {
                    this.style.background = 'transparent';
                }
            });
        });
        
        // Theme buttons functionality (legacy buttons removed; keep settings default theme in sync)
        
        // Font size controls
        const fontDecreaseBtn = document.getElementById('font-decrease');
        const fontIncreaseBtn = document.getElementById('font-increase');
        
        fontDecreaseBtn.addEventListener('click', function() {
            if (settings.fontSize > 10) {
                settings.fontSize--;
                updateFontSizeDisplay();
                applySettings();
            }
        });
        
        fontIncreaseBtn.addEventListener('click', function() {
            if (settings.fontSize < 24) {
                settings.fontSize++;
                updateFontSizeDisplay();
                applySettings();
            }
        });
        
        // Font customization functionality
        const fontFamilySelect = document.getElementById('font-family-select');
        const editorFontSelect = document.getElementById('editor-font-select');
        const googleFontsSection = document.getElementById('google-fonts-section');
        const googleFontSearch = document.getElementById('google-font-search');
        const searchFontsBtn = document.getElementById('search-fonts-btn');
        const fontSearchResults = document.getElementById('font-search-results');
        const selectedFontDisplay = document.getElementById('selected-font-display');
        const selectedFontName = document.getElementById('selected-font-name');
        const fontWeightSelect = document.getElementById('font-weight-select');
        const fontStyleSelect = document.getElementById('font-style-select');
        const lineHeightSlider = document.getElementById('line-height-slider');
        const lineHeightDisplay = document.getElementById('line-height-display');
        const fontPreview = document.getElementById('font-preview');
        const editorFontPreview = document.getElementById('editor-font-preview');
        
        // Initialize font settings
        settings.fontFamily = settings.fontFamily || 'system-ui';
        settings.editorFont = settings.editorFont || 'monospace';
        settings.fontWeight = settings.fontWeight || '400';
        settings.fontStyle = settings.fontStyle || 'normal';
        settings.lineHeight = settings.lineHeight || '1.6';
        settings.customGoogleFont = settings.customGoogleFont || '';
        
        // Editor font change handler
        editorFontSelect.addEventListener('change', function() {
            settings.editorFont = this.value;
            applyEditorFont();
            saveSettings();
        });
        
        // Load editor font setting
        function loadEditorFont() {
            try {
                const savedFont = localStorage.getItem('md-editor-font');
                if (savedFont) {
                    settings.editorFont = savedFont;
                    editorFontSelect.value = savedFont;
                    applyEditorFont();
                }
            } catch (e) {
                console.warn('Failed to load editor font:', e);
            }
        }
        
        // Apply editor font
        function applyEditorFont() {
            editor.style.fontFamily = settings.editorFont;
            
            // Update editor font preview
            if (editorFontPreview) {
                editorFontPreview.style.fontFamily = settings.editorFont;
            }
            
            try {
                localStorage.setItem('md-editor-font', settings.editorFont);
            } catch (e) {
                console.warn('Failed to save editor font:', e);
            }
        }
        
        // Load editor font on initialization
        loadEditorFont();
        
        // Font family change handler
        fontFamilySelect.addEventListener('change', function() {
            const value = this.value;
            
            if (value === 'google-fonts') {
                googleFontsSection.style.display = 'block';
                if (settings.customGoogleFont) {
                    selectedFontDisplay.style.display = 'block';
                    selectedFontName.textContent = settings.customGoogleFont;
                    selectedFontName.style.fontFamily = settings.customGoogleFont;
                }
            } else {
                googleFontsSection.style.display = 'none';
                settings.fontFamily = value;
                settings.customGoogleFont = '';
                selectedFontDisplay.style.display = 'none';
                applyFontSettings();
            }
        });
        
        // Google Fonts search functionality
        let selectedGoogleFont = '';
        
        searchFontsBtn.addEventListener('click', searchGoogleFonts);
        googleFontSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchGoogleFonts();
            }
        });
        
        async function searchGoogleFonts() {
            const query = googleFontSearch.value.trim();
            if (!query) return;
            
            searchFontsBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size:16px;">refresh</span>';
            searchFontsBtn.disabled = true;
            
            try {
                const response = await fetch(`https://www.googleapis.com/webfonts/v1/webfonts?key=AIzaSyB69NlBqPvJb4i7aRqG5C3rYzF6m8nK0wE&sort=popularity`);
                if (!response.ok) throw new Error('Failed to fetch fonts');
                
                const data = await response.json();
                const fonts = data.items.filter(font => 
                    font.family.toLowerCase().includes(query.toLowerCase())
                ).slice(0, 10);
                
                displayFontResults(fonts);
            } catch (error) {
                console.error('Error searching fonts:', error);
                fontSearchResults.innerHTML = '<div style="padding:12px;color:#f44336;">Failed to load fonts. Please check your internet connection.</div>';
                fontSearchResults.style.display = 'block';
            } finally {
                searchFontsBtn.innerHTML = 'Search';
                searchFontsBtn.disabled = false;
            }
        }
        
        function displayFontResults(fonts) {
            if (fonts.length === 0) {
                fontSearchResults.innerHTML = '<div style="padding:12px;color:#5f6368;">No fonts found.</div>';
                fontSearchResults.style.display = 'block';
                return;
            }
            
            fontSearchResults.innerHTML = fonts.map(font => `
                <div class="font-result-item" data-font="${font.family}" style="padding:12px;border-bottom:1px solid #dadce0;cursor:pointer;display:flex;align-items:center;justify-content:space-between;">
                    <div>
                        <div style="font-family:'${font.family}';font-size:16px;font-weight:500;">${font.family}</div>
                        <div style="font-size:12px;color:#5f6368;">${font.category}</div>
                    </div>
                    <button class="select-font-btn" data-font="${font.family}" style="padding:6px 12px;background:#1a73e8;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Select</button>
                </div>
            `).join('');
            
            fontSearchResults.style.display = 'block';
            
            // Add click handlers to font items
            document.querySelectorAll('.select-font-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const fontName = this.dataset.font;
                    selectGoogleFont(fontName);
                });
            });
            
            document.querySelectorAll('.font-result-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('select-font-btn')) {
                        const fontName = this.dataset.font;
                        selectGoogleFont(fontName);
                    }
                });
            });
        }
        
        function selectGoogleFont(fontName) {
            selectedGoogleFont = fontName;
            settings.customGoogleFont = fontName;
            settings.fontFamily = fontName;
            
            // Load the font
            loadGoogleFont(fontName);
            
            // Update UI
            selectedFontDisplay.style.display = 'block';
            selectedFontName.textContent = fontName;
            selectedFontName.style.fontFamily = `'${fontName}'`;
            
            // Hide search results
            fontSearchResults.style.display = 'none';
            googleFontSearch.value = '';
            
            // Apply font settings
            applyFontSettings();
            
            updateStatus(`Selected font: ${fontName}`);
        }
        
        function loadGoogleFont(fontName) {
            // Remove existing Google font link if any
            const existingLink = document.getElementById('custom-google-font');
            if (existingLink) {
                existingLink.remove();
            }
            
            // Create and add new font link
            const link = document.createElement('link');
            link.id = 'custom-google-font';
            link.rel = 'stylesheet';
            link.href = `https://fonts.googleapis.com/css2?family=${fontName.replace(/\s+/g, '+')}:wght@100;200;300;400;500;600;700;800;900&display=swap`;
            document.head.appendChild(link);
        }
        
        // Font style controls
        fontWeightSelect.addEventListener('change', function() {
            settings.fontWeight = this.value;
            applyFontSettings();
        });
        
        fontStyleSelect.addEventListener('change', function() {
            settings.fontStyle = this.value;
            applyFontSettings();
        });
        
        lineHeightSlider.addEventListener('input', function() {
            settings.lineHeight = this.value;
            lineHeightDisplay.textContent = this.value;
            applyFontSettings();
        });
        
        function applyFontSettings() {
            const fontFamily = settings.customGoogleFont || settings.fontFamily;
            const fontCss = settings.fontStyle === 'italic' ? 'italic' : 'normal';
            const fontWeight = settings.fontWeight;
            const editorFont = settings.editorFont || 'monospace';

            // Ensure selected font is loaded
            ensureFontLoaded(fontFamily, fontWeight, fontCss);

            // Apply to editor (preserve dedicated editor font selection)
            editor.style.fontFamily = editorFont;
            editor.style.fontWeight = fontWeight;
            editor.style.fontStyle = fontCss;
            editor.style.lineHeight = settings.lineHeight;

            // Apply to preview
            const previewEl = document.getElementById('preview');
            previewEl.style.fontFamily = `'${fontFamily}', system-ui, sans-serif`;
            previewEl.style.fontWeight = fontWeight;
            previewEl.style.fontStyle = fontCss;
            previewEl.style.lineHeight = settings.lineHeight;

            // Update font preview
            fontPreview.style.fontFamily = `'${fontFamily}', system-ui, sans-serif`;
            fontPreview.style.fontWeight = fontWeight;
            fontPreview.style.fontStyle = fontCss;
            fontPreview.style.lineHeight = settings.lineHeight;

            // Keep the editor font preview in sync with the selected editor font
            if (editorFontPreview) {
                editorFontPreview.style.fontFamily = editorFont;
            }

            // Save settings
            saveFontSettings();
        }

        function ensureFontLoaded(fontFamily, fontWeight, fontStyle) {
            const webSafeFonts = ['system-ui', 'Arial', 'Helvetica', 'Times New Roman', 'Georgia', 'Courier New', 'monospace'];

            if (webSafeFonts.includes(fontFamily)) {
                return;
            }

            // Try using WebFont Loader if available
            if (window.WebFont) {
                const variants = [];
                if (fontWeight) {
                    variants.push(fontWeight + (fontStyle === 'italic' ? 'italic' : ''));
                }
                WebFont.load({
                    google: {
                        families: [`${fontFamily}${variants.length ? ':' + variants.join(',') : ''}`]
                    }
                });
                return;
            }

            // Fallback: inject Google Fonts link if not already present
            const fontKey = `${fontFamily}-${fontWeight}-${fontStyle}`;
            if (document.querySelector(`link[data-dynamic-font="${fontKey}"]`)) {
                return;
            }

            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.setAttribute('data-dynamic-font', fontKey);
            const weightParam = fontWeight ? `:wght@${fontWeight}` : '';
            const italicParam = fontStyle === 'italic' && !weightParam ? ':ital@1' : '';
            const weightItalicParam = fontStyle === 'italic' && weightParam ? `:ital,wght@1,${fontWeight}` : weightParam;
            const variantParam = weightItalicParam || italicParam;
            link.href = `https://fonts.googleapis.com/css2?family=${fontFamily.replace(/\s+/g, '+')}${variantParam}&display=swap`;
            document.head.appendChild(link);
        }
        
        function saveFontSettings() {
            try {
                localStorage.setItem('md-font-family', settings.fontFamily);
                localStorage.setItem('md-custom-google-font', settings.customGoogleFont);
                localStorage.setItem('md-font-weight', settings.fontWeight);
                localStorage.setItem('md-font-style', settings.fontStyle);
                localStorage.setItem('md-line-height', settings.lineHeight);
            } catch (e) {}
        }
        
        function loadFontSettings() {
            try {
                settings.fontFamily = localStorage.getItem('md-font-family') || 'system-ui';
                settings.customGoogleFont = localStorage.getItem('md-custom-google-font') || '';
                settings.fontWeight = localStorage.getItem('md-font-weight') || '400';
                settings.fontStyle = localStorage.getItem('md-font-style') || 'normal';
                settings.lineHeight = localStorage.getItem('md-line-height') || '1.6';
                
                // Update UI controls
                fontWeightSelect.value = settings.fontWeight;
                fontStyleSelect.value = settings.fontStyle;
                lineHeightSlider.value = settings.lineHeight;
                lineHeightDisplay.textContent = settings.lineHeight;
                
                if (settings.customGoogleFont) {
                    fontFamilySelect.value = 'google-fonts';
                    googleFontsSection.style.display = 'block';
                    selectedFontDisplay.style.display = 'block';
                    selectedFontName.textContent = settings.customGoogleFont;
                    loadGoogleFont(settings.customGoogleFont);
                } else {
                    fontFamilySelect.value = settings.fontFamily;
                    googleFontsSection.style.display = 'none';
                }
                
                applyFontSettings();
            } catch (e) {}
        }
        
        // Load font settings when settings are opened
        loadFontSettings();
        
        // Setup all toggle switches
        setupToggleSwitch('auto-save');
        setupToggleSwitch('word-wrap');
        setupToggleSwitch('live-preview');
        setupToggleSwitch('preview-editing');
        setupToggleSwitch('preview-word-wrap');
        setupToggleSwitch('developer-mode');
        document.getElementById('settings-save').addEventListener('click', function() {
            // Save settings from dialog
            settings.autoSave = document.getElementById('auto-save').checked;
            settings.wordWrap = document.getElementById('word-wrap').checked;
            settings.livePreview = document.getElementById('live-preview').checked;
            settings.previewEditing = document.getElementById('preview-editing').checked;
            settings.previewWordWrap = document.getElementById('preview-word-wrap').checked;
            settings.saveLocation = document.getElementById('save-location').value;
            settings.developerMode = document.getElementById('developer-mode').checked;
            
            saveSettings();
            applySettings();
            closeSettings();
            customAlert('Settings saved successfully!');
        });

        // Preview editing change listener for live preview
        document.getElementById('preview-editing').addEventListener('change', function() {
            settings.previewEditing = this.checked;
            applySettings();
        });

        // Word wrap change listener for live preview
        document.getElementById('word-wrap').addEventListener('change', function() {
            settings.wordWrap = this.checked;
            applySettings();
        });

        // Auto-save change listener for live preview
        document.getElementById('auto-save').addEventListener('change', function() {
            settings.autoSave = this.checked;
            applySettings();
        });

        // Live preview change listener for live preview
        document.getElementById('live-preview').addEventListener('change', function() {
            settings.livePreview = this.checked;
            applySettings();
        });

        // Preview word wrap change listener for live preview
        document.getElementById('preview-word-wrap').addEventListener('change', function() {
            settings.previewWordWrap = this.checked;
            applySettings();
        });

        // Settings export/import/reset buttons
        document.getElementById('export-settings').addEventListener('click', exportSettings);
        document.getElementById('import-settings').addEventListener('click', importSettings);
        document.getElementById('reset-settings').addEventListener('click', resetSettings);
        
        // Mode selection reset button (Beta Feature)
        const resetModeBtn = document.getElementById('reset-mode-btn');
        if (resetModeBtn) {
            resetModeBtn.addEventListener('click', resetModeSelection);
        }
        
        // Extensions settings event handlers
        document.getElementById('browse-extensions').addEventListener('click', function() {
            // Close settings and open extensions dialog
            document.getElementById('settings-dialog').style.display = 'none';
            document.getElementById('popup-overlay').style.display = 'none';
            document.getElementById('extensions-dialog').style.display = 'block';
            document.getElementById('popup-overlay').style.display = 'block';
        });
        
        document.getElementById('clear-extensions').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all extensions and their data? This action cannot be undone.')) {
                try {
                    // Clear extension data from localStorage
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('ext-') || key.startsWith('extension-')) {
                            localStorage.removeItem(key);
                        }
                    });
                    
                    // Reset permission toggles
                    document.getElementById('ext-file-access').checked = false;
                    document.getElementById('ext-network-access').checked = false;
                    document.getElementById('ext-clipboard-access').checked = false;
                    document.getElementById('ext-theme-access').checked = false;
                    
                    updateStatus('All extensions and data cleared successfully');
                } catch (e) {
                    updateStatus('Failed to clear extensions data');
                }
            }
        });
        
        // Extension permission toggles
        document.getElementById('ext-file-access').addEventListener('change', function() {
            localStorage.setItem('ext-permission-file-access', this.checked);
            updateStatus(`File system access ${this.checked ? 'enabled' : 'disabled'} for extensions`);
        });
        
        document.getElementById('ext-network-access').addEventListener('change', function() {
            localStorage.setItem('ext-permission-network-access', this.checked);
            updateStatus(`Network access ${this.checked ? 'enabled' : 'disabled'} for extensions`);
        });
        
        document.getElementById('ext-clipboard-access').addEventListener('change', function() {
            localStorage.setItem('ext-permission-clipboard-access', this.checked);
            updateStatus(`Clipboard access ${this.checked ? 'enabled' : 'disabled'} for extensions`);
        });
        
        document.getElementById('ext-theme-access').addEventListener('change', function() {
            localStorage.setItem('ext-permission-theme-access', this.checked);
            updateStatus(`Theme modifications ${this.checked ? 'enabled' : 'disabled'} for extensions`);
        });
        
        // Load extension permission settings
        function loadExtensionPermissions() {
            document.getElementById('ext-file-access').checked = localStorage.getItem('ext-permission-file-access') === 'true';
            document.getElementById('ext-network-access').checked = localStorage.getItem('ext-permission-network-access') === 'true';
            document.getElementById('ext-clipboard-access').checked = localStorage.getItem('ext-permission-clipboard-access') === 'true';
            document.getElementById('ext-theme-access').checked = localStorage.getItem('ext-permission-theme-access') === 'true';
        }
        
        // Load permissions when settings are opened
        loadExtensionPermissions();
        
        // Clear search history button
        document.getElementById('clear-search-history').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all search history? This action cannot be undone.')) {
                try {
                    localStorage.removeItem('md-search-history');
                    searchHistory = [];
                    refreshHistory();
                    updateStatus('Search history cleared successfully');
                } catch (e) {
                    updateStatus('Failed to clear search history');
                }
            }
        });

        // View mode buttons
        document.getElementById('split-btn').addEventListener('click', function() { setViewMode('split'); });
        document.getElementById('editor-btn').addEventListener('click', function() { setViewMode('editor'); });
        document.getElementById('preview-btn').addEventListener('click', function() { setViewMode('preview'); });
    });

    // Extend keyboard shortcuts
    function handleKeyboardShortcuts(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'n':
                    e.preventDefault();
                    newFile();
                    break;
                case 'o':
                    e.preventDefault();
                    openFile();
                    break;
                case 's':
                    e.preventDefault();
                    saveFile();
                    break;
                case 'z':
                    e.preventDefault();
                    if (e.shiftKey) {
                        redo();
                    } else {
                        undo();
                    }
                    break;
                case 'b':
                    e.preventDefault();
                    insertMarkdown('**', '**');
                    break;
                case 'i':
                    e.preventDefault();
                    insertMarkdown('*', '*');
                    break;
                case 'f':
                    e.preventDefault();
                    toggleFindReplace();
                    break;
                case 'h':
                    e.preventDefault();
                    // open and focus replace field
                    toggleFindReplace();
                    document.getElementById('replace-input').focus();
                    break;
            }
        }
    }

    // Emoji map for conversion
    const emojiMap = {
        // Smileys & Emotion
        ':smile:': '😊', ':grin:': '😀', ':joy:': '😂', ':laughing:': '😆', ':blush:': '😊',
        ':smiley:': '😃', ':relaxed:': '☺️', ':wink:': '😉', ':heart_eyes:': '😍', ':kissing_heart:': '😘',
        ':kissing:': '😗', ':stuck_out_tongue:': '😛', ':stuck_out_tongue_winking_eye:': '😜', ':stuck_out_tongue_closed_eyes:': '😝',
        ':neutral_face:': '😐', ':expressionless:': '😑', ':confused:': '😕', ':thinking:': '🤔',
        ':smirk:': '😏', ':unamused:': '😒', ':disappointed:': '😞', ':pensive:': '😔', ':worried:': '😟',
        ':cry:': '😢', ':sob:': '😭', ':scream:': '😱', ':angry:': '😠', ':rage:': '😡',
        ':sleeping:': '😴', ':mask:': '😷', ':sunglasses:': '😎', ':dizzy_face:': '😵', ':astonished:': '😲',
        ':flushed:': '😳', ':cold_sweat:': '😰', ':sweat:': '😅', ':tired_face:': '😫',
        ':triumph:': '😤', ':persevere:': '😣', ':fearful:': '😨', ':open_mouth:': '😮',
        ':hushed:': '😯', ':frowning:': '☹️', ':anguished:': '😧', ':grimacing:': '😬',
        ':rolling_eyes:': '🙄', ':upside_down:': '🙃', ':zipper_mouth:': '🤐', ':nerd:': '🤓',
        ':star_struck:': '🤩', ':partying:': '🥳', ':pleading:': '🥺', ':yawning:': '🥱',
        
        // Hearts
        ':heart:': '❤️', ':orange_heart:': '🧡', ':yellow_heart:': '💛', ':green_heart:': '💚',
        ':blue_heart:': '💙', ':purple_heart:': '💜', ':black_heart:': '🖤', ':white_heart:': '🤍',
        ':brown_heart:': '🤎', ':broken_heart:': '💔', ':sparkling_heart:': '💖', ':two_hearts:': '💕',
        
        // Gestures & Body Parts
        ':+1:': '👍', ':thumbsup:': '👍', ':-1:': '👎', ':thumbsdown:': '👎', ':ok_hand:': '👌',
        ':wave:': '👋', ':clap:': '👏', ':raised_hands:': '🙌', ':pray:': '🙏', ':muscle:': '💪',
        ':point_up:': '☝️', ':point_down:': '👇', ':point_left:': '👈', ':point_right:': '👉',
        ':v:': '✌️', ':fist:': '✊', ':facepunch:': '👊', ':raised_hand:': '✋',
        
        // People
        ':man:': '👨', ':woman:': '👩', ':boy:': '👦', ':girl:': '👧', ':baby:': '👶',
        ':older_man:': '👴', ':older_woman:': '👵', ':family:': '👪', ':couple:': '👫',
        
        // Nature & Animals
        ':dog:': '🐶', ':cat:': '🐱', ':mouse:': '🐭', ':hamster:': '🐹', ':rabbit:': '🐰',
        ':fox:': '🦊', ':bear:': '🐻', ':panda:': '🐼', ':koala:': '🐨', ':tiger:': '🐯',
        ':lion:': '🦁', ':cow:': '🐮', ':pig:': '🐷', ':frog:': '🐸', ':monkey:': '🐵',
        ':chicken:': '🐔', ':penguin:': '🐧', ':bird:': '🐦', ':duck:': '🦆', ':eagle:': '🦅',
        ':owl:': '🦉', ':bat:': '🦇', ':wolf:': '🐺', ':horse:': '🐴', ':unicorn:': '🦄',
        ':bee:': '🐝', ':bug:': '🐛', ':butterfly:': '🦋', ':snail:': '🐌', ':shell:': '🐚',
        ':snake:': '🐍', ':dragon:': '🐉', ':turtle:': '🐢', ':fish:': '🐟', ':dolphin:': '🐬',
        ':whale:': '🐋', ':shark:': '🦈', ':octopus:': '🐙', ':crab:': '🦀', ':shrimp:': '🦐',
        
        // Food & Drink
        ':apple:': '🍎', ':banana:': '🍌', ':grapes:': '🍇', ':strawberry:': '🍓', ':watermelon:': '🍉',
        ':orange:': '🍊', ':lemon:': '🍋', ':cherries:': '🍒', ':peach:': '🍑', ':pineapple:': '🍍',
        ':tomato:': '🍅', ':avocado:': '🥑', ':eggplant:': '🍆', ':potato:': '🥔', ':carrot:': '🥕',
        ':corn:': '🌽', ':hot_pepper:': '🌶️', ':cucumber:': '🥒', ':broccoli:': '🥦',
        ':bread:': '🍞', ':croissant:': '🥐', ':baguette:': '🥖', ':pretzel:': '🥨',
        ':pizza:': '🍕', ':hamburger:': '🍔', ':fries:': '🍟', ':hotdog:': '🌭', ':taco:': '🌮',
        ':burrito:': '🌯', ':sandwich:': '🥪', ':popcorn:': '🍿', ':cookie:': '🍪', ':cake:': '🍰',
        ':birthday:': '🎂', ':doughnut:': '🍩', ':icecream:': '🍦', ':chocolate:': '🍫', ':candy:': '🍬',
        ':coffee:': '☕', ':tea:': '🍵', ':beer:': '🍺', ':wine:': '🍷', ':cocktail:': '🍹',
        
        // Activities & Sports
        ':soccer:': '⚽', ':basketball:': '🏀', ':football:': '🏈', ':baseball:': '⚾', ':tennis:': '🎾',
        ':volleyball:': '🏐', ':rugby:': '🏉', ':golf:': '⛳', ':trophy:': '🏆', ':medal:': '🏅',
        ':running:': '🏃', ':dancer:': '💃', ':bicyclist:': '🚴', ':swimmer:': '🏊',
        ':guitar:': '🎸', ':microphone:': '🎤', ':headphones:': '🎧', ':musical_note:': '🎵',
        ':game_die:': '🎲', ':dart:': '🎯', ':video_game:': '🎮', ':slot_machine:': '🎰',
        
        // Travel & Places
        ':car:': '🚗', ':taxi:': '🚕', ':bus:': '🚌', ':train:': '🚆', ':airplane:': '✈️',
        ':rocket:': '🚀', ':bike:': '🚲', ':boat:': '⛵', ':ship:': '🚢', ':helicopter:': '🚁',
        ':house:': '🏠', ':office:': '🏢', ':hospital:': '🏥', ':school:': '🏫', ':hotel:': '🏨',
        ':bank:': '🏦', ':church:': '⛪', ':mountain:': '⛰️', ':beach:': '🏖️', ':desert:': '🏜️',
        ':island:': '🏝️', ':camping:': '🏕️', ':tent:': '⛺', ':bridge:': '🌉',
        ':earth_americas:': '🌎', ':earth_africa:': '🌍', ':earth_asia:': '🌏', ':globe:': '🌐',
        
        // Objects
        ':watch:': '⌚', ':phone:': '📱', ':computer:': '💻', ':keyboard:': '⌨️', ':printer:': '🖨️',
        ':mouse_computer:': '🖱️', ':trackball:': '🖲️', ':camera:': '📷', ':video_camera:': '📹',
        ':tv:': '📺', ':radio:': '📻', ':microphone2:': '🎙️', ':telephone:': '☎️',
        ':battery:': '🔋', ':electric_plug:': '🔌', ':bulb:': '💡', ':flashlight:': '🔦',
        ':candle:': '🕯️', ':fire:': '🔥', ':bomb:': '💣', ':firecracker:': '🧨',
        ':mag:': '🔍', ':mag_right:': '🔎', ':lock:': '🔒', ':unlock:': '🔓', ':key:': '🔑',
        ':hammer:': '🔨', ':axe:': '🪓', ':wrench:': '🔧', ':nut_and_bolt:': '🔩',
        ':link:': '🔗', ':paperclip:': '📎', ':pushpin:': '📌', ':scissors:': '✂️',
        ':pencil:': '✏️', ':pen:': '🖊️', ':paintbrush:': '🖌️', ':crayon:': '🖍️',
        ':book:': '📖', ':notebook:': '📓', ':ledger:': '📒', ':bookmark:': '🔖',
        ':briefcase:': '💼', ':file_folder:': '📁', ':calendar:': '📅', ':clipboard:': '📋',
        ':newspaper:': '📰', ':envelope:': '✉️', ':package:': '📦', ':gift:': '🎁',
        ':moneybag:': '💰', ':dollar:': '💵', ':credit_card:': '💳', ':gem:': '💎',
        
        // Symbols
        ':check:': '✅', ':x:': '❌', ':warning:': '⚠️', ':bangbang:': '‼️', ':question:': '❓',
        ':white_check_mark:': '✅', ':heavy_check_mark:': '✔️', ':ballot_box_with_check:': '☑️',
        ':star:': '⭐', ':sparkles:': '✨', ':zap:': '⚡', ':boom:': '💥', ':fire:': '🔥',
        ':recycle:': '♻️', ':infinity:': '♾️', ':peace:': '☮️', ':tm:': '™️', ':copyright:': '©️',
        ':registered:': '®️', ':arrow_up:': '⬆️', ':arrow_down:': '⬇️', ':arrow_left:': '⬅️',
        ':arrow_right:': '➡️', ':arrow_upper_right:': '↗️', ':arrow_lower_right:': '↘️',
        ':arrow_lower_left:': '↙️', ':arrow_upper_left:': '↖️',
        ':+:': '➕', ':-:': '➖', ':heavy_multiplication_x:': '✖️', ':heavy_division_sign:': '➗',
        
        // Weather & Nature
        ':sunny:': '☀️', ':cloud:': '☁️', ':umbrella:': '☂️', ':snowflake:': '❄️', ':snowman:': '⛄',
        ':zap:': '⚡', ':cyclone:': '🌀', ':rainbow:': '🌈', ':ocean:': '🌊',
        ':droplet:': '💧', ':sweat_drops:': '💦', ':boom:': '💥', ':fire:': '🔥',
        ':seedling:': '🌱', ':evergreen:': '🌲', ':palm_tree:': '🌴', ':cactus:': '🌵',
        ':tulip:': '🌷', ':cherry_blossom:': '🌸', ':rose:': '🌹', ':sunflower:': '🌻',
        ':blossom:': '🌼', ':bouquet:': '💐', ':mushroom:': '🍄', ':leaves:': '🍃',
        
        // Flags (limited selection)
        ':flag_us:': '🇺🇸', ':flag_uk:': '🇬🇧', ':flag_jp:': '🇯🇵', ':flag_kr:': '🇰🇷',
        ':flag_cn:': '🇨🇳', ':flag_fr:': '🇫🇷', ':flag_de:': '🇩🇪', ':flag_es:': '🇪🇸',
        ':flag_it:': '🇮🇹', ':flag_br:': '🇧🇷', ':flag_ca:': '🇨🇦', ':flag_au:': '🇦🇺'
    };

    // Markdown parsing function - converts markdown to HTML
    function parseMarkdown(markdown) {
        let html = markdown;
        
        // Check if Extended Markdown extension is enabled
        const isExtendedMarkdownEnabled = localStorage.getItem('ext-extended-markdown') !== 'disabled';
        
        // Check if GitHub Flavored Markdown extension is enabled
        const isGfmEnabled = localStorage.getItem('ext-gfm') !== 'disabled';

        // Footnotes: collect definitions like [^id]: text (+ indented continuations)
        const footnoteDefs = {};
        const usedFootnoteOrder = [];
        if (isExtendedMarkdownEnabled) {
            html = html.replace(/^\[\^([^\]]+)\]:[ \t]+(.+)(?:\r?\n(?:(?:    |\t).+))*?/gm, function(match, id) {
                const lines = match.split(/\r?\n/);
                let first = lines[0].replace(/^\[\^[^\]]+\]:[ \t]+/, '');
                const rest = lines.slice(1).map(l => l.replace(/^(?:    |\t)/, '')).join('\n');
                footnoteDefs[id] = (first + (rest ? '\n' + rest : ''));
                return '';
            });
        }

        // Handle escaped characters first
        html = html.replace(/\\([\\`\*_{}\[\]()#+\-.!|])/g, function(match, p1) { return '@@ESCAPED:' + p1.charCodeAt(0).toString(16) + '@@'; });

        // Handle tables first (with alignment)
        html = html.replace(/^\|(.+)\r?\n\|([ \t:-]+\|)+\s*\r?\n((?:\|.*\r?\n?)*)/gm, (match) => {
            const lines = match.trim().split('\n');
            const headerLine = lines.shift();
            const separatorLine = lines.shift() || '';

            // A small helper to parse inline markdown within cells
            const parseCell = (cell) => {
                let result = cell.trim()
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/~~(.*?)~~/g, '<del>$1</del>')
                    .replace(/`([^`]+)`/g, '<code>$1</code>')
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
                
                // Only apply superscript/subscript if Extended Markdown is enabled
                if (isExtendedMarkdownEnabled) {
                    result = result
                        .replace(/\^([^\^]+)\^/g, '<sup>$1</sup>')
                        .replace(/~([^~]+)~/g, '<sub>$1</sub>');
                }
                return result;
            };

            // Determine alignment per column based on separator line
            const sepCells = separatorLine.split('|').slice(1, -1).map(s => s.trim());
            const alignClasses = sepCells.map(s => {
                const left = s.startsWith(':');
                const right = s.endsWith(':');
                if (left && right) return 'align-center';
                if (right) return 'align-right';
                if (left) return 'align-left';
                return '';
            });

            const headerCells = headerLine.split('|').slice(1, -1).map(parseCell);
            
            let tableHtml = '<table><thead><tr>';
            headerCells.forEach((cell, idx) => {
                const cls = alignClasses[idx] || '';
                tableHtml += cls ? `<th class="${cls}">${cell}</th>` : `<th>${cell}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';

            lines.forEach(rowStr => {
                if (!rowStr) return;
                const rowCells = rowStr.split('|').slice(1, -1).map(parseCell);
                tableHtml += '<tr>';
                rowCells.forEach((cell, idx) => {
                    const cls = alignClasses[idx] || '';
                    tableHtml += cls ? `<td class="${cls}">${cell}</td>` : `<td>${cell}</td>`;
                });
                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table>';
            return `\n${tableHtml}\n`; // Add newlines to help with paragraph separation
        });

        // Blockquotes: support nested blockquotes using multiple > at line start
        function parseBlockquotes(text) {
            const lines = text.split(/\r?\n/);
            let result = [];
            let buffer = [];
            let lastLevel = 0;
            function flush(level) {
                if (buffer.length === 0) return;
                let content = buffer.join('\n');
                if (lastLevel > 0) {
                    // Process headings within the blockquote content (longest to shortest to avoid partial matches)
                    content = content
                        .replace(/^###### (.*$)/gm, '<h6>$1</h6>')
                        .replace(/^##### (.*$)/gm, '<h5>$1</h5>')
                        .replace(/^#### (.*$)/gm, '<h4>$1</h4>')
                        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                        .replace(/^# (.*$)/gm, '<h1>$1</h1>');
                    
                    // Also process any nested blockquotes
                    content = parseBlockquotes(content);
                    for (let i = 0; i < lastLevel; i++) {
                        content = `<blockquote>${content}</blockquote>`;
                    }
                }
                result.push(content);
                buffer = [];
            }
            for (let line of lines) {
                const match = line.match(/^(>+)( ?)(.*)$/);
                if (match) {
                    const level = match[1].length;
                    if (lastLevel !== 0 && level !== lastLevel) {
                        flush(lastLevel);
                    }
                    buffer.push(match[3]);
                    lastLevel = level;
                } else {
                    flush(lastLevel);
                    result.push(line);
                    lastLevel = 0;
                }
            }
            flush(lastLevel);
            return result.join('\n');
        }
        html = parseBlockquotes(html);

        // Original parsing logic continues here...
        html = html
            // Headers (must be ordered from longest to shortest to avoid partial matches)
            .replace(/^###### (.*$)/gm, '<h6>$1</h6>')
            .replace(/^##### (.*$)/gm, '<h5>$1</h5>')
            .replace(/^#### (.*$)/gm, '<h4>$1</h4>')
            .replace(/^### (.*$)/gm, '<h3>$1</h3>')
            .replace(/^## (.*$)/gm, '<h2>$1</h2>')
            .replace(/^# (.*$)/gm, '<h1>$1</h1>')
            // Horizontal rules (---, ***, ___ on their own line)
            .replace(/^(?:---|\*\*\*|___)\s*$/gm, '<hr>')
            
            // Bold, italic, etc. (will now only apply outside of tables)
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/~~(.*?)~~/g, '<del>$1</del>');
            
        // Code blocks with syntax highlighting (if extension is enabled)
        const isSyntaxHighlighterEnabled = localStorage.getItem('ext-syntax-highlighter') !== 'disabled';
        
        html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
            const escapedCode = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            if (isSyntaxHighlighterEnabled && lang && typeof Prism !== 'undefined') {
                // Map common language aliases
                const langMap = {
                    'js': 'javascript',
                    'ts': 'typescript',
                    'py': 'python',
                    'rb': 'ruby',
                    'sh': 'bash',
                    'html': 'markup',
                    'xml': 'markup',
                    'cs': 'csharp'
                };
                const normalizedLang = langMap[lang.toLowerCase()] || lang.toLowerCase();
                
                // Check if language is supported by Prism
                if (Prism.languages[normalizedLang]) {
                    try {
                        const highlighted = Prism.highlight(code, Prism.languages[normalizedLang], normalizedLang);
                        return `<pre><code class="language-${normalizedLang}">${highlighted}</code></pre>`;
                    } catch (e) {
                        // Fallback to non-highlighted if error occurs
                        return `<pre><code class="language-${normalizedLang}">${escapedCode}</code></pre>`;
                    }
                } else {
                    return `<pre><code class="language-${normalizedLang}">${escapedCode}</code></pre>`;
                }
            } else {
                // No syntax highlighting - basic code block
                if (lang) {
                    return `<pre><code class="language-${lang}">${escapedCode}</code></pre>`;
                }
                return `<pre><code>${escapedCode}</code></pre>`;
            }
        });
        
        html = html.replace(/`([^`]+)`/g, '<code>$1</code>')
            
            // Links & Images (with optional positioning {left}, {right}, {center})
            .replace(/!\[([^\]]*)\]\(([^)]+?)(?:\s+"([^"]*)")?\)(?:\{(left|right|center)\})?/g, function(match, alt, url, title, position) {
                let info = (alt && alt.trim()) || (title && title.trim());
                let posClass = position ? ` class="img-${position}"` : '';
                let imgTag = `<img src="${url}" alt="${alt || ''}"${title ? ` title="${title}"` : ''}${posClass}>`;
                if (info) {
                    return `<span class="md-img-info-wrap">${imgTag}<span class="md-img-info-badge" title="Image info">i</span></span>`;
                } else {
                    return imgTag;
                }
            })
            .replace(/\[([^\]]+)\]\(([^)]+?)(?:\s+"([^"]*)")?\)/g, function(match, text, url, title) {
                const t = title ? ` title="${title}"` : '';
                return `<a href="${url}"${t}>${text}</a>`;
            })
            // Autolink bare URLs
            .replace(/(^|[^"'=])(https?:\/\/[\w\-._~:\/?#\[\]@!$&'()*+,;=%]+)/g, function(m, lead, url) {
                return `${lead}<a href="${url}">${url}</a>`;
            })
            // Autolink emails
            .replace(/(^|\s)([A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,})/g, function(m, lead, email) {
                return `${lead}<a href="mailto:${email}">${email}</a>`;
            })
            // Clear floats syntax: ---clear--- or +++clear+++
            .replace(/^(?:---clear---|[+]{3}clear[+]{3})\s*$/gm, '<div class="img-clear"></div>');

        // Superscript and Subscript (Extended Markdown only)
        if (isExtendedMarkdownEnabled) {
            html = html
                .replace(/\^([^\^\n]+)\^/g, '<sup>$1</sup>')
                .replace(/~([^~\n]+)~/g, '<sub>$1</sub>');
        }

        // Definition lists (Extended Markdown only)
        if (isExtendedMarkdownEnabled) {
            html = html.replace(/(^|\n)([^\n]+)\n(:[ \t].+(?:\n:[ \t].+)*)/g, function(match, leading, term, defs) {
                if (/^\s*#/.test(term) || /^\s*([\-*+]|\d+\.)\s/.test(term)) return match;
                const dd = defs.split(/\n/).map(d => d.replace(/^:[ \t]?/, '')).join(' ');
                return `${leading}<dl><dt>${term.trim()}</dt><dd>${dd.trim()}</dd></dl>`;
            });
        }

        // A more robust list processing logic that handles blocks directly.
        // Unordered lists (supports task list items like - [ ] and - [x] if Extended Markdown or GitHub Flavored Markdown is enabled)
        html = html.replace(/((?:^[\*\-\+] .*$\r?\n?)+)/gm, (match) => {
            const items = match.trim().split('\n').map(line => {
                let content = line.substring(2);
                // Parse task lists if Extended Markdown OR GitHub Flavored Markdown is enabled
                if (isExtendedMarkdownEnabled || isGfmEnabled) {
                    const task = content.match(/^\[( |x|X)\][ \t]+(.*)$/);
                    if (task) {
                        const checked = /x/i.test(task[1]) ? ' checked' : '';
                        const label = task[2];
                        // Make checkboxes interactive (not disabled) and add data attribute for tracking
                        return `<li class="task-item"><input type="checkbox" class="task-checkbox" data-task-label="${label.replace(/"/g, '&quot;')}"${checked}> ${label}</li>`;
                    }
                }
                return `<li>${content}</li>`;
            }).join('');
            return `<ul class="task-list">${items}</ul>`;
        });

        // Ordered lists
        html = html.replace(/((?:^\d+\. .*$\r?\n?)+)/gm, (match) => {
            const items = match.trim().split('\n').map(line => `<li>${line.replace(/^\d+\.\s*/, '')}</li>`).join('');
            return `<ol>${items}</ol>`;
        });

        // Line breaks and paragraphs
        html = html.replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>');

        // Wrap in paragraphs and fix lists
        html = '<p>' + html.trim() + '</p>';
        
        // Cleanup: Remove <p> tags that incorrectly wrap block elements like tables or hr
        html = html.replace(/<p>\s*(<(table|ul|ol|pre|blockquote|h[1-6]|hr))/g, '$1');
        html = html.replace(/(<\/(table|ul|ol|pre|blockquote|h[1-6])>|<hr>)\s*<\/p>/g, '$1');

        html = html.replace(/<\/p><p>(<li>.*?<\/li>)<\/p><p>/g, '<ul>$1</ul>');
        html = html.replace(/<\/li><br><li>/g, '</li><li>');
        
        // Fix empty paragraphs
        html = html.replace(/<p>\s*<\/p>/g, '');
        html = html.replace(/<p><br><\/p>/g, '');

        // Footnote references [^id] (Extended Markdown only)
        if (isExtendedMarkdownEnabled) {
            html = html.replace(/\[\^([^\]]+)\]/g, function(m, id) {
                const idx = usedFootnoteOrder.indexOf(id);
                if (idx === -1) usedFootnoteOrder.push(id);
                const num = usedFootnoteOrder.indexOf(id) + 1;
                return `<sup class="footnote-ref"><a href="#fn-${id}" id="fnref-${id}">${num}</a></sup>`;
            });

            if (usedFootnoteOrder.length > 0) {
                let footHtml = '<section class="footnotes"><hr><ol>';
                usedFootnoteOrder.forEach((id) => {
                    const def = footnoteDefs[id] || '';
                    let inner = def
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/~~(.*?)~~/g, '<del>$1</del>')
                        .replace(/`([^`]+)`/g, '<code>$1</code>')
                        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
                    
                    // Apply superscript/subscript in footnotes if Extended Markdown is enabled
                    inner = inner
                        .replace(/\^([^\^\n]+)\^/g, '<sup>$1</sup>')
                        .replace(/~([^~\n]+)~/g, '<sub>$1</sub>');
                    
                    footHtml += `<li id="fn-${id}">${inner} <a href="#fnref-${id}" class="footnote-backref" aria-label="Back to content">↩</a></li>`;
                });
                footHtml += '</ol></section>';
                html += footHtml;
            }
        }

        // Convert emoji shortcodes to emojis
        html = html.replace(/:([a-z0-9_+-]+):/g, function(match, emojiName) {
            const emojiCode = ':' + emojiName + ':';
            return emojiMap[emojiCode] || match;
        });

        // Restore escaped characters
        html = html.replace(/@@ESCAPED:([0-9a-f]+)@@/gi, function(match, p1) { return String.fromCharCode(parseInt(p1, 16)); });

        return html;
    }
    
    // Toggle formatting when button is clicked - works for both editor and preview selections
    function toggleFormattingButton(startMark, endMark, htmlTag) {
        const selection = window.getSelection();
        
        // Check if selection is in preview pane
        if (selection.rangeCount > 0 && !selection.isCollapsed) {
            const range = selection.getRangeAt(0);
            const container = range.commonAncestorContainer;
            const isInPreview = preview.contains(container.nodeType === 3 ? container.parentNode : container);
            
            if (isInPreview) {
                // Toggle formatting in preview
                togglePreviewFormatting(startMark, endMark, htmlTag);
                return;
            }
        }
        
        // Default behavior: insert in editor
        insertMarkdown(startMark, endMark);
    }
    
    // Toggle formatting in preview and sync back to editor
    function togglePreviewFormatting(startMark, endMark, htmlTag) {
        const selection = window.getSelection();
        if (!selection.rangeCount) return;
        
        const range = selection.getRangeAt(0);
        const container = range.commonAncestorContainer;
        let element = container.nodeType === 3 ? container.parentNode : container;
        
        // Map of possible alternative tags
        const tagAlternatives = {
            'strong': ['strong', 'b'],
            'em': ['em', 'i'],
            'del': ['del', 's', 'strike'],
            'code': ['code']
        };
        
        const possibleTags = tagAlternatives[htmlTag.toLowerCase()] || [htmlTag.toLowerCase()];
        
        // Check if selection is already inside the target formatting tag
        let isFormatted = false;
        let formattedElement = null;
        let tempElement = element;
        
        while (tempElement && tempElement !== preview) {
            if (tempElement.tagName) {
                const tagName = tempElement.tagName.toLowerCase();
                if (possibleTags.includes(tagName)) {
                    isFormatted = true;
                    formattedElement = tempElement;
                    break;
                }
            }
            tempElement = tempElement.parentNode;
        }
        
        if (isFormatted && formattedElement) {
            // Remove formatting: unwrap the element
            const textContent = formattedElement.textContent;
            const textNode = document.createTextNode(textContent);
            formattedElement.parentNode.replaceChild(textNode, formattedElement);
        } else {
            // Add formatting: wrap selection in the tag
            const selectedText = range.toString();
            if (selectedText) {
                const wrapper = document.createElement(htmlTag);
                wrapper.textContent = selectedText;
                range.deleteContents();
                range.insertNode(wrapper);
            }
        }
        
        // Sync preview changes back to editor
        syncPreviewToEditor();
    }
    
    // Attach event listeners to task checkboxes in preview to make them interactive
    function attachTaskCheckboxListeners() {
        const checkboxes = preview.querySelectorAll('.task-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function(e) {
                e.stopPropagation();
                isTogglingCheckbox = true;
                
                const label = this.getAttribute('data-task-label');
                const isChecked = this.checked;
                
                // Find and update the corresponding line in the editor
                const lines = editor.value.split('\n');
                let updated = false;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    // Match task list items: - [ ] label or - [x] label
                    const uncheckedMatch = line.match(/^([\s]*[-*+]\s+)\[ \]\s+(.*)$/);
                    const checkedMatch = line.match(/^([\s]*[-*+]\s+)\[x\]\s+(.*)$/i);
                    
                    if (uncheckedMatch && uncheckedMatch[2] === label && isChecked) {
                        // Change [ ] to [x]
                        lines[i] = uncheckedMatch[1] + '[x] ' + uncheckedMatch[2];
                        updated = true;
                        break;
                    } else if (checkedMatch && checkedMatch[2] === label && !isChecked) {
                        // Change [x] to [ ]
                        lines[i] = checkedMatch[1] + '[ ] ' + checkedMatch[2];
                        updated = true;
                        break;
                    }
                }
                
                if (updated) {
                    // Update editor content (keep it as markdown)
                    const cursorPos = editor.selectionStart;
                    editor.value = lines.join('\n');
                    editor.selectionStart = cursorPos;
                    editor.selectionEnd = cursorPos;
                    
                    // Update preview without triggering another undo snapshot
                    isUpdatingFromEditor = true;
                    updatePreview();
                    setTimeout(() => {
                        isUpdatingFromEditor = false;
                        isTogglingCheckbox = false;
                    }, 100);
                    
                    // Save undo snapshot for the checkbox toggle
                    pushImmediateUndoSnapshot();
                    
                    // Trigger save if auto-save is enabled
                    if (settings.autoSave) {
                        autoSaveDebounced();
                    }
                } else {
                    // Reset flag even if no update
                    isTogglingCheckbox = false;
                }
            });
        });
    }
    
    // Update toolbar button states based on selected text formatting in preview
    function updateToolbarFromPreviewSelection() {
        const selection = window.getSelection();
        
        // Reset all formatting button states first
        const formattingButtons = ['btn-bold', 'btn-italic', 'btn-strike', 'btn-code', 'btn-heading'];
        formattingButtons.forEach(btnId => {
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.style.background = '';
                btn.style.color = '';
            }
        });
        
        // If no selection or selection is not in preview, return
        if (!selection.rangeCount || selection.isCollapsed) return;
        
        const range = selection.getRangeAt(0);
        const container = range.commonAncestorContainer;
        
        // Check if selection is within preview pane
        const isInPreview = preview.contains(container.nodeType === 3 ? container.parentNode : container);
        if (!isInPreview) return;
        
        // Get all parent elements of the selection
        let element = container.nodeType === 3 ? container.parentNode : container;
        const parents = [];
        
        while (element && element !== preview) {
            parents.push(element);
            element = element.parentNode;
        }
        
        // Check for formatting in parent elements and highlight corresponding buttons
        parents.forEach(parent => {
            const tagName = parent.tagName ? parent.tagName.toLowerCase() : '';
            
            // Bold
            if (tagName === 'strong' || tagName === 'b') {
                highlightButton('btn-bold');
            }
            
            // Italic
            if (tagName === 'em' || tagName === 'i') {
                highlightButton('btn-italic');
            }
            
            // Strikethrough
            if (tagName === 'del' || tagName === 's' || tagName === 'strike') {
                highlightButton('btn-strike');
            }
            
            // Code
            if (tagName === 'code') {
                highlightButton('btn-code');
            }
            
            // Headings - update heading button dropdown
            if (tagName.match(/^h[1-6]$/)) {
                const level = tagName.substring(1);
                const headingBtn = document.getElementById('btn-heading');
                if (headingBtn) {
                    headingBtn.style.background = '#e3f2fd';
                    headingBtn.style.color = '#1976d2';
                    const headingText = headingBtn.querySelector('.heading-level-text');
                    if (headingText) {
                        headingText.textContent = 'H' + level;
                    }
                }
            }
        });
    }
    
    // Highlight a toolbar button to show active state
    function highlightButton(buttonId) {
        const btn = document.getElementById(buttonId);
        if (btn) {
            btn.style.background = '#e3f2fd';
            btn.style.color = '#1976d2';
        }
    }
    
    // Update the preview pane with parsed markdown
    function updatePreview() {
        isUpdatingFromEditor = true;
        const markdownText = editor.value;
        const htmlContent = parseMarkdown(markdownText);
        preview.innerHTML = htmlContent;
        
        // Add event listeners to task checkboxes to make them interactive
        attachTaskCheckboxListeners();
        
        setTimeout(() => {
            isUpdatingFromEditor = false;
        }, 100);
    }

    // Convert HTML back to markdown (simplified version)
    function htmlToMarkdown(html) {
        let markdown = html;
        
        // First, clean up any nested HTML tags that might cause issues
        markdown = markdown.replace(/<span[^>]*class="md-img-info-wrap"[^>]*>(.*?)<\/span>/gis, '$1');
        markdown = markdown.replace(/<span[^>]*class="md-img-info-badge"[^>]*>.*?<\/span>/gis, '');
        
        // Convert task checkboxes back to markdown
        markdown = markdown.replace(/<input[^>]*type="checkbox"[^>]*class="task-checkbox"[^>]*data-task-label="([^"]*)"[^>]*checked[^>]*>\s*\1/gi, '[x] $1');
        markdown = markdown.replace(/<input[^>]*type="checkbox"[^>]*class="task-checkbox"[^>]*data-task-label="([^"]*)"[^>]*>\s*\1/gi, '[ ] $1');
        
        // Convert HTML back to markdown
        markdown = markdown
            // Headers
            .replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n')
            .replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n')
            .replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n')
            .replace(/<h4[^>]*>(.*?)<\/h4>/gi, '#### $1\n')
            .replace(/<h5[^>]*>(.*?)<\/h5>/gi, '##### $1\n')
            .replace(/<h6[^>]*>(.*?)<\/h6>/gi, '###### $1\n')
            
            // Bold and italic
            .replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**')
            .replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**')
            .replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*')
            .replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*')
            
            // Strikethrough
            .replace(/<del[^>]*>(.*?)<\/del>/gi, '~~$1~~')
            .replace(/<s[^>]*>(.*?)<\/s>/gi, '~~$1~~')
            
            // Superscript and subscript
            .replace(/<sup[^>]*>(.*?)<\/sup>/gi, '^$1^')
            .replace(/<sub[^>]*>(.*?)<\/sub>/gi, '~$1~')
            
            // Code
            .replace(/<pre[^>]*><code[^>]*>(.*?)<\/code><\/pre>/gis, '```\n$1\n```')
            .replace(/<code[^>]*>(.*?)<\/code>/gi, '`$1`')
            
            // Links
            .replace(/<a[^>]*href="([^"]*)"[^>]*>(.*?)<\/a>/gi, '[$2]($1)')
            
            // Images (with positioning classes)
            .replace(/<img[^>]*class="img-(left|right|center)"[^>]*src="([^"]*)"[^>]*alt="([^"]*)"[^>]*>/gi, '![$3]($2){$1}')
            .replace(/<img[^>]*src="([^"]*)"[^>]*alt="([^"]*)"[^>]*class="img-(left|right|center)"[^>]*>/gi, '![$2]($1){$3}')
            .replace(/<img[^>]*src="([^"]*)"[^>]*alt="([^"]*)"[^>]*>/gi, '![$2]($1)')
            .replace(/<img[^>]*class="img-(left|right|center)"[^>]*src="([^"]*)"[^>]*>/gi, '![]($2){$1}')
            .replace(/<img[^>]*src="([^"]*)"[^>]*class="img-(left|right|center)"[^>]*>/gi, '![]($1){$2}')
            .replace(/<img[^>]*src="([^"]*)"[^>]*>/gi, '![]($1)')
            
            // Clear floats
            .replace(/<div[^>]*class="img-clear"[^>]*><\/div>/gi, '---clear---')
            
            // Lists
            .replace(/<ul[^>]*>(.*?)<\/ul>/gis, (match, content) => {
                return content.replace(/<li[^>]*>(.*?)<\/li>/gis, '- $1\n');
            })
            .replace(/<ol[^>]*>(.*?)<\/ol>/gis, (match, content) => {
                let counter = 1;
                return content.replace(/<li[^>]*>(.*?)<\/li>/gis, () => `${counter++}. $1\n`);
            })
            
            // Blockquotes
            .replace(/<blockquote[^>]*>(.*?)<\/blockquote>/gis, (match, content) => {
                return content.split('\n').map(line => `> ${line}`).join('\n') + '\n';
            })
            
            // Horizontal rules
            .replace(/<hr[^>]*>/gi, '---\n')
            
            // Line breaks and paragraphs
            .replace(/<br[^>]*>/gi, '\n')
            .replace(/<\/p><p[^>]*>/gi, '\n\n')
            .replace(/<p[^>]*>/gi, '')
            .replace(/<\/p>/gi, '\n')
            
            // Tables (simplified)
            .replace(/<table[^>]*>(.*?)<\/table>/gis, (match, content) => {
                const rows = content.match(/<tr[^>]*>(.*?)<\/tr>/gis) || [];
                let tableMarkdown = '';
                let isHeader = true;
                
                rows.forEach(row => {
                    const cells = row.match(/<t[dh][^>]*>(.*?)<\/t[dh]>/gis) || [];
                    const cellTexts = cells.map(cell => cell.replace(/<[^>]*>/g, '').trim());
                    tableMarkdown += '| ' + cellTexts.join(' | ') + ' |\n';
                    
                    if (isHeader) {
                        tableMarkdown += '|' + cellTexts.map(() => ' --- ').join('|') + '|\n';
                        isHeader = false;
                    }
                });
                
                return tableMarkdown;
            })
            
            // Clean up extra whitespace and normalize
            .replace(/\n\s*\n\s*\n/g, '\n\n')
            .replace(/^\s+|\s+$/g, '')
            .replace(/\n{3,}/g, '\n\n'); // Max 2 consecutive newlines
            
        return markdown;
    }

    // Sync changes from preview back to editor
    function syncPreviewToEditor() {
        const htmlContent = preview.innerHTML;
        const markdownContent = htmlToMarkdown(htmlContent);
        
        // Only update if content actually changed to avoid infinite loops
        if (markdownContent !== editor.value) {
            editor.value = markdownContent;
            pushImmediateUndoSnapshot();
        }
    }

    // Handle keyboard shortcuts in preview
    function handlePreviewKeyboardShortcuts(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'b':
                    e.preventDefault();
                    document.execCommand('bold');
                    break;
                case 'i':
                    e.preventDefault();
                    document.execCommand('italic');
                    break;
                case 'u':
                    e.preventDefault();
                    document.execCommand('underline');
                    break;
            }
        }
    }

    // Update the status bar with current document stats
    function updateStatusBar() {
        const text = editor.value;
        const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;
        const charCount = text.length;
        const lineCount = text.split('\n').length;

        document.getElementById('word-count').textContent = `Words: ${wordCount}`;
        document.getElementById('char-count').textContent = `Characters: ${charCount}`;
        document.getElementById('line-count').textContent = `Lines: ${lineCount}`;
        
        // Update cursor position
        updateCursorPosition();
        
        // Update selection info
        updateSelectionInfo();
    }
    
    // Update cursor position in status bar
    function updateCursorPosition() {
        const cursorPosElement = document.getElementById('cursor-position');
        if (!cursorPosElement) return;
        
        const cursorPos = editor.selectionStart;
        const textBeforeCursor = editor.value.substring(0, cursorPos);
        const lines = textBeforeCursor.split('\n');
        const currentLine = lines.length;
        const currentColumn = lines[lines.length - 1].length + 1;
        
        cursorPosElement.textContent = `Ln ${currentLine}, Col ${currentColumn}`;
    }
    
    // Update selection information
    function updateSelectionInfo() {
        const selectionInfoElement = document.getElementById('selection-info');
        if (!selectionInfoElement) return;
        
        const selectionStart = editor.selectionStart;
        const selectionEnd = editor.selectionEnd;
        
        if (selectionStart === selectionEnd) {
            selectionInfoElement.textContent = 'No selection';
        } else {
            const selectedText = editor.value.substring(selectionStart, selectionEnd);
            const selectedLines = selectedText.split('\n').length;
            const selectedChars = selectedText.length;
            
            if (selectedLines === 1) {
                selectionInfoElement.textContent = `${selectedChars} chars selected`;
            } else {
                selectionInfoElement.textContent = `${selectedLines} lines, ${selectedChars} chars selected`;
            }
        }
    }
    
    // Tabs toggle functionality
    let useTabs = true;
    let tabSize = 4;
    
    function toggleTabs() {
        useTabs = !useTabs;
        const tabsToggle = document.getElementById('tabs-toggle');
        
        if (useTabs) {
            tabsToggle.textContent = 'Tabs';
            editor.style.tabSize = tabSize;
        } else {
            tabsToggle.textContent = 'Spaces';
            editor.style.tabSize = tabSize;
        }
        
        // Save preference
        try {
            localStorage.setItem('md-use-tabs', useTabs.toString());
            localStorage.setItem('md-tab-size', tabSize.toString());
        } catch (e) { /* ignore */ }
    }
    
    // Formatting selector functionality
    let currentFormat = 'markdown';
    
    function setFormatting(format) {
        currentFormat = format;
        const formatDisplay = document.getElementById('formatting-display');
        
        switch(format) {
            case 'markdown':
                formatDisplay.textContent = 'Markdown';
                break;
            case 'html':
                formatDisplay.textContent = 'HTML';
                break;
            case 'plain':
                formatDisplay.textContent = 'Plain Text';
                break;
            case 'rich':
                formatDisplay.textContent = 'Rich Text';
                break;
        }
        
        // Save preference
        try {
            localStorage.setItem('md-formatting', format);
        } catch (e) { /* ignore */ }
        
        // Close the formatting menu
        document.getElementById('formatting-menu').style.display = 'none';
    }

    // Handle keyboard shortcuts
    function handleKeyboardShortcuts(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'n':
                    e.preventDefault();
                    newFile();
                    break;
                case 'o':
                    e.preventDefault();
                    openFile();
                    break;
                case 's':
                    e.preventDefault();
                    saveFile();
                    break;
                case 'z':
                    e.preventDefault();
                    if (e.shiftKey) {
                        redo();
                    } else {
                        undo();
                    }
                    break;
                case 'b':
                    e.preventDefault();
                    insertMarkdown('**', '**');
                    break;
                case 'i':
                    e.preventDefault();
                    insertMarkdown('*', '*');
                    break;
                case 'f':
                    e.preventDefault();
                    toggleFindReplace();
                    break;
                case 'h':
                    e.preventDefault();
                    toggleFindReplace();
                    document.getElementById('replace-input').focus();
                    break;
                case 'p':
                    e.preventDefault();
                    openPrintDialog();
                    break;
            }
        }
    }

    // File operations
    function newFile() {
        if (editor.value.trim() && !confirm('Are you sure you want to create a new file? Unsaved changes will be lost.')) {
            return;
        }
        editor.value = '';
        currentFile = null;
        
        // Reset undo/redo stacks for new file
        undoStack = [''];
        redoStack = [];
        lastUndoValue = '';
        
        updatePreview();
        updateStatusBar();
        updateStatus('New file created');
    }

    async function openFile() {
        // Prefer the File System Access API for a better open/save experience.
        if (window.showOpenFilePicker) {
            try {
                const [handle] = await window.showOpenFilePicker({
                    multiple: false,
                    types: [{
                        description: 'Markdown or Text Files',
                        accept: { 'text/markdown': ['.md', '.markdown'], 'text/plain': ['.txt', '.text'] }
                    }]
                });
                const file = await handle.getFile();
                const content = await file.text();
                editor.value = content;
                currentFile = file.name;
                currentFileHandle = handle;

                // Reset undo/redo stacks with the loaded file content
                undoStack = [content];
                redoStack = [];
                lastUndoValue = content;

                updatePreview();
                updateStatusBar();
                updateStatus(`Opened: ${file.name}`);
                // If auto-save to disk is enabled, perform an immediate save so the
                // file is captured right away (don't wait for the interval).
                if (settings.autoSave && currentFileHandle && currentFileHandle.createWritable) {
                    try {
                        const writable = await currentFileHandle.createWritable();
                        await writable.write(editor.value);
                        await writable.close();
                        updateStatus('Auto-saved to disk after open');
                    } catch (err) {
                        console.warn('Auto-save after open failed', err);
                        showSaveError(err, 'autosave-after-open');
                    }
                }
                return;
            } catch (err) {
                // If the user cancelled or the API isn't available at runtime,
                // fall back to the file input method below.
                console.warn('showOpenFilePicker failed or was cancelled, falling back to file input', err);
            }
        }

        // Fallback for browsers that don't support File System Access API
        document.getElementById('file-input').click();
    }

    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const content = event.target.result;
                editor.value = content;
                // Opening via <input> doesn't provide a writable handle
                currentFile = file.name;
                currentFileHandle = null;

                // Reset undo/redo stacks with the loaded file content
                undoStack = [content];
                redoStack = [];
                lastUndoValue = content;

                updatePreview();
                updateStatusBar();
                updateStatus(`Opened: ${file.name}`);
            };
            reader.readAsText(file);
        }
    }

    async function saveFile() {
        const content = editor.value;

        // If we have a FileSystemFileHandle, try to overwrite the original file.
        if (currentFileHandle && currentFileHandle.createWritable) {
            try {
                const writable = await currentFileHandle.createWritable();
                await writable.write(content);
                await writable.close();
                currentFile = currentFileHandle.name || currentFile;
                updateStatus(`Saved: ${currentFile}`);
                return;
            } catch (err) {
                console.warn('Writing via FileSystemFileHandle failed', err);
                // Present the user with options: Retry, Save As, or Download
                try { showSaveError(err, 'write'); } catch (e) { console.warn('Failed to show save error dialog', e); }
                return;
            }
        }

        // If the platform supports showSaveFilePicker, prompt and keep the handle
        if (window.showSaveFilePicker) {
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: currentFile || 'document.md',
                    types: [{
                        description: 'Markdown or Text Files',
                        accept: { 'text/markdown': ['.md', '.markdown'], 'text/plain': ['.txt', '.text'] }
                    }]
                });
                const writable = await handle.createWritable();
                await writable.write(content);
                await writable.close();
                currentFileHandle = handle;
                currentFile = handle.name || currentFile;
                updateStatus(`Saved: ${currentFile}`);
                return;
            } catch (err) {
                console.warn('showSaveFilePicker cancelled or failed, falling back to download', err);
            }
        }

        // Final fallback: trigger a download (save-as)
        let filename = currentFile || 'document.md';
        if (!/\.(md|markdown|txt|text)$/i.test(filename)) filename += '.md';
        let type = 'text/markdown';
        if (/\.(txt|text)$/i.test(filename)) type = 'text/plain';
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        updateStatus(`Saved: ${filename}`);
    }

    // Undo/Redo functionality
    // Helper to summarize a state for dropdown
    function summarizeState(text) {
        let firstLine = text.split('\n')[0];
        if (firstLine.length > 40) firstLine = firstLine.slice(0, 37) + '...';
        return firstLine || '[Empty]';
    }

    // Create and show history dropdown
    function showHistoryDropdown(type, anchorBtn) {
        let stack = type === 'undo' ? undoStack : redoStack;
        if (!stack.length) return;
        const maxItems = 15;
        const items = stack.slice(-maxItems).map(summarizeState);
        let dropdown = document.getElementById(type + '-history-dropdown');
        if (dropdown) dropdown.remove();
        dropdown = document.createElement('div');
        dropdown.id = type + '-history-dropdown';
        dropdown.className = 'undo-history-dropdown';
        dropdown.style.position = 'absolute';
        dropdown.style.zIndex = 10002;
        
        // Position dropdown with proper spacing to avoid toolbar overlap
        const rect = anchorBtn.getBoundingClientRect();
        const dropdownGap = 8; // Gap between button and dropdown
        const viewportHeight = window.innerHeight;
        const estimatedDropdownHeight = Math.min(items.length * 32, 320); // Approximate height
        
        // Check if there's enough space below the button
        const spaceBelow = viewportHeight - rect.bottom;
        const spaceAbove = rect.top;
        
        // Position dropdown above or below based on available space
        if (spaceBelow < estimatedDropdownHeight + dropdownGap + 50 && spaceAbove > spaceBelow) {
            // Position above the button
            dropdown.style.left = rect.left + 'px';
            dropdown.style.bottom = (viewportHeight - rect.top + dropdownGap) + 'px';
            dropdown.style.top = 'auto';
        } else {
            // Position below the button
            dropdown.style.left = rect.left + 'px';
            dropdown.style.top = (rect.bottom + window.scrollY + dropdownGap) + 'px';
            dropdown.style.bottom = 'auto';
        }
        items.forEach((summary, idx) => {
            const item = document.createElement('div');
            item.className = 'undo-history-item';
            item.textContent = (stack.length - maxItems + idx + 1) + '. ' + summary;
            item.onclick = () => {
                if (type === 'undo') {
                    // Jump to selected undo state
                    const targetIdx = stack.length - maxItems + idx;
                    if (targetIdx >= 0 && targetIdx < stack.length) {
                        // Move all newer states to redoStack
                        while (undoStack.length > targetIdx + 1) {
                            redoStack.push(undoStack.pop());
                        }
                        editor.value = undoStack[undoStack.length - 1];
                        updatePreview();
                        updateStatusBar();
                        lastUndoValue = editor.value;
                    }
                } else {
                    // Jump to selected redo state
                    const targetIdx = stack.length - maxItems + idx;
                    if (targetIdx >= 0 && targetIdx < stack.length) {
                        // Move all older states to undoStack
                        while (redoStack.length > targetIdx + 1) {
                            undoStack.push(redoStack.pop());
                        }
                        editor.value = redoStack[redoStack.length - 1];
                        updatePreview();
                        updateStatusBar();
                        lastUndoValue = editor.value;
                    }
                }
                dropdown.remove();
            };
            dropdown.appendChild(item);
        });
        document.body.appendChild(dropdown);
        // Keep dropdown visible while hovering the anchor button or the dropdown itself.
        // Close when both are left, or on click outside. Small delay prevents flicker when moving between button and menu.
        let closeTimeout = null;
        const scheduleClose = () => {
            if (closeTimeout) clearTimeout(closeTimeout);
            closeTimeout = setTimeout(() => {
                try {
                    if (!anchorBtn.matches(':hover') && !dropdown.matches(':hover')) {
                        if (dropdown) dropdown.remove();
                        document.removeEventListener('mousedown', outsideHandler);
                    }
                } catch (err) { /* element may be gone */ }
            }, 160);
        };
        const cancelClose = () => { if (closeTimeout) { clearTimeout(closeTimeout); closeTimeout = null; } };

        const outsideHandler = (e) => {
            // If clicking the anchor button itself, remove dropdown and let the click through
            if (e.target === anchorBtn || anchorBtn.contains(e.target)) {
                if (dropdown) dropdown.remove();
                document.removeEventListener('mousedown', outsideHandler);
                return; // Let the click event proceed
            }
            // If clicking outside both dropdown and button, just close
            if (!dropdown.contains(e.target)) {
                if (dropdown) dropdown.remove();
                document.removeEventListener('mousedown', outsideHandler);
            }
        };

        anchorBtn.addEventListener('mouseleave', scheduleClose);
        anchorBtn.addEventListener('mouseenter', cancelClose);
        dropdown.addEventListener('mouseleave', scheduleClose);
        dropdown.addEventListener('mouseenter', cancelClose);
        // Also close when clicking outside
        setTimeout(() => { document.addEventListener('mousedown', outsideHandler); }, 0);
    }
    
    function saveToUndoStack(e) {
        const value = editor.value;
        // If shift is held, always save whole text immediately
        if (e && e.shiftKey) {
            undoStack.push(value);
            if (undoStack.length > UNDO_STACK_LIMIT) undoStack.shift();
            redoStack = [];
            lastUndoValue = value;
            lastUndoSaveTime = Date.now();
            return;
        }
        // Throttle saves (v2.1.2 improvement: 250ms throttle for reduced lag)
        if (undoTimer) clearTimeout(undoTimer);
        undoTimer = setTimeout(() => {
            // Save if value changed
            if (value !== lastUndoValue) {
                undoStack.push(value);
                if (undoStack.length > UNDO_STACK_LIMIT) undoStack.shift();
                redoStack = [];
                lastUndoValue = value;
                lastUndoSaveTime = Date.now();
            }
        }, undoThrottleMs);
    }

    function pushImmediateUndoSnapshot() {
        const value = editor.value;
        if (!undoStack.length || undoStack[undoStack.length - 1] !== value) {
            undoStack.push(value);
            if (undoStack.length > UNDO_STACK_LIMIT) undoStack.shift();
        }
        redoStack = [];
        lastUndoValue = value;
        if (undoTimer) {
            clearTimeout(undoTimer);
            undoTimer = null;
        }
    }

    function undo() {
        if (undoStack.length > 1) {
            redoStack.push(undoStack.pop());
            editor.value = undoStack[undoStack.length - 1] || '';
            updatePreview();
            updateStatusBar();
            lastUndoValue = editor.value;
        }
    }

    function redo() {
        if (redoStack.length > 0) {
            const redoValue = redoStack.pop();
            undoStack.push(redoValue);
            editor.value = redoValue;
            updatePreview();
            updateStatusBar();
            lastUndoValue = editor.value;
        }
    }

    // Markdown insertion helpers
    function insertMarkdown(before, after) {
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        const selectedText = editor.value.substring(start, end);
        
        const newText = before + selectedText + after;
        editor.value = editor.value.substring(0, start) + newText + editor.value.substring(end);
        
        // Position cursor appropriately
        if (selectedText) {
            editor.selectionStart = start;
            editor.selectionEnd = start + newText.length;
        } else {
            editor.selectionStart = editor.selectionEnd = start + before.length;
        }
        
        editor.focus();
        updatePreview();
        updateStatusBar();
        pushImmediateUndoSnapshot();
    }

    function insertHeading(level) {
        const start = editor.selectionStart;
        const lineStart = editor.value.lastIndexOf('\n', start - 1) + 1;
        const hashes = '#'.repeat(level) + ' ';
        
        editor.value = editor.value.substring(0, lineStart) + hashes + editor.value.substring(lineStart);
        editor.selectionStart = editor.selectionEnd = lineStart + hashes.length;
        editor.focus();
        updatePreview();
        updateStatusBar();
        pushImmediateUndoSnapshot();
    }

    function insertList(prefix) {
        const start = editor.selectionStart;
        const lineStart = editor.value.lastIndexOf('\n', start - 1) + 1;
        
        editor.value = editor.value.substring(0, lineStart) + prefix + editor.value.substring(lineStart);
        editor.selectionStart = editor.selectionEnd = lineStart + prefix.length;
        editor.focus();
        updatePreview();
        updateStatusBar();
        pushImmediateUndoSnapshot();
    }

    function insertLink() {
        showLinkImageDialog('link');
    }

    function insertImage() {
        showLinkImageDialog('image');
    }

    function persistPrintSettings() {
        try {
            localStorage.setItem(PRINT_SETTINGS_KEY, JSON.stringify(printState));
        } catch (e) { /* ignore persistence errors */ }
    }

    function loadPrintSettings() {
        try {
            const stored = localStorage.getItem(PRINT_SETTINGS_KEY);
            if (!stored) return;
            const parsed = JSON.parse(stored);
            if (!parsed || typeof parsed !== 'object') return;

            if (typeof parsed.target === 'string' && ['auto', 'editor', 'preview'].includes(parsed.target)) {
                printState.target = parsed.target;
            }
            if (typeof parsed.orientation === 'string' && ['portrait', 'landscape'].includes(parsed.orientation)) {
                printState.orientation = parsed.orientation;
            }
            if (typeof parsed.margin === 'string' && ['default', 'narrow', 'moderate', 'wide', 'none'].includes(parsed.margin)) {
                printState.margin = parsed.margin;
            }
            if (typeof parsed.includeMetadata === 'boolean') {
                printState.includeMetadata = parsed.includeMetadata;
            }
            if (typeof parsed.includePageNumbers === 'boolean') {
                printState.includePageNumbers = parsed.includePageNumbers;
            }
            if (typeof parsed.includeBackground === 'boolean') {
                printState.includeBackground = parsed.includeBackground;
            }
            if (Array.isArray(parsed.printers)) {
                const unique = [];
                const seen = new Set();
                parsed.printers.forEach(name => {
                    const sanitized = sanitizePrinterName(name);
                    if (!sanitized) return;
                    const key = sanitized.toLowerCase();
                    if (seen.has(key)) return;
                    seen.add(key);
                    unique.push(sanitized);
                });
                printState.printers = unique;
            }
            if (typeof parsed.selectedPrinter === 'string') {
                const sanitized = sanitizePrinterName(parsed.selectedPrinter);
                printState.selectedPrinter = sanitized || 'browser-default';
            }
            ensureSelectedPrinterIsValid();
        } catch (e) {
            console.warn('Failed to load print settings', e);
        }
    }

    function sanitizePrinterName(name) {
        if (typeof name !== 'string') return null;
        const trimmed = name.trim();
        if (!trimmed) return null;
        return trimmed.length > 120 ? trimmed.slice(0, 120) : trimmed;
    }

    function getUniquePrintersFromText(value) {
        const lines = (value || '').split(/\r?\n/);
        const seen = new Set();
        const printers = [];
        lines.forEach(line => {
            const sanitized = sanitizePrinterName(line);
            if (!sanitized) return;
            const key = sanitized.toLowerCase();
            if (seen.has(key)) return;
            seen.add(key);
            printers.push(sanitized);
        });
        return printers;
    }

    function ensureSelectedPrinterIsValid() {
        if (printState.selectedPrinter === 'browser-default') return false;
        const exists = printState.printers.some(name => name === printState.selectedPrinter);
        if (exists) return false;
        printState.selectedPrinter = printState.printers.length ? printState.printers[0] : 'browser-default';
        return true;
    }

    function populatePrinterSelect() {
        const select = document.getElementById('print-printer-select');
        if (!select) return;
        const changed = ensureSelectedPrinterIsValid();
        select.innerHTML = '';

        const defaultOption = document.createElement('option');
        defaultOption.value = 'browser-default';
        defaultOption.textContent = "Use browser's printer dialog";
        select.appendChild(defaultOption);

        printState.printers.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
        });

        select.value = printState.selectedPrinter;
        if (select.value !== printState.selectedPrinter) {
            select.value = 'browser-default';
        }
        if (changed) {
            persistPrintSettings();
        }
    }

    function describePrintTarget(target) {
        switch (target) {
            case 'editor':
                return 'Markdown source';
            case 'preview':
                return 'Rendered preview';
            default:
                if (currentViewMode === 'preview') return 'Smart (preview pane)';
                if (currentViewMode === 'editor') return 'Smart (editor pane)';
                return 'Smart (split view)';
        }
    }

    function describeMargin(margin) {
        switch (margin) {
            case 'narrow':
                return 'Narrow';
            case 'moderate':
                return 'Moderate';
            case 'wide':
                return 'Wide';
            case 'none':
                return 'None';
            default:
                return 'Standard';
        }
    }

    function describeSelectedPrinter() {
        if (!printState.selectedPrinter || printState.selectedPrinter === 'browser-default') {
            return 'Select in browser dialog';
        }
        return printState.selectedPrinter;
    }

    function updatePrintPreviewInfo() {
        const infoEl = document.getElementById('print-preview-info');
        if (!infoEl) return;
        const targetDescription = describePrintTarget(printState.target);
        const orientationLabel = printState.orientation === 'landscape' ? 'Landscape' : 'Portrait';
        const marginLabel = describeMargin(printState.margin);
        const printerLabel = describeSelectedPrinter();
        infoEl.textContent = `${targetDescription} • ${orientationLabel} • ${marginLabel} margins • Printer: ${printerLabel}`;
    }

    function buildEditorPreviewHtml() {
        const value = editor ? editor.value : '';
        if (!value.trim()) {
            return '<div class="print-dialog-preview-empty">Document is empty.</div>';
        }
        return `<pre>${escapeHtml(value)}</pre>`;
    }

    function buildRenderedPreviewHtml() {
        if (!preview) {
            return '<div class="print-dialog-preview-empty">Preview pane not available.</div>';
        }
        const html = preview.innerHTML;
        if (!html.trim()) {
            return '<div class="print-dialog-preview-empty">Rendered preview is empty.</div>';
        }
        return `<div class="print-dialog-preview-rendered">${html}</div>`;
    }

    function buildSplitPreviewHtml() {
        const editorHtml = buildEditorPreviewHtml();
        const previewHtml = buildRenderedPreviewHtml();
        return `
            <div class="print-dialog-preview-split">
                <div class="print-dialog-preview-column">
                    <div class="print-dialog-preview-column-title">Markdown Source</div>
                    ${editorHtml}
                </div>
                <div class="print-dialog-preview-column">
                    <div class="print-dialog-preview-column-title">Rendered Preview</div>
                    ${previewHtml}
                </div>
            </div>
        `;
    }

    function renderPrintPreview() {
        const contentEl = document.getElementById('print-preview-content');
        if (!contentEl) return;

        updatePrintPreviewInfo();
        updatePrintPreviewWarning(printState.target);

        let bodyHtml = '';
        if (printState.target === 'editor') {
            bodyHtml = buildEditorPreviewHtml();
        } else if (printState.target === 'preview') {
            bodyHtml = buildRenderedPreviewHtml();
        } else {
            if (currentViewMode === 'preview') {
                bodyHtml = buildRenderedPreviewHtml();
            } else if (currentViewMode === 'editor') {
                bodyHtml = buildEditorPreviewHtml();
            } else {
                bodyHtml = buildSplitPreviewHtml();
            }
        }

        const metadataBlock = printState.includeMetadata ? generateMetadataBlock() : '';
        const previewMarkup = `
            ${metadataBlock}
            ${bodyHtml}
        `;

        contentEl.innerHTML = previewMarkup;
    }

    function handlePrintDialogKeydown(e) {
        if (e.key === 'Escape') {
            const dialog = document.getElementById('print-dialog');
            if (dialog && dialog.style.display === 'block') {
                e.preventDefault();
                closePrintDialog();
            }
        }
    }

    function setupPrintDialog() {
        const dialog = document.getElementById('print-dialog');
        if (!dialog || dialog.dataset.initialized === 'true') return;

        loadPrintSettings();

        dialog.dataset.initialized = 'true';

        const closeBtn = document.getElementById('print-dialog-close');
        const cancelBtn = document.getElementById('print-dialog-cancel');
        const confirmBtn = document.getElementById('print-dialog-confirm');
        const targetRadios = dialog.querySelectorAll('input[name="print-target"]');
        const orientationBtns = dialog.querySelectorAll('.print-orientation-btn');
        const includeMetadata = document.getElementById('print-include-metadata');
        const includePageNumbers = document.getElementById('print-include-page-numbers');
        const includeBackground = document.getElementById('print-include-background');
        const marginSelect = document.getElementById('print-margin');
        const printerSelect = document.getElementById('print-printer-select');
        const manageToggle = document.getElementById('print-manage-printers-toggle');
        const managePanel = document.getElementById('print-manage-printers-panel');
        const manageInput = document.getElementById('print-manage-printers-input');
        const manageCancel = document.getElementById('print-manage-printers-cancel');
        const manageSave = document.getElementById('print-manage-printers-save');

        closeBtn && closeBtn.addEventListener('click', closePrintDialog);
        cancelBtn && cancelBtn.addEventListener('click', closePrintDialog);
        confirmBtn && confirmBtn.addEventListener('click', handlePrintConfirm);

        targetRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                if (!radio.checked) return;
                printState.target = radio.value;
                persistPrintSettings();
                renderPrintPreview();
            });
        });

        orientationBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const orientation = btn.dataset.orientation || 'portrait';
                if (printState.orientation === orientation) return;
                printState.orientation = orientation;
                updatePrintOrientationUI(printState.orientation);
                persistPrintSettings();
                renderPrintPreview();
            });
        });

        includeMetadata && includeMetadata.addEventListener('change', (e) => {
            printState.includeMetadata = e.target.checked;
            persistPrintSettings();
            renderPrintPreview();
        });

        includePageNumbers && includePageNumbers.addEventListener('change', (e) => {
            printState.includePageNumbers = e.target.checked;
            persistPrintSettings();
            renderPrintPreview();
        });

        includeBackground && includeBackground.addEventListener('change', (e) => {
            printState.includeBackground = e.target.checked;
            persistPrintSettings();
            renderPrintPreview();
        });

        marginSelect && marginSelect.addEventListener('change', (e) => {
            printState.margin = e.target.value;
            persistPrintSettings();
            renderPrintPreview();
        });

        if (printerSelect) {
            populatePrinterSelect();
            printerSelect.addEventListener('change', (e) => {
                const value = e.target.value || 'browser-default';
                printState.selectedPrinter = value;
                persistPrintSettings();
                updatePrintPreviewInfo();
                updatePrintPreviewWarning(printState.target);
            });
        }

        if (manageToggle && managePanel && manageInput) {
            manageToggle.addEventListener('click', () => {
                const isOpen = managePanel.style.display === 'block';
                if (isOpen) {
                    managePanel.style.display = 'none';
                } else {
                    manageInput.value = printState.printers.join('\n');
                    managePanel.style.display = 'block';
                    manageInput.focus({ preventScroll: true });
                }
            });
        }

        manageCancel && manageCancel.addEventListener('click', () => {
            if (managePanel) managePanel.style.display = 'none';
        });

        manageSave && manageSave.addEventListener('click', () => {
            if (!manageInput) return;
            const printers = getUniquePrintersFromText(manageInput.value);
            printState.printers = printers;
            const adjusted = ensureSelectedPrinterIsValid();
            populatePrinterSelect();
            persistPrintSettings();
            updatePrintPreviewInfo();
            updatePrintPreviewWarning(printState.target);
            if (managePanel) managePanel.style.display = 'none';
            if (adjusted && printerSelect) {
                printerSelect.value = printState.selectedPrinter;
            }
        });

        updatePrintOrientationUI(printState.orientation);
        renderPrintPreview();

        document.addEventListener('keydown', handlePrintDialogKeydown);
    }

    function openPrintDialog() {
        setupPrintDialog();
        const dialog = document.getElementById('print-dialog');
        const overlay = document.getElementById('popup-overlay');
        if (!dialog || !overlay) return;

        // Sync UI controls with current state
        const radios = dialog.querySelectorAll('input[name="print-target"]');
        radios.forEach(radio => {
            radio.checked = radio.value === printState.target;
        });

        const includeMetadata = document.getElementById('print-include-metadata');
        const includePageNumbers = document.getElementById('print-include-page-numbers');
        const includeBackground = document.getElementById('print-include-background');
        const marginSelect = document.getElementById('print-margin');
        const printerSelect = document.getElementById('print-printer-select');
        const managePanel = document.getElementById('print-manage-printers-panel');
        const manageInput = document.getElementById('print-manage-printers-input');

        if (includeMetadata) includeMetadata.checked = printState.includeMetadata;
        if (includePageNumbers) includePageNumbers.checked = printState.includePageNumbers;
        if (includeBackground) includeBackground.checked = printState.includeBackground;
        if (marginSelect) marginSelect.value = printState.margin;
        if (printerSelect) {
            populatePrinterSelect();
        }
        if (printerSelect) {
            printerSelect.value = printState.selectedPrinter;
        }
        if (managePanel) {
            managePanel.style.display = 'none';
        }
        if (manageInput) {
            manageInput.value = printState.printers.join('\n');
        }

        updatePrintOrientationUI(printState.orientation);
        renderPrintPreview();

        dialog.style.display = 'block';
        overlay.style.display = 'block';
    }

    function closePrintDialog() {
        const dialog = document.getElementById('print-dialog');
        const overlay = document.getElementById('popup-overlay');
        if (!dialog || !overlay) return;

        dialog.style.display = 'none';
        overlay.style.display = 'none';
    }

    function updatePrintOrientationUI(orientation) {
        const buttons = document.querySelectorAll('.print-orientation-btn');
        buttons.forEach(btn => {
            if (btn.dataset.orientation === orientation) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    function updatePrintPreviewWarning(target) {
        const warning = document.getElementById('print-preview-warning');
        if (!warning) return;

        const shouldWarn = target === 'preview' || printState.selectedPrinter !== 'browser-default';
        warning.style.display = shouldWarn ? 'block' : 'none';
        if (!shouldWarn) return;

        const previewMessage = target === 'preview'
            ? 'We\'ll open a preview window to print the rendered content.'
            : 'Your browser will still open its print dialog to finish printing.';
        let message = `<strong>Heads up:</strong> ${previewMessage}`;
        if (printState.selectedPrinter !== 'browser-default') {
            message += `<br><strong>Printer reminder:</strong> After the dialog opens, choose “${escapeHtml(printState.selectedPrinter)}”.`;
        }
        warning.innerHTML = message;
    }

    function handlePrintConfirm() {
        closePrintDialog();
        setTimeout(() => {
            printFile();
        }, 50);
    }

    function printFile() {
        try {
            const target = printState.target;
            if (target === 'auto') {
                if (currentViewMode === 'preview') {
                    renderPreviewPrint();
                } else if (currentViewMode === 'editor') {
                    renderEditorPrint();
                } else {
                    renderSplitPrint();
                }
            } else if (target === 'preview') {
                renderPreviewPrint();
            } else {
                renderEditorPrint();
            }
        } catch (err) {
            console.error('Print failed:', err);
            customAlert('Printing failed. Please try again or export as PDF.');
        }
    }

    function renderEditorPrint() {
        const docTitle = currentFile || 'Markdown Document';
        const content = editor ? editor.value : '';
        const encoded = escapeHtml(content).replace(/\n/g, '<br>');
        openPrintWindow({
            title: docTitle,
            body: `<div class="print-markdown">${encoded}</div>`
        });
    }

    function renderPreviewPrint() {
        const docTitle = currentFile || 'Markdown Document';
        const previewEl = document.getElementById('preview');
        const html = previewEl ? previewEl.innerHTML : '';
        openPrintWindow({
            title: docTitle,
            body: `<div class="print-preview">${html}</div>`
        });
    }

    function renderSplitPrint() {
        const docTitle = currentFile || 'Markdown Document';
        const editorContent = editor ? escapeHtml(editor.value).replace(/\n/g, '<br>') : '';
        const previewEl = document.getElementById('preview');
        const previewContent = previewEl ? previewEl.innerHTML : '';
        const body = `
            <div class="print-split">
                <div class="print-column">
                    <h2>Markdown Source</h2>
                    <div class="print-markdown">${editorContent}</div>
                </div>
                <div class="print-column">
                    <h2>Rendered Preview</h2>
                    <div class="print-preview">${previewContent}</div>
                </div>
            </div>
        `;
        openPrintWindow({ title: docTitle, body });
    }

    function openPrintWindow({ title, body }) {
        const win = window.open('', '_blank', 'noopener,noreferrer');
        if (!win) {
            customAlert('Your browser blocked the print preview. Please allow popups and try again.');
            return;
        }

        const pageTitle = escapeHtml(title || document.title || 'Document');
        const orientation = printState.orientation === 'landscape' ? 'landscape' : 'portrait';
        const marginCss = getMarginCss(printState.margin);
        const includeMeta = printState.includeMetadata;
        const includePageNumbers = printState.includePageNumbers;
        const includeBackground = printState.includeBackground;
        const bodyContent = body || '';

        const metadataBlock = includeMeta ? generateMetadataBlock() : '';
        const pageNumberBlock = includePageNumbers
            ? `@page { @bottom-center { content: counter(page) " / " counter(pages); } }`
            : '';

        const allowBackground = includeBackground ? 'print-color-adjust: exact; -webkit-print-color-adjust: exact;' : '';

        const html = `
            <!doctype html>
            <html>
                <head>
                    <meta charset="utf-8">
                    <title>${pageTitle}</title>
                    <style>
                        :root {
                            color-scheme: ${document.body.classList.contains('dark-mode') ? 'dark' : 'light'};
                        }
                        @page {
                            size: ${orientation};
                            ${marginCss}
                        }
                        ${pageNumberBlock}
                        body {
                            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                            margin: 0;
                            background: #fff;
                            color: #111827;
                            ${allowBackground}
                        }
                        .print-container {
                            padding: 32px 40px;
                            max-width: 960px;
                            margin: 0 auto;
                        }
                        .print-metadata {
                            font-size: 12px;
                            color: #6b7280;
                            border-bottom: 1px solid rgba(148, 163, 184, 0.35);
                            padding-bottom: 12px;
                            margin-bottom: 24px;
                        }
                        .print-split {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 32px;
                        }
                        .print-column h2 {
                            font-size: 18px;
                            margin: 0 0 12px;
                            color: #1f2937;
                        }
                        .print-markdown {
                            font-family: "Cascadia Code", "Fira Code", Consolas, monospace;
                            font-size: 13px;
                            white-space: pre-wrap;
                            word-break: break-word;
                            line-height: 1.6;
                            background: rgba(15, 23, 42, 0.04);
                            border: 1px solid rgba(148, 163, 184, 0.35);
                            border-radius: 8px;
                            padding: 16px;
                        }
                        .print-preview {
                            font-size: 14px;
                            line-height: 1.7;
                            color: #111827;
                        }
                        .print-preview h1,
                        .print-preview h2,
                        .print-preview h3,
                        .print-preview h4,
                        .print-preview h5 {
                            color: #1f2937;
                        }
                        .print-preview blockquote {
                            border-left: 3px solid rgba(59, 130, 246, 0.45);
                            padding-left: 14px;
                            color: #334155;
                            margin: 16px 0;
                        }
                        .print-preview table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 16px 0;
                        }
                        .print-preview th,
                        .print-preview td {
                            border: 1px solid rgba(148, 163, 184, 0.35);
                            padding: 8px 10px;
                            text-align: left;
                        }
                        @media print {
                            body { background: transparent; }
                            .print-container { padding: 24px 32px; }
                            .print-markdown { background: rgba(148, 163, 184, 0.12); }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-container">
                        ${metadataBlock}
                        ${bodyContent}
                    </div>
                    <script>
                        window.addEventListener('afterprint', () => {
                            window.close();
                        });
                        window.addEventListener('load', () => {
                            document.fonts && document.fonts.ready.then(() => {
                                setTimeout(() => window.print(), 60);
                            });
                            setTimeout(() => window.print(), 120);
                        });
                    <\/script>
                </body>
            </html>
        `;

        win.document.open();
        win.document.write(html);
        win.document.close();
    }

    function getMarginCss(margin) {
        switch (margin) {
            case 'none':
                return 'margin: 0;';
            case 'narrow':
                return 'margin: 0.5in;';
            case 'moderate':
                return 'margin: 0.75in;';
            case 'wide':
                return 'margin: 1in;';
            default:
                return '';
        }
    }

    function generateMetadataBlock() {
        const now = new Date();
        const title = currentFile || 'Markdown Document';
        const formatted = now.toLocaleString();
        return `
            <div class="print-metadata">
                <div><strong>${escapeHtml(title)}</strong></div>
                <div>Generated on ${escapeHtml(formatted)}</div>
            </div>
        `;
    }

    function showLinkImageDialog(type) {
        const dialog = document.getElementById('link-image-dialog');
        const overlay = document.getElementById('popup-overlay');
        const title = document.getElementById('dialog-title');
        const textLabel = document.getElementById('dialog-text-label');
        const urlInput = document.getElementById('dialog-url');
        const textInput = document.getElementById('dialog-text');
        const okBtn = document.getElementById('dialog-ok');
        const cancelBtn = document.getElementById('dialog-cancel');
        const titleCloseBtn = document.getElementById('dialog-title-close');

        title.textContent = type === 'link' ? 'Insert Link' : 'Insert Image';
        textLabel.textContent = type === 'link' ? 'Text' : 'Alt Text';
        urlInput.value = '';
        textInput.value = editor.value.substring(editor.selectionStart, editor.selectionEnd);
        
        // Show/hide auto-resize checkbox based on type
        const autoResizeContainer = document.getElementById('dialog-auto-resize-container');
        if (autoResizeContainer) {
            autoResizeContainer.style.display = type === 'image' ? 'block' : 'none';
        }
        
        // Restore auto-resize preference
        try {
            const pref = localStorage.getItem('md-auto-resize-images');
            if (pref !== null) {
                document.getElementById('dialog-auto-resize').checked = pref === '1';
            } else {
                // Default to ON when no preference is stored
                document.getElementById('dialog-auto-resize').checked = true;
            }
        } catch (e) { /* ignore */ }

        overlay.style.display = 'block';
        dialog.style.display = 'block';
        urlInput.focus();

        const handleOk = () => {
            const url = urlInput.value;
            const text = textInput.value;
            if (url) {
                // If inserting an image and auto-resize is enabled, insert an HTML <img> with a class
                if (type === 'image') {
                    const autoResize = document.getElementById('dialog-auto-resize') && document.getElementById('dialog-auto-resize').checked;
                    // Persist preference so dialog remembers next time
                    try { localStorage.setItem('md-auto-resize-images', autoResize ? '1' : '0'); } catch (e) {}

                    if (autoResize) {
                        // Load the image to measure its natural size, then insert sized HTML
                        const img = new Image();
                        img.onload = function() {
                            try {
                                const naturalW = img.naturalWidth || img.width || 0;
                                const naturalH = img.naturalHeight || img.height || 0;
                                const previewEl = document.getElementById('preview') || document.body;
                                const previewWidth = (previewEl.clientWidth && previewEl.clientWidth > 0) ? previewEl.clientWidth : 600;
                                // Reserve some padding so the image doesn't touch edges
                                const reserved = 40;
                                const maxAllowed = Math.max(200, previewWidth - reserved);
                                // Choose display width: don't upscale small images; cap very large images
                                const displayWidth = Math.min(naturalW || maxAllowed, maxAllowed, 1200);
                                // Build inline-styled HTML img so sizing is preserved in preview.
                                // Include width/height attributes and a basic srcset/sizes hint to improve responsive behaviour and reduce layout shift.
                                const naturalWidth = naturalW || 0;
                                const naturalHeight = naturalH || 0;
                                const calculatedHeight = (naturalWidth > 0) ? Math.round((naturalHeight * displayWidth) / naturalWidth) : '';
                                const srcset = `${url} ${naturalWidth}w`;
                                const sizes = `(max-width: ${displayWidth}px) ${displayWidth}px, 100vw`;
                                const heightAttr = calculatedHeight ? ` height="${calculatedHeight}"` : '';
                                const imgHtml = `<img src="${url}" srcset="${srcset}" sizes="${sizes}" alt="${(text||'').replace(/"/g,'&quot;')}" class="md-auto-resize" width="${displayWidth}"${heightAttr} loading="lazy" style="width:${displayWidth}px;max-width:100%;height:auto;">`;

                                // Insert the HTML directly at the current selection (replace selection)
                                const selStart = editor.selectionStart;
                                const selEnd = editor.selectionEnd;
                                editor.setRangeText(imgHtml, selStart, selEnd, 'end');
                                updatePreview();
                                updateStatusBar();
                            } catch (err) {
                                // Fallback to simple markdown if anything goes wrong
                                const markdown = `![${text || 'Image'}](${url})`;
                                insertMarkdown(markdown, '');
                            }
                            closeDialog();
                        };
                        img.onerror = function() {
                            // Couldn't load image - fallback to markdown insertion
                            const markdown = `![${text || 'Image'}](${url})`;
                            insertMarkdown(markdown, '');
                            closeDialog();
                        };
                        // Start loading
                        img.src = url;
                        // Do not call closeDialog here; we'll call it in onload/onerror after insertion
                        return; // exit early because we'll close asynchronously
                    } else {
                        const markdown = `![${text || 'Image'}](${url})`;
                        insertMarkdown(markdown, '');
                    }
                } else {
                    const markdown = `[${text || url}](${url})`;
                    insertMarkdown(markdown, '');
                }
            }
            closeDialog();
        };

        const handleCancel = () => {
            closeDialog();
        };

        const closeDialog = () => {
            overlay.style.display = 'none';
            dialog.style.display = 'none';
            okBtn.removeEventListener('click', handleOk);
            cancelBtn.removeEventListener('click', handleCancel);
            if (titleCloseBtn) titleCloseBtn.removeEventListener('click', handleCancel);
            editor.focus();
        };

        okBtn.addEventListener('click', handleOk);
        cancelBtn.addEventListener('click', handleCancel);
        if (titleCloseBtn) titleCloseBtn.addEventListener('click', handleCancel);
    }

    // Show image cap dialog
    function showImageCapDialog() {
        const dialog = document.getElementById('image-cap-dialog');
        const overlay = document.getElementById('popup-overlay');
        const input = document.getElementById('image-cap-input');
        const okBtn = document.getElementById('image-cap-ok');
        const cancelBtn = document.getElementById('image-cap-cancel');
        const closeBtn = document.getElementById('image-cap-close');

        // Get current value
        try {
            const computed = getComputedStyle(document.documentElement).getPropertyValue('--md-auto-resize-max') || '800px';
            const current = parseInt(computed.replace(/[^0-9]/g, ''), 10) || 800;
            input.value = current;
        } catch (err) {
            input.value = 800;
        }

        overlay.style.display = 'block';
        dialog.style.display = 'block';
        input.focus();
        input.select();

        const handleOk = () => {
            const value = parseInt(input.value, 10);
            if (!isNaN(value) && value >= 50 && value <= 3000) {
                try {
                    localStorage.setItem('md-auto-resize-max', String(value));
                    document.documentElement.style.setProperty('--md-auto-resize-max', value + 'px');
                    updateStatus('Image cap set to ' + value + 'px');
                } catch (err) {
                    customAlert('Unable to save image cap setting.');
                }
                closeDialog();
            } else {
                customAlert('Please enter a valid number between 50 and 3000.');
            }
        };

        const handleCancel = () => {
            closeDialog();
        };

        const closeDialog = () => {
            overlay.style.display = 'none';
            dialog.style.display = 'none';
            okBtn.removeEventListener('click', handleOk);
            cancelBtn.removeEventListener('click', handleCancel);
            closeBtn.removeEventListener('click', handleCancel);
            input.removeEventListener('keydown', handleKeydown);
            editor.focus();
        };

        const handleKeydown = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleOk();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                handleCancel();
            }
        };

        okBtn.addEventListener('click', handleOk);
        cancelBtn.addEventListener('click', handleCancel);
        closeBtn.addEventListener('click', handleCancel);
        input.addEventListener('keydown', handleKeydown);
    }

    // Show extensions dialog
    function showExtensionsDialog() {
        const dialog = document.getElementById('extensions-dialog');
        const overlay = document.getElementById('popup-overlay');
        const closeBtn = document.getElementById('extensions-close');

        overlay.style.display = 'block';
        dialog.style.display = 'block';

        // Category filtering
        const categories = dialog.querySelectorAll('.extension-category');
        const extensionCards = dialog.querySelectorAll('.extension-card');

        categories.forEach(category => {
            category.addEventListener('click', function() {
                const selectedCategory = this.getAttribute('data-category');
                
                // Update active category styling
                categories.forEach(cat => {
                    cat.style.background = '';
                    cat.style.color = '';
                });
                this.style.background = '#007acc';
                this.style.color = '#fff';
                
                // Filter extension cards
                extensionCards.forEach(card => {
                    const cardCategory = card.getAttribute('data-category');
                    if (selectedCategory === 'all' || cardCategory === selectedCategory) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });

        // Extended Markdown install/uninstall functionality
        const uninstallBtn = document.getElementById('ext-md-uninstall-btn');
        const installBtn = document.getElementById('ext-md-install-btn');
        const installedBadge = document.getElementById('ext-md-installed-badge');
        
        // Check if Extended Markdown is installed (check localStorage)
        const isExtMarkdownInstalled = localStorage.getItem('ext-extended-markdown') !== 'disabled';
        
        // Update UI based on installation status
        function updateExtMarkdownUI(installed) {
            if (installed) {
                uninstallBtn.style.display = 'block';
                installBtn.style.display = 'none';
                installedBadge.style.display = 'inline-block';
            } else {
                uninstallBtn.style.display = 'none';
                installBtn.style.display = 'block';
                installedBadge.style.display = 'none';
            }
        }
        
        updateExtMarkdownUI(isExtMarkdownInstalled);
        
        // Handle uninstall
        uninstallBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to uninstall Extended Markdown? This will disable advanced markdown features like task lists, definition lists, and footnotes.')) {
                localStorage.setItem('ext-extended-markdown', 'disabled');
                updateExtMarkdownUI(false);
                updateExtendedMarkdownButtons();
                customAlert('Extended Markdown has been uninstalled. Some advanced markdown features will no longer be available. The related toolbar buttons have been hidden.');
            }
        });
        
        // Handle install
        installBtn.addEventListener('click', function() {
            localStorage.removeItem('ext-extended-markdown');
            updateExtMarkdownUI(true);
            updateExtendedMarkdownButtons();
            customAlert('Extended Markdown has been installed! Advanced markdown features are now available. The related toolbar buttons have been shown.');
        });

        // GitHub Extended Markdown install/uninstall functionality
        const gfmUninstallBtn = document.getElementById('ext-gfm-uninstall-btn');
        const gfmInstallBtn = document.getElementById('ext-gfm-install-btn');
        const gfmInstalledBadge = document.getElementById('ext-gfm-installed-badge');
        
        // Check if GitHub Extended Markdown is installed (check localStorage)
        const isGfmInstalled = localStorage.getItem('ext-gfm') !== 'disabled';
        
        // Update UI based on installation status
        function updateGfmUI(installed) {
            if (installed) {
                gfmUninstallBtn.style.display = 'block';
                gfmInstallBtn.style.display = 'none';
                gfmInstalledBadge.style.display = 'inline-block';
            } else {
                gfmUninstallBtn.style.display = 'none';
                gfmInstallBtn.style.display = 'block';
                gfmInstalledBadge.style.display = 'none';
            }
        }
        
        updateGfmUI(isGfmInstalled);
        
        // Handle uninstall
        gfmUninstallBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to uninstall GitHub Extended Markdown? This will disable GitHub Flavored Markdown features like tables, strikethrough, and task lists.')) {
                localStorage.setItem('ext-gfm', 'disabled');
                updateGfmUI(false);
                customAlert('GitHub Extended Markdown has been uninstalled. GitHub Flavored Markdown features will no longer be available.');
            }
        });
        
        // Handle install
        gfmInstallBtn.addEventListener('click', function() {
            localStorage.removeItem('ext-gfm');
            updateGfmUI(true);
            customAlert('GitHub Extended Markdown has been installed! GitHub Flavored Markdown features are now available.');
        });

        // Syntax Highlighter install/uninstall functionality
        const syntaxUninstallBtn = document.getElementById('ext-syntax-uninstall-btn');
        const syntaxInstallBtn = document.getElementById('ext-syntax-install-btn');
        const syntaxInstalledBadge = document.getElementById('ext-syntax-installed-badge');
        
        // Check if Syntax Highlighter is installed (check localStorage)
        const isSyntaxHighlighterInstalled = localStorage.getItem('ext-syntax-highlighter') !== 'disabled';
        
        // Update UI based on installation status
        function updateSyntaxHighlighterUI(installed) {
            if (installed) {
                syntaxUninstallBtn.style.display = 'block';
                syntaxInstallBtn.style.display = 'none';
                syntaxInstalledBadge.style.display = 'inline-block';
            } else {
                syntaxUninstallBtn.style.display = 'none';
                syntaxInstallBtn.style.display = 'block';
                syntaxInstalledBadge.style.display = 'none';
            }
        }
        
        updateSyntaxHighlighterUI(isSyntaxHighlighterInstalled);
        
        // Handle uninstall
        syntaxUninstallBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to uninstall Syntax Highlighter? Code blocks will use basic monospace formatting without syntax highlighting.')) {
                localStorage.setItem('ext-syntax-highlighter', 'disabled');
                updateSyntaxHighlighterUI(false);
                customAlert('Syntax Highlighter has been uninstalled. Code blocks will display without syntax highlighting. Reload the page for changes to take effect.');
            }
        });
        
        // Handle install
        syntaxInstallBtn.addEventListener('click', function() {
            localStorage.removeItem('ext-syntax-highlighter');
            updateSyntaxHighlighterUI(true);
            customAlert('Syntax Highlighter has been installed! Your code blocks will now have beautiful syntax highlighting. Reload the page for changes to take effect.');
        });

        // Spell Checker install/uninstall functionality
        const spellUninstallBtn = document.getElementById('ext-spell-uninstall-btn');
        const spellInstallBtn = document.getElementById('ext-spell-install-btn');
        const spellInstalledBadge = document.getElementById('ext-spell-installed-badge');
        
        // Check if Spell Checker is installed (check localStorage)
        const isSpellCheckerInstalled = localStorage.getItem('ext-spell-checker') !== 'disabled';
        
        // Update UI based on installation status
        function updateSpellCheckerUI(installed) {
            if (installed) {
                spellUninstallBtn.style.display = 'block';
                spellInstallBtn.style.display = 'none';
                spellInstalledBadge.style.display = 'inline-block';
            } else {
                spellUninstallBtn.style.display = 'none';
                spellInstallBtn.style.display = 'block';
                spellInstalledBadge.style.display = 'none';
            }
        }
        
        updateSpellCheckerUI(isSpellCheckerInstalled);
        
        // Handle uninstall
        spellUninstallBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to uninstall Spell Checker? Real-time spell checking will be disabled.')) {
                localStorage.setItem('ext-spell-checker', 'disabled');
                updateSpellCheckerUI(false);
                customAlert('Spell Checker has been uninstalled. Spell checking is now disabled. Reload the page for changes to take effect.');
            }
        });
        
        // Handle install
        spellInstallBtn.addEventListener('click', function() {
            localStorage.removeItem('ext-spell-checker');
            updateSpellCheckerUI(true);
            customAlert('Spell Checker has been installed! Real-time spell checking is now enabled. Reload the page for changes to take effect.');
        });

        const handleClose = () => {
            overlay.style.display = 'none';
            dialog.style.display = 'none';
            closeBtn.removeEventListener('click', handleClose);
            uninstallBtn.removeEventListener('click', arguments.callee);
            installBtn.removeEventListener('click', arguments.callee);
            syntaxUninstallBtn.removeEventListener('click', arguments.callee);
            syntaxInstallBtn.removeEventListener('click', arguments.callee);
            spellUninstallBtn.removeEventListener('click', arguments.callee);
            spellInstallBtn.removeEventListener('click', arguments.callee);
        };

        closeBtn.addEventListener('click', handleClose);
        
        // Close on overlay click
        overlay.addEventListener('click', handleClose);
    }

    function insertTable() {
        const table = `\n| Header 1 | Header 2 | Header 3 |\n|----------|----------|----------|\n| Cell 1   | Cell 2   | Cell 3   |\n| Cell 4   | Cell 5   | Cell 6   |\n`;
        const start = editor.selectionStart;
        editor.value = editor.value.substring(0, start) + table + editor.value.substring(start);
        editor.selectionStart = editor.selectionEnd = start + table.length;
        editor.focus();
        updatePreview();
        updateStatusBar();
        pushImmediateUndoSnapshot();
    }

    // Insert a footnote reference and scaffold definition at end
    function insertFootnoteSnippet() {
        // Check if Extended Markdown is enabled
        if (localStorage.getItem('ext-extended-markdown') === 'disabled') {
            customAlert('Footnotes require the Extended Markdown extension. Please enable it in Extensions to use this feature.');
            return;
        }
        
        // Generate simple id
        const id = 'fn' + Math.floor(Math.random() * 10000).toString();
        const start = editor.selectionStart;
        const ref = `[^${id}]`;
        editor.setRangeText(ref, editor.selectionStart, editor.selectionEnd, 'end');

        // Append definition at end with a newline separator
        const tail = editor.value.endsWith('\n') ? '' : '\n';
        editor.value = editor.value + tail + `[^${id}]: Footnote text` + '\n';
        updatePreview();
        updateStatusBar();
    }

    // Insert a task list item (- [ ] ... or toggle to [x] if selection already is a task)
    function insertTaskItem() {
        // Check if Extended Markdown OR GitHub Flavored Markdown is enabled
        const isExtMarkdownDisabled = localStorage.getItem('ext-extended-markdown') === 'disabled';
        const isGfmDisabled = localStorage.getItem('ext-gfm') === 'disabled';
        
        if (isExtMarkdownDisabled && isGfmDisabled) {
            customAlert('Task lists require either the Extended Markdown or GitHub Extended Markdown extension. Please enable one in Settings → Extensions to use this feature.');
            return;
        }
        
        const start = editor.selectionStart;
        const lineStart = editor.value.lastIndexOf('\n', start - 1) + 1;
        const lineEnd = editor.value.indexOf('\n', start);
        const endIdx = lineEnd === -1 ? editor.value.length : lineEnd;
        const line = editor.value.substring(lineStart, endIdx);
        let newLine;
        const uncheckedRe = /^- \[ \] /;
        const checkedRe = /^- \[x\] /i;
        if (uncheckedRe.test(line)) {
            newLine = line.replace(uncheckedRe, '- [x] ');
        } else if (checkedRe.test(line)) {
            newLine = line.replace(checkedRe, '- [ ] ');
        } else {
            newLine = '- [ ] ' + line;
        }
        editor.value = editor.value.substring(0, lineStart) + newLine + editor.value.substring(endIdx);
        editor.selectionStart = editor.selectionEnd = Math.min(start + 6, editor.value.length);
        updatePreview();
        updateStatusBar();
        pushImmediateUndoSnapshot();
    }

    // Adjust table alignment separator line of the nearest table around cursor
    function setTableAlignment(mode) {
        const cursor = editor.selectionStart;
        const text = editor.value;
        // Find table region around cursor by searching for a header line and separator
        const before = text.lastIndexOf('\n|', cursor);
        if (before === -1) return;
        const after = text.indexOf('\n\n', before);
        const blockEnd = after === -1 ? text.length : after + 1;
        const block = text.substring(before + 1, blockEnd); // include first leading |
        const lines = block.split('\n');
        if (lines.length < 2) return;
        const sepIdx = 1; // second line is the separator per our table insertion
        const sep = lines[sepIdx];
        if (!/^\|/.test(sep)) return;
        const cells = sep.split('|');
        for (let i = 1; i < cells.length - 1; i++) {
            const raw = cells[i].trim().replace(/-/g, '-');
            if (mode === 'center') {
                cells[i] = ' :---: ';
            } else if (mode === 'right') {
                cells[i] = ' ---: ';
            } else {
                cells[i] = ' :--- ';
            }
        }
        lines[sepIdx] = cells.join('|');
        const newBlock = lines.join('\n');
        editor.value = text.substring(0, before + 1) + newBlock + text.substring(blockEnd);
        updatePreview();
        updateStatusBar();
        pushImmediateUndoSnapshot();
    }

    // Insert a simple definition list skeleton from current line
    function insertDefinitionList() {
        // Check if Extended Markdown is enabled
        if (localStorage.getItem('ext-extended-markdown') === 'disabled') {
            customAlert('Definition lists require the Extended Markdown extension. Please enable it in Extensions to use this feature.');
            return;
        }
        
        const start = editor.selectionStart;
        const snippet = `\nTerm\n: Definition\n`;
        editor.setRangeText(snippet, start, start, 'end');
        updatePreview();
        updateStatusBar();
        pushImmediateUndoSnapshot();
    }

    // Insert a horizontal rule line
    function insertHorizontalRule() {
        const start = editor.selectionStart;
        const ls = editor.value.lastIndexOf('\n', start - 1) + 1;
        const prefix = ls === start ? '' : '\n';
        const snippet = `${prefix}---\n`;
        editor.setRangeText(snippet, start, start, 'end');
        updatePreview();
        updateStatusBar();
    }

    // View mode management
    function setViewMode(mode) {
        currentViewMode = mode;
        const container = document.getElementById('main-container');
        // Remove all view classes
        container.classList.remove('editor-only', 'preview-only', 'single-pane');

        // Remove 'active' from all view toggle buttons
        document.querySelectorAll('.view-mode-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Always reset flex to 50/50 when switching to split view
        if (mode === 'split') {
            document.getElementById('editor-pane').style.flex = '1';
            document.getElementById('preview-pane').style.flex = '1';
            document.getElementById('split-btn').classList.add('active');
            updateStatus('View mode: Split');
        } else if (mode === 'editor') {
            document.getElementById('editor-pane').style.flex = '';
            document.getElementById('preview-pane').style.flex = '';
            container.classList.add('editor-only', 'single-pane');
            document.getElementById('editor-btn').classList.add('active');
            updateStatus('View mode: Editor Only');
        } else if (mode === 'preview') {
            document.getElementById('editor-pane').style.flex = '';
            document.getElementById('preview-pane').style.flex = '';
            container.classList.add('preview-only', 'single-pane');
            document.getElementById('preview-btn').classList.add('active');
            updateStatus('View mode: Preview Only');
        }
        
        // Save preference
        try {
            localStorage.setItem('md-view-mode', mode);
        } catch (e) {}
    }

    // Pane activation helpers
    function setActivePane(pane) {
        const editorContainer = document.getElementById('editor-pane');
        const previewContainer = document.getElementById('preview-pane');
        if (!editorContainer || !previewContainer) return;

        editorContainer.classList.toggle('is-active', pane === 'editor');
        previewContainer.classList.toggle('is-active', pane === 'preview');
    }

    function wirePaneActivation() {
        const editorEl = document.getElementById('editor');
        const previewEl = document.getElementById('preview');
        const previewPane = document.getElementById('preview-pane');
        if (!editorEl || !previewEl || !previewPane) return;

        setActivePane('editor');

        editorEl.addEventListener('focus', () => setActivePane('editor'));
        editorEl.addEventListener('click', () => setActivePane('editor'));

        previewEl.addEventListener('focus', () => {
            if (previewEl.isContentEditable) {
                setActivePane('preview');
            }
        });

        previewEl.addEventListener('click', () => {
            if (previewEl.isContentEditable) {
                setActivePane('preview');
            }
        });

        previewEl.addEventListener('blur', () => {
            if (!previewEl.isContentEditable) {
                setActivePane('editor');
            }
        });

        const observer = new MutationObserver(() => {
            if (!previewEl.isContentEditable) {
                setActivePane('editor');
            }
        });
        observer.observe(previewPane, { attributes: true, attributeFilter: ['class'] });
    }

    // Splitter functionality for resizing panes
    function setupSplitter() {
        const splitter = document.getElementById('splitter');
        const container = document.getElementById('main-container');
        const editorPane = document.getElementById('editor-pane');
        const previewPane = document.getElementById('preview-pane');
        if (!splitter || !container || !editorPane || !previewPane) return;

        let isResizing = false;

        const MIN_PERCENT = 15;
        const MAX_PERCENT = 85;

        function clampPercentage(value) {
            return Math.min(MAX_PERCENT, Math.max(MIN_PERCENT, value));
        }

        function applySplit(percentage) {
            const clamped = clampPercentage(percentage);
            editorPane.style.flex = `0 1 ${clamped}%`;
            previewPane.style.flex = `1 1 ${100 - clamped}%`;
        }

        function handlePointerDown(clientX) {
            const containerRect = container.getBoundingClientRect();
            const offset = clientX - splitter.getBoundingClientRect().left;
            isResizing = { containerRect, offset };
            document.body.classList.add('splitter-resizing');
        }

        function handlePointerMove(clientX) {
            if (!isResizing) return;
            const { containerRect, offset } = isResizing;
            const adjustedX = clientX - offset;
            const percentage = ((adjustedX - containerRect.left) / containerRect.width) * 100;
            applySplit(percentage);
        }

        function handlePointerUp() {
            if (!isResizing) return;
            isResizing = false;
            document.body.classList.remove('splitter-resizing');
        }

        splitter.addEventListener('mousedown', function(e) {
            e.preventDefault();
            handlePointerDown(e.clientX);
            document.addEventListener('mousemove', mouseMoveListener);
            document.addEventListener('mouseup', mouseUpListener);
        });

        splitter.addEventListener('touchstart', function(e) {
            if (e.touches.length !== 1) return;
            handlePointerDown(e.touches[0].clientX);
            document.addEventListener('touchmove', touchMoveListener, { passive: false });
            document.addEventListener('touchend', touchEndListener);
        }, { passive: true });

        function mouseMoveListener(e) {
            e.preventDefault();
            handlePointerMove(e.clientX);
        }

        function mouseUpListener(e) {
            e.preventDefault();
            document.removeEventListener('mousemove', mouseMoveListener);
            document.removeEventListener('mouseup', mouseUpListener);
            handlePointerUp();
        }

        function touchMoveListener(e) {
            if (e.touches.length !== 1) return;
            e.preventDefault();
            handlePointerMove(e.touches[0].clientX);
        }

        function touchEndListener(e) {
            document.removeEventListener('touchmove', touchMoveListener);
            document.removeEventListener('touchend', touchEndListener);
            handlePointerUp();
        }

        window.addEventListener('resize', function() {
            if (isResizing) handlePointerUp();
        });
    }

    // Utility functions
    function updateStatus(message) {
        document.getElementById('status-left').textContent = message;
        setTimeout(() => {
            document.getElementById('status-left').textContent = 'Ready';
        }, 3000);
    }

    // Word-wrap helpers
    function setWordWrap(enabled) {
        if (!editor) return;
        try {
            if (enabled) {
                editor.classList.add('wrap');
                editor.setAttribute('wrap', 'soft');
            } else {
                editor.classList.remove('wrap');
                editor.setAttribute('wrap', 'off');
            }
        } catch (e) {
            // Ignore attribute errors in some environments
        }
        try { localStorage.setItem('md-word-wrap', enabled ? '1' : '0'); } catch (e) {}
        const btn = document.getElementById('btn-wordwrap');
        if (btn) {
            if (enabled) btn.classList.add('active'); else btn.classList.remove('active');
        }
    }

    function toggleWordWrap() {
        const enabled = editor && editor.classList.contains('wrap');
        setWordWrap(!enabled);
        updateStatus('Word wrap ' + (!enabled ? 'enabled' : 'disabled'));
    }

    // Custom alert function
    function customAlert(message, callback) {
        const alertBox = document.getElementById('custom-alert');
        const overlay = document.getElementById('popup-overlay');
        const msgEl = document.getElementById('custom-alert-message');
        const okBtn = document.getElementById('custom-alert-ok');

        msgEl.textContent = message;
        overlay.style.display = 'block';
        alertBox.style.display = 'block';

        const closeAlert = () => {
            alertBox.style.display = 'none';
            overlay.style.display = 'none';
            okBtn.removeEventListener('click', closeAlert);
            if (callback) callback();
        };
        okBtn.addEventListener('click', closeAlert);
    }

    // Menu functions (placeholder implementations)
    function showAbout() {
        // Render local changelogs as HTML for modern styling
        const el = document.getElementById('changelog-content');
        if (el) el.innerHTML = LOCAL_CHANGELOG_MD;
        document.getElementById('changelog-popup').style.display = 'block';
        document.getElementById('popup-overlay').style.display = 'block';
    }

    function showHelp() {
      document.getElementById('help-popup').style.display = 'block';
      document.getElementById('popup-overlay').style.display = 'block';
    }
    // Hide help popup
    document.addEventListener('DOMContentLoaded', function() {
      var closeBtn = document.getElementById('help-popup-close');
      if (closeBtn) closeBtn.onclick = function() {
        document.getElementById('help-popup').style.display = 'none';
        document.getElementById('popup-overlay').style.display = 'none';
      };
      
      // Hide changelog popup
      var changelogCloseBtn = document.getElementById('changelog-popup-close');
      if (changelogCloseBtn) changelogCloseBtn.onclick = function() {
        document.getElementById('changelog-popup').style.display = 'none';
        document.getElementById('popup-overlay').style.display = 'none';
      };
      
      // Also close when clicking overlay
      var overlay = document.getElementById('popup-overlay');
      if (overlay) overlay.addEventListener('click', function() {
        document.getElementById('help-popup').style.display = 'none';
        document.getElementById('changelog-popup').style.display = 'none';
        overlay.style.display = 'none';
      });
    });

    // Handle image info badge clicks
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('md-img-info-badge')) {
            // Hide any other open popups
            document.querySelectorAll('.md-img-info-popup').forEach(popup => {
                if (popup !== e.target.nextElementSibling) {
                    popup.style.display = 'none';
                }
            });
            
            // Toggle this popup
            const popup = e.target.nextElementSibling;
            popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
        } else if (!e.target.closest('.md-img-info-popup')) {
            // Click outside popup - hide all popups
            document.querySelectorAll('.md-img-info-popup').forEach(popup => {
                popup.style.display = 'none';
            });
        }
    });

    // Context Menu functionality
    const contextMenu = document.getElementById('context-menu');
    const contextMenuExtended = document.getElementById('context-menu-extended');
    let contextMenuTarget = null;
    let contextMenuX = 0;
    let contextMenuY = 0;

    // Prevent default context menu and show custom one
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        contextMenuTarget = e.target;
        
        // Store original right-click position
        contextMenuX = e.pageX;
        contextMenuY = e.pageY;
        
        // Hide extended menu if it's open
        contextMenuExtended.style.display = 'none';
        
        // Check if right-click was on a table cell in preview
        const cell = e.target.closest('td,th');
        const isInPreview = preview.contains(e.target);
        selectedTableCell = isInPreview && cell ? cell : null;
        
        // Show/hide table operation menu items
        const tableOps = document.querySelectorAll('.table-operations');
        tableOps.forEach(op => op.style.display = selectedTableCell ? 'flex' : 'none');
        
        // Position and show main context menu
        contextMenu.style.left = contextMenuX + 'px';
        contextMenu.style.top = contextMenuY + 'px';
        contextMenu.style.display = 'block';
        
        // Adjust if menu goes off-screen
        const rect = contextMenu.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
            contextMenu.style.left = (contextMenuX - rect.width) + 'px';
        }
        if (rect.bottom > window.innerHeight) {
            contextMenu.style.top = (contextMenuY - rect.height) + 'px';
        }
    });

    // Hide context menus when clicking outside
    document.addEventListener('click', function(e) {
        if (!contextMenu.contains(e.target) && !contextMenuExtended.contains(e.target)) {
            contextMenu.style.display = 'none';
            contextMenuExtended.style.display = 'none';
        }
    });

    // Hide context menus on scroll
    window.addEventListener('scroll', function() {
        contextMenu.style.display = 'none';
        contextMenuExtended.style.display = 'none';
    }, true);

    // Context menu item click handlers
    contextMenu.addEventListener('click', function(e) {
        const item = e.target.closest('.context-menu-item');
        if (!item) return;
        
        const action = item.getAttribute('data-action');
        handleContextMenuAction(action);
    });

    contextMenuExtended.addEventListener('click', function(e) {
        const item = e.target.closest('.context-menu-item');
        if (!item) return;
        
        const action = item.getAttribute('data-action');
        if (action === 'backToEditor') {
            // Return to main menu at original position
            contextMenuExtended.style.display = 'none';
            contextMenu.style.left = contextMenuX + 'px';
            contextMenu.style.top = contextMenuY + 'px';
            contextMenu.style.display = 'block';
            
            // Adjust if menu goes off-screen
            const rect = contextMenu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                contextMenu.style.left = (contextMenuX - rect.width) + 'px';
            }
            if (rect.bottom > window.innerHeight) {
                contextMenu.style.top = (contextMenuY - rect.height) + 'px';
            }
        } else {
            handleContextMenuAction(action);
        }
    });

    function handleContextMenuAction(action) {
        const isInEditor = contextMenuTarget === editor || editor.contains(contextMenuTarget);
        const isInPreview = contextMenuTarget === preview || preview.contains(contextMenuTarget);
        
        switch(action) {
            case 'cut':
                document.execCommand('cut');
                break;
            case 'copy':
                document.execCommand('copy');
                break;
            case 'paste':
                if (isInEditor) {
                    navigator.clipboard.readText().then(text => {
                        const start = editor.selectionStart;
                        const end = editor.selectionEnd;
                        const value = editor.value;
                        editor.value = value.substring(0, start) + text + value.substring(end);
                        editor.selectionStart = editor.selectionEnd = start + text.length;
                        updatePreview();
                        updateStatusBar();
                    }).catch(err => {
                        console.log('Paste failed:', err);
                    });
                } else {
                    document.execCommand('paste');
                }
                break;
            case 'selectAll':
                if (isInEditor) {
                    editor.select();
                } else if (isInPreview) {
                    const range = document.createRange();
                    range.selectNodeContents(preview);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
                break;
            case 'undo':
                if (isInEditor) {
                    undo();
                }
                break;
            case 'redo':
                if (isInEditor) {
                    redo();
                }
                break;
            case 'find':
                toggleFindReplace();
                break;
            case 'replace':
                toggleFindReplace();
                document.getElementById('replace-input').focus();
                break;
            case 'showMore':
                // Show extended menu at original right-click position
                contextMenu.style.display = 'none';
                contextMenuExtended.style.left = contextMenuX + 'px';
                contextMenuExtended.style.top = contextMenuY + 'px';
                contextMenuExtended.style.display = 'block';
                
                // Adjust if menu goes off-screen
                const extRect = contextMenuExtended.getBoundingClientRect();
                if (extRect.right > window.innerWidth) {
                    contextMenuExtended.style.left = (contextMenuX - extRect.width) + 'px';
                }
                if (extRect.bottom > window.innerHeight) {
                    contextMenuExtended.style.top = (contextMenuY - extRect.height) + 'px';
                }
                return; // Don't hide menus yet
            case 'bold':
                if (isInEditor) insertMarkdown('**', '**');
                break;
            case 'italic':
                if (isInEditor) insertMarkdown('*', '*');
                break;
            case 'code':
                if (isInEditor) insertMarkdown('`', '`');
                break;
            case 'link':
                showLinkDialog();
                break;
            case 'image':
                showImageDialog();
                break;
            case 'back':
                window.history.back();
                break;
            case 'forward':
                window.history.forward();
                break;
            case 'reload':
                location.reload();
                break;
            case 'saveAs':
                // Trigger Save As functionality (explicit save-as flow)
                saveAsFile();
                break;
            case 'print':
                openPrintDialog();
                break;
            case 'viewSource':
                // Open page source in new tab
                const sourceWindow = window.open('', '_blank');
                sourceWindow.document.write('<pre>' + document.documentElement.outerHTML.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre>');
                sourceWindow.document.close();
                break;
            case 'inspect':
                // Try to open devtools (only works in some contexts)
                updateStatus('Press F12 to open Developer Tools');
                break;
            // Table operations
            case 'addCell':
                if (selectedTableCell) addTableCell();
                break;
            case 'removeCell':
                if (selectedTableCell) removeTableCell();
                break;
            case 'addRow':
                if (selectedTableCell) addTableRow();
                break;
            case 'removeRow':
                if (selectedTableCell) removeTableRow();
                break;
            case 'addColumn':
                if (selectedTableCell) addTableColumn();
                break;
            case 'removeColumn':
                if (selectedTableCell) removeTableColumn();
                break;
            case 'toggleHeader':
                if (selectedTableCell) toggleTableHeader();
                break;
        }
        
        // Hide menus after action
        contextMenu.style.display = 'none';
        contextMenuExtended.style.display = 'none';
    }

    // Table functions from v2.2.1
    function handleTableAction(action) {
        switch(action) {
            case 'insert-3x3':
                insertTable(3, 3);
                break;
            case 'insert-4x4':
                insertTable(4, 4);
                break;
            case 'insert-5x5':
                insertTable(5, 5);
                break;
            case 'insert-custom':
                showCustomTableDialog();
                break;
            case 'align-left':
                setTableAlignment('left');
                break;
            case 'align-center':
                setTableAlignment('center');
                break;
            case 'align-right':
                setTableAlignment('right');
                break;
            case 'add-row':
                addTableRow();
                break;
            case 'add-column':
                addTableColumn();
                break;
            case 'delete-row':
                deleteTableRow();
                break;
            case 'delete-column':
                deleteTableColumn();
                break;
            case 'toggle-borders':
                toggleTableBorders();
                break;
            case 'header-style':
                applyHeaderStyle();
                break;
            case 'striped-rows':
                applyStripedRows();
                break;
            default:
                console.log('Table action not implemented:', action);
        }
    }

    function insertTable(rows = 3, cols = 3) {
        let table = '\n';
        
        // Create header row
        const headers = Array(cols).fill().map((_, i) => `Header ${i + 1}`);
        table += '| ' + headers.join(' | ') + ' |\n';
        
        // Create separator row
        const separators = Array(cols).fill(':---');
        table += '| ' + separators.join(' | ') + ' |\n';
        
        // Create data rows
        for (let i = 0; i < rows; i++) {
            const cells = Array(cols).fill().map((_, j) => `Cell ${i + 1}-${j + 1}`);
            table += '| ' + cells.join(' | ') + ' |\n';
        }
        
        const start = editor.selectionStart;
        editor.value = editor.value.substring(0, start) + table + editor.value.substring(start);
        editor.selectionStart = editor.selectionEnd = start + table.length;
        editor.focus();
        updatePreview();
        updateStatusBar();
    }

    function showCustomTableDialog() {
        const rows = prompt('Number of rows:', '3');
        const cols = prompt('Number of columns:', '3');
        
        if (rows && cols && !isNaN(rows) && !isNaN(cols)) {
            const numRows = Math.max(1, Math.min(20, parseInt(rows)));
            const numCols = Math.max(1, Math.min(10, parseInt(cols)));
            insertTable(numRows, numCols);
        }
    }

    function addTableRow() {
        const cursor = editor.selectionStart;
        const text = editor.value;
        const tableInfo = findTableAtCursor(cursor, text);
        
        if (!tableInfo) {
            customAlert('Please position your cursor within a table to add a row.');
            return;
        }
        
        const { start, end, lines } = tableInfo;
        const colCount = (lines[0].match(/\|/g) || []).length - 1;
        const newRow = '| ' + Array(colCount).fill('New Cell').join(' | ') + ' |\n';
        
        // Insert before the last line (before the closing of table)
        const insertPos = end - 1;
        editor.value = text.substring(0, insertPos) + newRow + text.substring(insertPos);
        updatePreview();
        updateStatusBar();
    }

    function addTableColumn() {
        const cursor = editor.selectionStart;
        const text = editor.value;
        const tableInfo = findTableAtCursor(cursor, text);
        
        if (!tableInfo) {
            customAlert('Please position your cursor within a table to add a column.');
            return;
        }
        
        const { start, end, lines } = tableInfo;
        const newLines = lines.map((line, index) => {
            if (index === 0) {
                // Header row
                return line.replace(/\|$/, '| New Header |');
            } else if (index === 1) {
                // Separator row
                return line.replace(/\|$/, '| :--- |');
            } else {
                // Data row
                return line.replace(/\|$/, '| New Cell |');
            }
        });
        
        const newTable = newLines.join('\n');
        editor.value = text.substring(0, start) + newTable + text.substring(end);
        updatePreview();
        updateStatusBar();
    }

    function deleteTableRow() {
        const cursor = editor.selectionStart;
        const text = editor.value;
        const tableInfo = findTableAtCursor(cursor, text);
        
        if (!tableInfo) {
            customAlert('Please position your cursor within a table to delete a row.');
            return;
        }
        
        const { start, end, lines } = tableInfo;
        if (lines.length <= 3) {
            customAlert('Cannot delete row. Table must have at least one data row.');
            return;
        }
        
        // Find which row the cursor is in
        let cursorLine = 0;
        let currentPos = start;
        for (let i = 0; i < lines.length; i++) {
            currentPos += lines[i].length + 1; // +1 for newline
            if (cursor < currentPos) {
                cursorLine = i;
                break;
            }
        }
        
        // Don't delete header or separator rows
        if (cursorLine < 2) {
            customAlert('Cannot delete header or separator rows.');
            return;
        }
        
        lines.splice(cursorLine, 1);
        const newTable = lines.join('\n');
        editor.value = text.substring(0, start) + newTable + text.substring(end);
        updatePreview();
        updateStatusBar();
    }

    function deleteTableColumn() {
        const cursor = editor.selectionStart;
        const text = editor.value;
        const tableInfo = findTableAtCursor(cursor, text);
        
        if (!tableInfo) {
            customAlert('Please position your cursor within a table to delete a column.');
            return;
        }
        
        const { start, end, lines } = tableInfo;
        const colCount = (lines[0].match(/\|/g) || []).length - 1;
        
        if (colCount <= 1) {
            customAlert('Cannot delete column. Table must have at least one column.');
            return;
        }
        
        // Find which column the cursor is in
        const cursorLine = lines.findIndex((line, i) => {
            let currentPos = start;
            for (let j = 0; j < i; j++) {
                currentPos += lines[j].length + 1;
            }
            return cursor >= currentPos && cursor < currentPos + line.length;
        });
        
        if (cursorLine === -1) return;
        
        const line = lines[cursorLine];
        const cells = line.split('|');
        const cellIndex = Math.floor((cursor - (start + line.substring(0, cursor).length)) / (line.length / cells.length));
        
        if (cellIndex < 1 || cellIndex >= cells.length - 1) return;
        
        // Remove the column from all rows
        const newLines = lines.map(line => {
            const cells = line.split('|');
            cells.splice(cellIndex, 1);
            return cells.join('|');
        });
        
        const newTable = newLines.join('\n');
        editor.value = text.substring(0, start) + newTable + text.substring(end);
        updatePreview();
        updateStatusBar();
    }

    function findTableAtCursor(cursor, text) {
        // Find table boundaries around cursor
        const before = text.lastIndexOf('\n|', cursor);
        if (before === -1) return null;
        
        const after = text.indexOf('\n\n', before);
        const end = after === -1 ? text.length : after + 1;
        
        const tableText = text.substring(before + 1, end);
        const lines = tableText.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) return null;
        
        return {
            start: before + 1,
            end: end,
            lines: lines
        };
    }

    function toggleTableBorders() {
        customAlert('Table border toggling will be implemented in a future update.');
    }

    function applyHeaderStyle() {
        customAlert('Header styling will be implemented in a future update.');
    }

    function applyStripedRows() {
        customAlert('Striped rows will be implemented in a future update.');
    }

    // Save As and Print functions from v2.2.1
    async function saveAsFile() {
        const content = editor.value;

        // Prefer the File System Access API if available
        if (window.showSaveFilePicker) {
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: currentFile || 'untitled.md',
                    types: [{
                        description: 'Markdown or Text Files',
                        accept: { 'text/markdown': ['.md', '.markdown'], 'text/plain': ['.txt', '.text'] }
                    }]
                });
                const writable = await handle.createWritable();
                await writable.write(content);
                await writable.close();
                // Keep the handle so subsequent Save will overwrite this file
                currentFileHandle = handle;
                currentFile = handle.name || currentFile;
                updateStatus(`File saved as: ${currentFile}`);
                return;
            } catch (err) {
                console.warn('showSaveFilePicker cancelled or failed, falling back to download', err);
                // fall through to download fallback
            }
        }

        // Fallback: create a download link (Save As)
        const blob = new Blob([content], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        // use currentFile string if present, otherwise default
        a.download = currentFile ? `copy_of_${String(currentFile).replace(/^copy_of_/, '')}` : 'untitled.md';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        updateStatus('File saved as');
    }

    // printFile() removed temporarily to mitigate printing issues.
    // If you need to re-enable printing later, restore this function from version control.

    // Missing functions for v2.2.2 settings
    function toggleLineNumbers(show) {
        // This function would need to be implemented based on the line numbers feature
        // For now, we'll just store the preference
        console.log('Line numbers:', show ? 'enabled' : 'disabled');
    }

    // Missing preview editing functions
    function handlePreviewEdit(e) {
        // Handle preview editing input
        console.log('Preview editing input:', e);
    }

    function handlePreviewPaste(e) {
        // Handle preview editing paste
        console.log('Preview editing paste:', e);
    }

    function handlePreviewKeydown(e) {
        // Handle preview editing keyboard events
        console.log('Preview editing keydown:', e);
    }

    // Settings functions from v2.2.2
    function loadSettings() {
        try {
            const savedSettings = localStorage.getItem('markdown-editor-settings');
            if (savedSettings) {
                const parsedSettings = JSON.parse(savedSettings);
                settings = { ...settings, ...parsedSettings };
            }
        } catch (e) {
            console.warn('Failed to load settings:', e);
        }
        applySettings();
    }

    // Save settings to localStorage
    function saveSettings() {
        try {
            localStorage.setItem('markdown-editor-settings', JSON.stringify(settings));
        } catch (e) {
            console.warn('Failed to save settings:', e);
        }
    }

    // Apply settings
    function applySettings() {
        // Apply theme
        if (settings.defaultTheme === 'dark') {
            document.body.classList.add('dark-mode');
        } else if (settings.defaultTheme === 'light') {
            document.body.classList.remove('dark-mode');
        } else if (settings.defaultTheme === 'auto') {
            // Auto theme based on system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        // Apply font size
        editor.style.fontSize = settings.fontSize + 'px';
        document.getElementById('preview').style.fontSize = settings.fontSize + 'px';

        // Apply word wrap
        editor.style.whiteSpace = settings.wordWrap ? 'pre-wrap' : 'pre';
        
        // Apply preview word wrap
        const preview = document.getElementById('preview');
        if (preview) {
            preview.style.whiteSpace = settings.previewWordWrap ? 'pre-wrap' : 'pre';
        }
        
        // Update word wrap button state
        const wordWrapBtn = document.getElementById('btn-wordwrap');
        if (wordWrapBtn) {
            wordWrapBtn.classList.toggle('active', settings.wordWrap);
        }

        // Apply preview editing
        togglePreviewEditing(settings.previewEditing);

        // Apply auto-save
            if (window.autoSaveInterval) {
                clearInterval(window.autoSaveInterval);
                window.autoSaveInterval = null;
            }
            if (settings.autoSave) {
                // Auto-save every 30 seconds. If we have a writable file handle, save to disk;
                // otherwise fall back to localStorage.
                window.autoSaveInterval = setInterval(async () => {
                    try {
                        if (!editor) return;
                        const data = editor.value;
                        if (!data.trim()) return;
                        if (currentFileHandle && currentFileHandle.createWritable) {
                            // Attempt to write to disk silently; on failure show an error dialog
                            try {
                                const writable = await currentFileHandle.createWritable();
                                await writable.write(data);
                                await writable.close();
                                updateStatus('Auto-saved to disk');
                            } catch (err) {
                                console.warn('Auto-save to disk failed', err);
                                // Show non-blocking error dialog offering actions
                                showSaveError(err, /*context*/ 'autosave');
                            }
                        } else {
                            try {
                                localStorage.setItem('markdown-editor-autosave', data);
                                updateStatus('Auto-saved to localStorage');
                            } catch (e) {
                                console.warn('Auto-save to localStorage failed', e);
                            }
                        }
                    } catch (e) {
                        console.warn('Auto-save loop error', e);
                    }
                }, 30000);
            }
        
        // Apply developer mode (show/hide developer menu)
        const developerMenu = document.getElementById('menu-developer');
        if (developerMenu) {
            developerMenu.style.display = settings.developerMode ? 'block' : 'none';
        }
    }

    // Toggle preview editing functionality
    function togglePreviewEditing(enabled) {
        const previewPane = document.getElementById('preview');
        const paneHeader = document.querySelector('.preview-pane .pane-header');
        
        if (enabled) {
            // Enable preview editing
            previewPane.setAttribute('contenteditable', 'true');
            paneHeader.textContent = 'Preview (Editable)';
            previewPane.style.cursor = 'text';
            previewPane.classList.add('editable-preview');
            
            // Add event listeners for preview editing
            addPreviewEditingListeners();
        } else {
            // Disable preview editing
            previewPane.removeAttribute('contenteditable');
            paneHeader.textContent = 'Preview';
            previewPane.style.cursor = 'default';
            previewPane.classList.remove('editable-preview');
            
            // Remove event listeners for preview editing
            removePreviewEditingListeners();
        }
    }

    // Add preview editing event listeners
    function addPreviewEditingListeners() {
        const preview = document.getElementById('preview');
        preview.addEventListener('input', handlePreviewEdit);
        preview.addEventListener('paste', handlePreviewPaste);
        preview.addEventListener('keydown', handlePreviewKeydown);
    }

    // Remove preview editing event listeners
    function removePreviewEditingListeners() {
        const preview = document.getElementById('preview');
        preview.removeEventListener('input', handlePreviewEdit);
        preview.removeEventListener('paste', handlePreviewPaste);
        preview.removeEventListener('keydown', handlePreviewKeydown);
    }

    function showSettings() {
        const dialog = document.getElementById('settings-dialog');
        const overlay = document.getElementById('popup-overlay');
        
        // Load current settings into the dialog
        document.getElementById('auto-save').checked = settings.autoSave;
        document.getElementById('word-wrap').checked = settings.wordWrap;
        document.getElementById('live-preview').checked = settings.livePreview;
        document.getElementById('preview-editing').checked = settings.previewEditing;
        document.getElementById('preview-word-wrap').checked = settings.previewWordWrap || false;
        document.getElementById('save-location').value = settings.saveLocation;
        
        // Update theme buttons
        const themeButtons = document.querySelectorAll('.theme-btn');
        themeButtons.forEach(btn => {
            if (btn.dataset.theme === settings.defaultTheme) {
                btn.style.background = '#1a73e8';
                btn.style.color = '#fff';
            } else {
                btn.style.background = '#fff';
                btn.style.color = '#3c4043';
            }
        });
        
        // Update font size display
        document.getElementById('font-size-display').textContent = settings.fontSize + 'px';
        
        // Apply toggle switch styling to extension permission toggles
        const extToggles = [
            'ext-file-access', 'ext-network-access', 'ext-clipboard-access', 'ext-theme-access'
        ];
        
        extToggles.forEach(toggleId => {
            const checkbox = document.getElementById(toggleId);
            if (checkbox) {
                const toggle = checkbox.nextElementSibling;
                const thumb = toggle.nextElementSibling;
                
                function updateToggle() {
                    if (checkbox.checked) {
                        toggle.style.backgroundColor = '#1a73e8';
                        thumb.style.transform = 'translateX(20px)';
                    } else {
                        toggle.style.backgroundColor = '#ccc';
                        thumb.style.transform = 'translateX(0)';
                    }
                }
                
                updateToggle();
                checkbox.addEventListener('change', updateToggle);
                
                // Add click handler to the toggle
                toggle.addEventListener('click', function() {
                    checkbox.checked = !checkbox.checked;
                    updateToggle();
                    checkbox.dispatchEvent(new Event('change'));
                });
            }
        });
        
        // Load developer mode setting
        document.getElementById('developer-mode').checked = settings.developerMode;
        
        // Apply toggle switch styling to general settings toggles
        const toggleIds = ['auto-save', 'word-wrap', 'live-preview', 'preview-editing', 'preview-word-wrap', 'developer-mode'];
        toggleIds.forEach(id => {
            const checkbox = document.getElementById(id);
            const toggle = checkbox.nextElementSibling;
            const thumb = toggle.nextElementSibling;
            
            if (checkbox.checked) {
                toggle.style.backgroundColor = '#1a73e8';
                thumb.style.transform = 'translateX(20px)';
            } else {
                toggle.style.backgroundColor = '#ccc';
                thumb.style.transform = 'translateX(0)';
            }
        });
        
        // Update current mode display (Beta Feature)
        updateCurrentModeDisplay();
        
        // Reset to first section
        switchSettingsSection('general');
        
        dialog.style.display = 'block';
    }

    // Close settings dialog
    function closeSettings() {
        document.getElementById('settings-dialog').style.display = 'none';
        document.getElementById('popup-overlay').style.display = 'none';
    }

    // Export settings
    function exportSettings() {
        const dataStr = JSON.stringify(settings, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'markdown-editor-settings.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        customAlert('Settings exported successfully!');
    }

    // Import settings
    function importSettings() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importedSettings = JSON.parse(event.target.result);
                        settings = { ...settings, ...importedSettings };
                        saveSettings();
                        applySettings();
                        customAlert('Settings imported successfully!');
                    } catch (error) {
                        customAlert('Failed to import settings. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            }
        };
        input.click();
    }

    // Reset settings to defaults
    function resetSettings() {
        if (confirm('Are you sure you want to reset ALL settings to default values? This will clear all preferences, extensions, themes, and custom configurations. The page will reload.')) {
            try {
                // Clear all markdown editor related localStorage items
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (
                        key.startsWith('markdown-') ||
                        key.startsWith('md-') ||
                        key.startsWith('ext-') ||
                        key.startsWith('lancer-') ||
                        key.startsWith('find-')
                    )) {
                        keysToRemove.push(key);
                    }
                }
                
                // Remove all identified keys
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                // Reset settings object to defaults
                settings = {
                    autoSave: false,
                    wordWrap: false,
                    livePreview: true,
                    previewEditing: true,
                    defaultTheme: 'auto',
                    fontSize: 14,
                    compactMode: false,
                    saveLocation: 'default'
                };
                
                // Save default settings
                localStorage.setItem('markdown-editor-settings', JSON.stringify(settings));
                
                // Show success message and reload
                alert('All settings have been reset to defaults. The page will now reload.');
                location.reload();
            } catch (e) {
                customAlert('Error resetting settings: ' + e.message);
            }
        }
    }

    // Table cell operations for context menu
    let selectedTableCell = null;
    
    // Helper function to sync table changes back to editor
    function syncTableChangesToEditor() {
        try {
            const md = htmlToMarkdown(document.getElementById('preview').innerHTML);
            editor.value = md;
            updatePreview();
            updateStatusBar && updateStatusBar();
        } catch(err) {
            console.error('Table sync failed:', err);
        }
    }

    // Table cell operations
    function addTableCell() {
        if (!selectedTableCell) return;
        const tag = selectedTableCell.tagName.toLowerCase();
        const newCell = document.createElement(tag);
        newCell.innerHTML = '&nbsp;';
        selectedTableCell.parentNode.insertBefore(newCell, selectedTableCell.nextSibling);
        syncTableChangesToEditor();
    }

    function removeTableCell() {
        if (!selectedTableCell) return;
        const row = selectedTableCell.parentNode;
        if (row.cells && row.cells.length > 1) {
            row.removeChild(selectedTableCell);
        } else {
            row.parentNode.removeChild(row);
        }
        syncTableChangesToEditor();
    }

    function addTableRow() {
        if (!selectedTableCell) return;
        const currentRow = selectedTableCell.parentNode;
        const newRow = document.createElement('tr');
        Array.from(currentRow.cells).forEach(() => {
            const newCell = document.createElement('td');
            newCell.innerHTML = '&nbsp;';
            newRow.appendChild(newCell);
        });
        currentRow.parentNode.insertBefore(newRow, currentRow.nextSibling);
        syncTableChangesToEditor();
    }

    function removeTableRow() {
        if (!selectedTableCell) return;
        const row = selectedTableCell.parentNode;
        if (row.parentNode.rows.length > 2) { // Keep at least header + one data row
            row.parentNode.removeChild(row);
            syncTableChangesToEditor();
        }
    }

    function addTableColumn() {
        if (!selectedTableCell) return;
        const table = selectedTableCell.closest('table');
        const cellIndex = Array.from(selectedTableCell.parentNode.cells).indexOf(selectedTableCell);
        Array.from(table.rows).forEach(row => {
            const newCell = document.createElement(row.cells[0].tagName);
            newCell.innerHTML = '&nbsp;';
            row.insertBefore(newCell, row.cells[cellIndex + 1]);
        });
        syncTableChangesToEditor();
    }

    function removeTableColumn() {
        if (!selectedTableCell) return;
        const table = selectedTableCell.closest('table');
        const cellIndex = Array.from(selectedTableCell.parentNode.cells).indexOf(selectedTableCell);
        if (table.rows[0].cells.length > 2) { // Keep at least 2 columns
            Array.from(table.rows).forEach(row => {
                row.deleteCell(cellIndex);
            });
            syncTableChangesToEditor();
        }
    }

    function toggleTableHeader() {
        if (!selectedTableCell) return;
        const newTag = selectedTableCell.tagName.toLowerCase() === 'td' ? 'th' : 'td';
        const newCell = document.createElement(newTag);
        newCell.innerHTML = selectedTableCell.innerHTML;
        selectedTableCell.parentNode.replaceChild(newCell, selectedTableCell);
        syncTableChangesToEditor();
    }

    // Initialize the editor when page loads
    window.addEventListener('load', initEditor);
</script>

<!-- Prism.js for syntax highlighting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-csharp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-php.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-ruby.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-go.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-rust.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-swift.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-kotlin.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markdown.min.js"></script>
</body>
</html>